<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https: 'unsafe-inline'; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https:; object-src 'none'; base-uri 'self';">
    <title>Langkah 7: Generator Modul Ajar (RPP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js"></script>
    <script src="config.js"></script>
    <script src="sidebar.js"></script>
    <style>
        .page-break { page-break-after: always; border-bottom: 2px dashed #ccc; margin: 40px 0; display: block; }
        .rpp-content h3 { font-size: 13pt; font-weight: bold; margin-top: 20px; color: #1e3a8a; border-bottom: 2px solid #e2e8f0; }
        .rpp-content p { margin-bottom: 10px; text-align: justify; line-height: 1.6; } 
        .diferensiasi-box { background: #f0fdf4; border-left: 4px solid #22c55e; padding: 10px; font-style: italic; margin-top: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen flex font-sans overflow-hidden">
    
    <div id="sidebar-container" class="flex-none h-full"></div>

    <div class="flex-1 flex flex-col relative">
        <header class="bg-white border-b px-6 py-4 shadow-sm flex gap-4 items-center justify-between z-10">
            <div class="flex items-center gap-4 flex-1">
                <h1 class="text-xl font-bold text-slate-900">7. Generator RPP</h1>
                <span class="text-xs font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 px-3 py-2 rounded-lg">
                    AI: Groq ‚Ä¢ Model: <span id="modelName"></span>
                </span>
                <select id="model" class="border rounded p-2 text-sm bg-slate-50 flex-1 max-w-md cursor-pointer hover:bg-slate-100 font-medium text-slate-700">
                    <optgroup label="üî• Populer & Berbasis Masalah">
                        <option>Problem Based Learning (PBL)</option>
                        <option>Project Based Learning (PjBL)</option>
                        <option>Case Based Learning (CBL)</option>
                        <option>Challenge Based Learning</option>
                    </optgroup>
                    <optgroup label="üöÄ Pendekatan Modern (Abad 21)">
                        <option>Deep Learning (Pembelajaran Mendalam)</option>
                        <option>Teaching at the Right Level (TaRL/Diferensiasi)</option>
                        <option>STEAM Approach</option>
                        <option>Blended Learning (Hybrid)</option>
                        <option>Flipped Classroom</option>
                        <option>Social Emotional Learning (SEL)</option>
                        <option>Gamifikasi</option>
                    </optgroup>
                    <optgroup label="üß† Penemuan & Inkuiri">
                        <option>Discovery Learning</option>
                        <option>Inquiry Learning (Terbimbing)</option>
                        <option>Inquiry Learning (Open)</option>
                        <option>Contextual Teaching & Learning (CTL)</option>
                    </optgroup>
                    <optgroup label="ü§ù Kooperatif">
                        <option>Cooperative Learning (Jigsaw)</option>
                        <option>Cooperative Learning (STAD)</option>
                        <option>Peer Tutoring (Tutor Sebaya)</option>
                        <option>Think-Pair-Share (TPS)</option>
                    </optgroup>
                </select>
            </div>
            <button onclick="batch()" id="btnGen" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-700 transition">
                ‚ú® Generate & Simpan
            </button>
        </header>

        <div id="progressWrap" class="bg-white border-b px-6 py-2 hidden">
            <div class="flex items-center gap-3">
                <div id="progressText" class="text-xs font-bold text-slate-600 w-20">0/0</div>
                <div class="flex-1 h-2 bg-slate-200 rounded overflow-hidden">
                    <div id="progressBar" class="h-2 bg-indigo-600 rounded" style="width:0%"></div>
                </div>
                <div id="progressStatus" class="text-xs text-slate-500 w-72 truncate text-right"></div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-80 bg-white border-r overflow-y-auto p-4 flex flex-col">
                <div class="flex justify-between items-center mb-3 pb-2 border-b">
                    <span class="text-xs font-bold text-slate-500 uppercase">Pilih Materi</span>
                    <label class="flex items-center gap-1 text-xs text-blue-600 cursor-pointer font-bold select-none">
                        <input type="checkbox" onchange="toggleAll(this)"> Pilih Semua
                    </label>
                </div>
                <div id="list" class="space-y-1 flex-1"></div>
            </aside>

            <main class="flex-1 overflow-y-auto p-8 bg-gray-100" id="previewArea">
                <div id="print" class="bg-white p-12 rounded shadow min-h-[800px] prose prose-sm max-w-none rpp-content">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-300">
                        <p class="text-lg">Pilih materi di kiri, lalu klik <b>Generate & Simpan</b>.</p>
                    </div>
                </div>
            </main>
        </div>

        <footer class="bg-white border-t p-4 absolute bottom-0 w-full flex justify-between z-20 shadow-lg">
            <a href="step6_promes.html" class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800">‚Üê Kembali</a>
            <a href="step8_lampiran.html" class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                Lanjut ke Lampiran (Step 8) ‚Üí
            </a>
        </footer>
    </div>

    <script>
        const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        let user, profile={}, mats=[], generatedRPP = "";

        async function init(){
            const {data:{session}} = await db.auth.getSession(); 
            if(!session) return location.href='index.html'; user=session.user;
            
            const {data:p} = await db.from('profiles').select('*').eq('id',user.id).maybeSingle(); 
            profile=p||{ mata_pelajaran:'Umum', fase_kelas:'Umum', jenis_kurikulum:'Merdeka' };
            
            const {data:m} = await db.from('work_drafts').select('*').eq('user_id',user.id).eq('doc_type','master_cp_atp').maybeSingle();
            if(m && m.content_data) mats = m.content_data;
            renderList();
            // Step 7 memakai Groq langsung dari frontend (API OpenAI-compatible).
            document.getElementById('modelName').textContent = (CONFIG.GROQ_MODEL || 'llama-3.3-70b-versatile');
        } init();

        function escapeHTML(s){
            return String(s ?? '')
              .replace(/&/g,'&amp;')
              .replace(/</g,'&lt;')
              .replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;')
              .replace(/'/g,'&#39;');
        }


        function renderList() {
            const l = document.getElementById('list'); l.innerHTML = '';
            mats.forEach((x, i) => {
                l.innerHTML += `<label class="flex gap-3 text-sm p-3 border rounded hover:bg-slate-50 cursor-pointer items-start"><input type="checkbox" class="chk mt-1" value="${i}"> <div><div class="font-bold text-slate-700">${escapeHTML(x.elemen || 'Tanpa Judul')}</div><div class="text-xs text-slate-500 line-clamp-2">${escapeHTML(x.deskripsi || '')}</div></div></label>`;
            });
        }
        function toggleAll(src) { document.querySelectorAll('.chk').forEach(c => c.checked = src.checked); }

        function pickGroqText(json){
            return String(json?.choices?.[0]?.message?.content ?? '').trim();
        }

        
        function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

        let lastGroqCallAt = 0;

        function calcSpacingMs(){
            // MODE "GURU SABAR": lebih baik menunggu lama daripada error.
            // Groq rate limit kombinasi RPM & TPM. Jadi kita bikin pacing konservatif.
            const manual = Number(CONFIG.GROQ_MIN_INTERVAL_MS ?? 0);
            if(manual && manual > 0) return Math.max(500, manual);
            return 3500;
        }

        function showProgress(show){
            const wrap = document.getElementById('progressWrap');
            if(!wrap) return;
            wrap.classList.toggle('hidden', !show);
        }

        function setProgress(done, total, status){
            const t = document.getElementById('progressText');
            const b = document.getElementById('progressBar');
            const s = document.getElementById('progressStatus');
            if(t) t.textContent = `${done}/${total}`;
            if(b) b.style.width = total ? `${Math.round((done/total)*100)}%` : "0%";
            if(s) s.textContent = status || '';
        }

        const currentProgress = { done: 0, total: 0 };

        async function waitWithStatus(ms, statusPrefix){
            const start = Date.now();
            const total = ms;
            while(true){
                const elapsed = Date.now() - start;
                const left = Math.max(0, total - elapsed);
                const sec = (left/1000).toFixed(1);
                setProgress(currentProgress.done, currentProgress.total, `${statusPrefix} ${sec}s‚Ä¶`);
                if(left <= 0) break;
                await sleep(Math.min(250, left));
            }
        }

        async function enforceSpacing(){
            const spacing = calcSpacingMs();
            const now = Date.now();
            const wait = Math.max(0, spacing - (now - lastGroqCallAt));
            if(wait > 0){
                await waitWithStatus(wait, 'Throttle');
            }
        }

        function deriveRetryWaitMs(res, msg, attempt){
            // 1) Retry-After header (seconds)
            const ra = res.headers?.get?.('retry-after');
            if(ra && !Number.isNaN(Number(ra))) return Math.ceil(Number(ra) * 1000) + 300;

            // 2) Parse message: "Please retry in 27.6s."
            const m = String(msg || '').match(/retry in\s+([0-9.]+)s/i);
            if(m) return Math.ceil(Number(m[1]) * 1000) + 300;

            // 3) Exponential backoff fallback
            return Math.min(60000, 1500 * Math.pow(2, attempt - 1)) + 300;
        }

        async function callGroq(prompt){
            // Groq API OpenAI-compatible: POST /chat/completions
            const apiKey = String(CONFIG.GROQ_API_KEY || '').trim();
            if(!apiKey) throw new Error('CONFIG.GROQ_API_KEY masih kosong. Isi di config.js (Groq API Key).');

            const base = (CONFIG.GROQ_BASE_URL || 'https://api.groq.com/openai/v1').replace(/\/+$/,'');
            const url = `${base}/chat/completions`;

            const payload = {
                model: (CONFIG.GROQ_MODEL || 'llama-3.3-70b-versatile').trim(),
                temperature: Number(CONFIG.GROQ_TEMPERATURE ?? 0.4),
                max_tokens: Number(CONFIG.GROQ_MAX_TOKENS ?? 2500),
                messages: [
                    {
                        role: 'system',
                        content: 'Anda adalah guru profesional di Indonesia. Buat output RPP sebagai HTML BODY saja (tanpa <html>/<head>), TANPA Markdown. Gunakan bahasa Indonesia yang jelas dan praktis.'
                    },
                    { role: 'user', content: prompt }
                ]
            };

            let attempt = 0;
            const maxRetries = Number(CONFIG.GROQ_MAX_RETRIES ?? 12);
            while(true){
                attempt++;

                await enforceSpacing();
                lastGroqCallAt = Date.now();

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                // Groq mengembalikan 429 saat rate limit. Header retry-after hanya ada jika 429.
                if(res.ok){
                    const json = await res.json();
                    const txt = pickGroqText(json);
                    if(!txt) throw new Error('Groq tidak mengembalikan teks (choices kosong).');
                    return txt;
                }

                let msg = '';
                try {
                    const j = await res.json();
                    msg = j?.error?.message || JSON.stringify(j);
                } catch(_){
                    msg = await res.text();
                }

                if(res.status === 429){
                    if(attempt > maxRetries) throw new Error(`Groq error 429 berulang: ${msg}`);

                    // 1) retry-after (seconds)
                    const ra = res.headers?.get?.('retry-after');
                    let waitMs = (ra && !Number.isNaN(Number(ra))) ? Math.ceil(Number(ra) * 1000) : 0;

                    // 2) parse message: "Please try again in 1.287s"
                    if(!waitMs){
                        const m = String(msg || '').match(/try again in\s+([0-9.]+)s/i);
                        if(m) waitMs = Math.ceil(Number(m[1]) * 1000);
                    }

                    // 3) fallback exponential backoff
                    if(!waitMs) waitMs = Math.min(60000, 1500 * Math.pow(2, attempt - 1));
                    waitMs += 300;

                    await waitWithStatus(waitMs, `Rate limit (429) ‚Ä¢ menunggu`);
                    continue;
                }

                throw new Error(`Groq error ${res.status}: ${msg}`);
            }
        }

        function buildRppPrompt({ m, modelPembelajaran }){
            // deteksi kurikulum
            const kur = String(profile.jenis_kurikulum || '').toLowerCase();
            const isK13 = kur.includes('2013') || kur.includes('k13');

            const bab = m?.bab || m?.bab_title || '';
            const subBab = m?.sub_bab || m?.subbab || '';
            const topik = m?.elemen || subBab || 'Topik';

            if(isK13){
                return `KURIKULUM: Kurikulum 2013 (K13).\nSUMBER DATA: Profil Step 1 (Mapel, Kelas/Fase, Kurikulum) + Step 7 (Bab, Sub-bab, Metode/Model Pembelajaran).\nMAPEL: ${profile.mata_pelajaran}, KELAS: ${profile.fase_kelas}.\nBAB: ${bab || '-'}\nSUB-BAB: ${subBab || '-'}\nTOPIK: "${topik}"\nMODEL PEMBELAJARAN: ${modelPembelajaran}.\n\nTUGAS: Buat RPP sebagai HTML BODY saja (tanpa <html><head>), TANPA Markdown.\nSertakan komponen: Identitas, Tujuan Pembelajaran, Materi, Metode/Model, Media & Sumber Belajar, Langkah Pembelajaran (Pendahuluan, Inti, Penutup), Penilaian (Sikap, Pengetahuan, Keterampilan) + instrumen ringkas.\nGunakan bahasa Indonesia yang jelas, praktis, dan siap cetak.`;
            }

            // default KM
            return `KURIKULUM: Kurikulum Merdeka (KM).\nSUMBER DATA: Profil Step 1 (Mapel, Kelas/Fase, Kurikulum) + Step 7 (Bab, Sub-bab, Metode/Model Pembelajaran).\nMAPEL: ${profile.mata_pelajaran}, FASE/KELAS: ${profile.fase_kelas}.\nBAB: ${bab || '-'}\nSUB-BAB: ${subBab || '-'}\nTOPIK: "${topik}"\nMODEL PEMBELAJARAN: ${modelPembelajaran}.\n\nTUGAS: Buat Modul Ajar/RPP ringkas sebagai HTML BODY saja (tanpa <html><head>), TANPA Markdown.\nSertakan: Tujuan Pembelajaran, Pemahaman Bermakna, Pertanyaan Pemantik, Langkah Pembelajaran (Pendahuluan, Inti + Diferensiasi, Penutup), Asesmen (Diagnostik/Formatif/Sumatif), serta Sumber Belajar.\nGunakan bahasa Indonesia yang jelas, praktis, dan siap cetak.`;
        }

        async function batch(){
            const chk = document.querySelectorAll('.chk:checked'); 
            if(chk.length === 0) return alert("Pilih minimal 1 materi!");
            
            const btn = document.getElementById('btnGen'); 
            btn.disabled = true; btn.innerHTML = `‚è≥ Memproses...`;
            
            // progress bar
            showProgress(true);
            currentProgress.total = chk.length;
            currentProgress.done = 0;
            setProgress(0, chk.length, 'Mulai‚Ä¶');

            let htmlAccumulator = "";
            const model = document.getElementById('model').value;

            for(let idx=0; idx<chk.length; idx++){
                const c = chk[idx];
                const m = mats[c.value];
                const bab = m?.bab || m?.bab_title || '';
                const subBab = m?.sub_bab || m?.subbab || '';
                const topik = m?.elemen || subBab || 'Topik';
                const label = `${bab ? (bab + ' ‚Ä¢ ') : ''}${subBab ? (subBab + ' ‚Ä¢ ') : ''}${topik}`;

                setProgress(currentProgress.done, currentProgress.total, `Memproses ${idx+1}/${currentProgress.total}: ${label}`);
                document.getElementById('print').innerHTML = `<div class="text-center text-blue-600 mt-20"><p>Sedang membuat RPP: <b>${escapeHTML(label)}</b>...</p></div>`;

                try {
                    const prompt = buildRppPrompt({ m, modelPembelajaran: model });

                    let txt = await callGroq(prompt);

                    if(!txt) txt = "<p style='color:red'>Gagal mendapatkan respon dari AI.</p>";

                    // Safe Cleaning
                    txt = txt.replace(/<think>[\s\S]*?<\/think>/gi,"").replace(/```html/g,"").replace(/```/g,"");

                    // Sanitasi HTML output AI (hindari XSS)
                    txt = DOMPurify.sanitize(txt, { USE_PROFILES: { html: true } });
                    
                    currentProgress.done += 1;
                    setProgress(currentProgress.done, currentProgress.total, `Selesai ${currentProgress.done}/${currentProgress.total}`);

                    htmlAccumulator += `<div class="rpp-section mt-8"><div style="background:#f8fafc; padding:10px; border-left:5px solid #2563eb;"><h2 style="margin:0; font-size:14pt; color:#1e40af;">TOPIK: ${escapeHTML(label)}</h2><p style="margin:0; font-size:10pt;">Model: ${escapeHTML(model)}</p></div>${txt}</div><div class="page-break"></div>`;

                } catch(e) {
                    console.error(e);
                    currentProgress.done += 1;
                    setProgress(currentProgress.done, currentProgress.total, `Lewati (error) ${currentProgress.done}/${currentProgress.total}`);
                    const msg = escapeHTML(String(e?.message || e));
                    const errHtml = `<p style="color:#b91c1c;font-weight:600">Gagal generate untuk topik ini.</p><p style="color:#b91c1c;font-size:10pt">${msg}</p>`;
                    document.getElementById('print').innerHTML = errHtml;
                    htmlAccumulator += `<div class="rpp-section mt-8"><div style="background:#fef2f2; padding:10px; border-left:5px solid #b91c1c;"><h2 style="margin:0; font-size:14pt; color:#b91c1c;">TOPIK: ${escapeHTML(label)}</h2><p style="margin:0; font-size:10pt;">(gagal)</p></div>${errHtml}</div><div class="page-break"></div>`;
                }
            }
            
            generatedRPP = htmlAccumulator;
            document.getElementById('print').innerHTML = DOMPurify.sanitize(generatedRPP, { USE_PROFILES: { html: true } });
            
            await saveRPPToDB();
            
            btn.disabled = false; btn.innerHTML = "‚ú® Generate & Simpan";
            setProgress(currentProgress.total, currentProgress.total, 'Selesai ‚úÖ');
            await sleep(400);
            showProgress(false);
            alert("Berhasil! RPP telah disimpan ke Step 9.");
        }

        async function saveRPPToDB() {
            if(!generatedRPP) return;
            // FIX ERROR 400: Pastikan semua field terisi
            const payload = {
                user_id: user.id,
                doc_type: 'rpp_result',
                subject_name: profile.mata_pelajaran || 'Umum',
                grade_level: profile.fase_kelas || 'Umum',
                curriculum_type: profile.jenis_kurikulum || 'Merdeka',
                content_data: { html: generatedRPP },
                status: 'confirmed'
            };
            
            const { error } = await db.from('work_drafts').upsert(payload, { onConflict: 'user_id, doc_type' });
            if(error) console.error("Gagal Simpan DB:", error.message);
        }
    </script>
</body>
</html>