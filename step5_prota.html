<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Langkah 5: Prota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="sidebar.js"></script>
</head>
<body class="bg-gray-50 text-slate-800 h-screen flex font-sans overflow-hidden">

    <div id="sidebar-container" class="flex-none h-full"></div>

    <div class="flex-1 flex flex-col relative">
        <header class="bg-white border-b px-6 py-4 shadow-sm z-10">
            <h1 class="text-xl font-bold text-slate-900">5. Program Tahunan (PROTA)</h1>
            <p class="text-xs text-slate-500">Tinjau distribusi materi Semester Ganjil & Genap.</p>
        </header>

        <main class="flex-1 overflow-y-auto p-8 pb-24">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded shadow border min-h-[500px]">
                <h2 class="text-center font-bold text-xl mb-6 text-slate-800">PROGRAM TAHUNAN</h2>
                <div id="protaContent" class="text-center text-gray-500 italic">Memuat data...</div>
            </div>
        </main>

        <footer class="bg-white border-t p-4 absolute bottom-0 w-full flex justify-between z-20 shadow-lg">
            <a href="step4_alokasi.html" class="px-6 py-2 text-slate-500 font-bold hover:text-slate-800">← Kembali</a>
            <a href="step6_promes.html" class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition transform active:scale-95">
                Lanjut ke Promes →
            </a>
        </footer>
    </div>

    <script>
        const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        let startYear=new Date().getFullYear(); 
        const MONTHS=["Juli","Agustus","September","Oktober","November","Desember","Januari","Februari","Maret","April","Mei","Juni"];

        async function init() {
            const { data: { session } } = await db.auth.getSession();
            if(!session) return location.href = 'index.html'; 
            
            const { data: p } = await db.from('profiles').select('tahun_ajaran').eq('id', session.user.id).maybeSingle();
            if(p && p.tahun_ajaran) startYear = parseInt(p.tahun_ajaran.split('/')[0]) || startYear;

            const { data: d } = await db.from('work_drafts').select('*').eq('user_id', session.user.id).eq('doc_type', 'promes_data').maybeSingle();
            if(d) render(d.content_data); else { alert("Data belum lengkap."); location.href = 'step3_kalender.html'; }
        } init();

        function render(data) {
            let cal = data.calendar || {};
            let mats = data.materials || [];
            let jp = parseInt(data.jp_per_week) || 4;

            // Hitung Kapasitas Semester 1 (Juli - Des)
            let capSmt1 = 0;
            for(let i=0; i<6; i++) {
                const year = startYear; const mIdx = i+6; 
                const days = new Date(year, mIdx+1, 0).getDate();
                for(let d=1; d<=days; d++) {
                    const k = `${year}-${mIdx}-${d}`;
                    if(new Date(year, mIdx, d).getDay()!==0 && !cal[k]) capSmt1++;
                }
            }
            let jpSmt1Cap = Math.floor(capSmt1 * (jp/5));

            let html = `<table class="w-full border-collapse border text-sm text-left"><thead class="bg-gray-100 font-bold text-slate-700 text-center"><tr><th class="border p-3">SMT</th><th class="border p-3">No</th><th class="border p-3 text-left">Materi Pokok</th><th class="border p-3">Alokasi</th></tr></thead><tbody>`;
            
            let acc = 0;
            mats.forEach((m, i) => {
                acc += m.jp;
                const smt = acc <= jpSmt1Cap ? "1 (Ganjil)" : "2 (Genap)";
                const bg = smt.includes("1") ? "bg-white" : "bg-slate-50";
                html += `<tr class="${bg}"><td class="border p-3 text-center font-bold text-slate-500">${smt}</td><td class="border p-3 text-center">${i+1}</td><td class="border p-3">${m.topic}</td><td class="border p-3 text-center font-bold text-blue-600">${m.jp} JP</td></tr>`;
            });
            document.getElementById('protaContent').innerHTML = html + `</tbody></table>`;
        }
    </script>
</body>
</html>