<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Langkah 2: Analisis Materi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
  <script src="layout.js"></script>
</head>

<body class="bg-slate-100 text-slate-800 h-screen flex font-sans overflow-hidden">
  
  <div id="sidebar-container"></div>

  <div class="flex-1 flex flex-col relative min-w-0">
    
    <header class="h-20 bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-10 flex justify-between items-center shrink-0">
      <div>
        <h1 class="text-xl font-bold text-slate-900">2. Analisis & Alokasi Waktu</h1>
        <p class="text-xs text-slate-500">Pecah KI/KD atau CP menjadi Tujuan Pembelajaran Rinci.</p>
      </div>

      <div class="flex items-center gap-3">
        <span id="badgeKurikulum" class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full uppercase tracking-wide">...</span>
        <button onclick="deleteDraft()" class="bg-red-50 text-red-700 px-3 py-2 rounded-lg font-bold hover:bg-red-100 border border-red-200 text-xs flex items-center gap-1 transition">
          üóëÔ∏è Hapus Data
        </button>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-8 bg-slate-100 pb-32 flex flex-col gap-6 relative">
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-xl border border-blue-200 shadow-sm relative overflow-hidden h-full">
            <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
            <div class="flex justify-between items-start mb-4">
                <h3 class="font-bold text-blue-800 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span> 
                    Ambil Prompt AI
                </h3>
                <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded border">Gemini / ChatGPT</span>
            </div>
            <p class="text-xs text-slate-600 mb-6 leading-relaxed">
                Prompt ini sudah dimodifikasi agar AI menyertakan <b>KI (Kompetensi Inti)</b> untuk K13 atau Elemen CP untuk Kurmer.
            </p>
            <button onclick="openGemini()" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition transform active:scale-95 flex items-center justify-center gap-2 text-sm">
                üìã Copy Prompt & Buka AI ‚Üó
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl border border-orange-200 shadow-sm relative overflow-hidden h-full flex flex-col">
            <div class="absolute top-0 left-0 w-full h-1 bg-orange-500"></div>
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-orange-800 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    Tempel Hasil
                </h3>
                <button onclick="processJSON()" class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-orange-200 transition">
                    ‚¨áÔ∏è Proses Data
                </button>
            </div>
            <textarea id="jsonInput" class="flex-1 w-full border border-slate-300 rounded-lg p-3 text-[10px] font-mono focus:ring-2 focus:ring-orange-500 outline-none transition bg-slate-50 focus:bg-white resize-none" placeholder='[...] Paste Array JSON dari AI di sini...'></textarea>
        </div>
      </div>

      <div id="resultArea" class="bg-white rounded-xl border border-slate-200 shadow-sm hidden overflow-hidden flex-1 flex flex-col min-h-[400px]">
        <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
          <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide flex items-center gap-2">
            <span>üìä</span> Tabel Hasil Analisis
          </h3>
          <button onclick="addRow()" class="text-xs bg-white border border-slate-300 px-3 py-1.5 rounded hover:bg-blue-50 hover:text-blue-600 font-bold transition shadow-sm">
            Tambah Baris
          </button>
        </div>

        <div class="overflow-auto flex-1 relative">
            <table class="w-full text-sm text-left border-collapse">
              <thead class="bg-slate-100 text-slate-600 border-b uppercase text-[10px] tracking-wider sticky top-0 z-10 shadow-sm">
                <tr>
                  <th class="p-3 w-24 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">SKL</th>

                  <th class="p-3 w-20 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_ki">KI / Elemen</th>
                  <th class="p-3 w-28 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th1">Materi</th>
                  <th class="p-3 w-24 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th2">KD / CP</th>
                  <th class="p-3 w-24 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th3">IPK / TP</th>

                  <!-- KM-only -->
                  <th class="p-3 w-24 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_kko">KKO</th>
                  <th class="p-3 w-28 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_katakunci">Kata Kunci/Glosarium</th>

                  <th class="p-3 w-40 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">Kegiatan Pembelajaran</th>
                  <th class="p-3 w-32 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">Rencana Penilaian</th>

                  <th class="p-3 w-32 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_sumber">Sumber Belajar</th>

                  <!-- K13-only -->
                  <th class="p-3 w-20 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_kompleksitas">Kompleksitas</th>
                  <th class="p-3 w-24 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_daya">Daya Dukung</th>
                  <th class="p-3 w-20 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800" id="th_intake">Intake</th>

                  <th class="p-3 w-14 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">KKM/KKTP</th>
                  <th class="p-3 w-12 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">Sem</th>
                  <th class="p-3 w-12 text-center bg-blue-50 font-bold border-r border-blue-100 text-blue-800">JP</th>

                  <th class="p-3 w-16 text-center bg-blue-50 font-bold text-blue-800">Aksi</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-gray-100 bg-white"></tbody>
            </table>
        </div>
      </div>

    </main>

    <footer class="h-20 bg-white border-t border-slate-200 px-6 absolute bottom-0 w-full flex justify-between items-center z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
      <a href="step1_profil.html" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-800 text-sm transition flex items-center gap-1"><span>‚Üê</span> Kembali</a>
      <button onclick="save()" id="btnSave" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 text-sm" disabled>
        <span>üíæ</span> Simpan & Lanjut (Kalender) ‚Üí
      </button>
    </footer>
  </div>

<script>
  const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
  let user, dataList=[], profile={};

    // --- Helpers: Opsi B (0-100) untuk KKM (K13) ---
  function _clamp0100(n){
    n = Number(n);
    if (Number.isNaN(n)) return '';
    if (n < 0) n = 0;
    if (n > 100) n = 100;
    return Math.round(n);
  }

  // kind: 'kompleksitas' | 'daya_dukung' | 'intake' | 'kkm'
  // - Menerima angka langsung (0-100)
  // - Menerima teks Tinggi/Sedang/Rendah dan mengubah ke angka titik tengah rentang umum:
  //   Kompleksitas: tinggi 50-64, sedang 65-80, rendah 81-100
  //   Daya Dukung/Intake: rendah 50-64, sedang 65-80, tinggi 81-100
  function toNum0100(v, kind){
    if (v === null || v === undefined) return '';
    let s = String(v).trim();
    if (!s) return '';

    // angka murni
    if (/^-?\d+(?:[\.,]\d+)?$/.test(s)) {
      return _clamp0100(parseFloat(s.replace(',', '.')));
    }

    // ambil angka pertama jika ada
    const m = s.match(/-?\d+(?:[\.,]\d+)?/);
    if (m) return _clamp0100(parseFloat(m[0].replace(',', '.')));

    const t = s.toLowerCase();
    const isTinggi = t.includes('tinggi');
    const isSedang = t.includes('sedang');
    const isRendah = t.includes('rendah');

    if (kind === 'kompleksitas') {
      if (isTinggi) return 57;   // tengah 50-64
      if (isSedang) return 72;   // tengah 65-80
      if (isRendah) return 90;   // tengah 81-100
    } else if (kind === 'daya_dukung' || kind === 'intake') {
      if (isRendah) return 57;
      if (isSedang) return 72;
      if (isTinggi) return 90;
    } else { // kkm: tidak perlu mapping tinggi/sedang/rendah
      // biarkan kosong jika bukan angka
    }
    return '';
  }

  // Sinkronisasi KKM (K13) dengan rata-rata 3 aspek (Opsi B)
  function syncKKMRow(i, mode){
    // mode: 'from_aspek' | 'from_kkm'
    const d = dataList[i];
    if (!d) return;

    const k  = toNum0100(d.col_kompleksitas, 'kompleksitas');
    const dd = toNum0100(d.col_daya_dukung,  'daya_dukung');
    const it = toNum0100(d.col_intake,       'intake');
    const kkm = toNum0100(d.col4, 'kkm');

    const hasAspek = (k !== '' && dd !== '' && it !== '');
    const hasKKM   = (kkm !== '');

    if (mode === 'from_aspek' && hasAspek){
      const avg = Math.round((Number(k)+Number(dd)+Number(it))/3);
      d.col4 = String(_clamp0100(avg));
      return;
    }

    if (mode === 'from_kkm' && hasKKM){
      if (!hasAspek){
        // default aman: set semua aspek = KKM
        d.col_kompleksitas = String(kkm);
        d.col_daya_dukung  = String(kkm);
        d.col_intake       = String(kkm);
        return;
      }

      // jika aspek sudah ada: geser semuanya dengan delta agar avg tepat = KKM
      const avg0 = (Number(k)+Number(dd)+Number(it))/3;
      const delta = Number(kkm) - avg0;

      d.col_kompleksitas = String(_clamp0100(Number(k)  + delta));
      d.col_daya_dukung  = String(_clamp0100(Number(dd) + delta));
      d.col_intake       = String(_clamp0100(Number(it) + delta));

      // pastikan benar-benar pas (pembulatan)
      const avg1 = Math.round((Number(d.col_kompleksitas)+Number(d.col_daya_dukung)+Number(d.col_intake))/3);
      d.col4 = String(_clamp0100(avg1));
    }
  }

async function init(){
    const {data:{session}} = await db.auth.getSession();
    if(session) { user = session.user; loadData(); }
  }
  init();

  async function loadData() {
    const {data} = await db.from('profiles').select('*').eq('id', user.id).maybeSingle();
    profile = data || { jenis_kurikulum: 'Merdeka', mata_pelajaran: 'Umum', fase_kelas: 'Umum' };
    setupUI();

    const { data: d } = await db.from('work_drafts').select('*')
      .eq('user_id', user.id).eq('doc_type', 'master_cp_atp').maybeSingle();
    
    if(d && d.content_data){
      // Mapping Data Baru (Support KI)
      dataList = d.content_data.map(x=>({
        // kolom baru (standar buku kerja)
        col_skl: x.skl || x.col_skl || '',
        col7: x.kegiatan_pembelajaran || x.col7 || '',
        col8: x.rencana_penilaian || x.col8 || '',
        col_sumber: x.sumber_belajar || x.col_sumber || '',
        col_kko: x.kko || x.col_kko || '',
        col_katakunci: x.kata_kunci || x.col_katakunci || '',
        col_kompleksitas: (toNum0100(x.kompleksitas || x.col_kompleksitas || '', 'kompleksitas') || ''),
        col_daya_dukung: (toNum0100(x.daya_dukung || x.col_daya_dukung || '', 'daya_dukung') || ''),
        col_intake: (toNum0100(x.intake || x.col_intake || '', 'intake') || ''),

        // kolom inti (kompatibilitas lama)
        col_ki: x.ki_text || x.ki || x.col_ki || '', 
        col1: x.materi_pembelajaran || x.elemen || x.col1 || '', 
        col2: x.kd || x.deskripsi || x.col2 || '', 
        col3: x.ipk || x.detail_tp || x.col3 || '', 
        col4: x.detail_kktp || x.col4 || '',
        col5: String(x.semester || x.col5 || '1'), 
        col6: String(x.alokasi_jp || x.col6 || '2')
      }));
      if(dataList.length) { render(); enableSaveBtn(); }
    }
  }

  function setupUI(){
    const kur = (profile.jenis_kurikulum || '').toString().toLowerCase();
    const isMerdeka = (kur === 'km') || kur.includes('merdeka');

    document.getElementById('badgeKurikulum').innerText = isMerdeka ? "Kurikulum Merdeka" : "Kurikulum 2013";

    // Label Dinamis
    document.getElementById('th_ki').innerText = isMerdeka ? "Elemen CP" : "Kompetensi Inti (KI)";
    document.getElementById('th1').innerText = "Materi Pokok";
    document.getElementById('th2').innerText = isMerdeka ? "CP Asli" : "Kompetensi Dasar (KD)";
    document.getElementById('th3').innerText = isMerdeka ? "Tujuan Pembelajaran (TP)" : "Indikator (IPK)";

    // Toggle header KM-only
    ['th_kko','th_katakunci'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = isMerdeka ? '' : 'none';
    });

    // Toggle header K13-only
    ['th_kompleksitas','th_daya','th_intake'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = !isMerdeka ? '' : 'none';
    });
  }
  function enableSaveBtn() { document.getElementById('btnSave').disabled = false; }

  // --- PROMPT BARU (VERSI LENGKAP + TAMBAHAN KKO & KATA KUNCI) ---
  function openGemini() {
    const isMerdeka = (profile.jenis_kurikulum || '').toLowerCase().includes('merdeka');
    const labelKI = isMerdeka ? "Elemen CP" : "Kompetensi Inti (KI)";

    // --- 1. KONSTRUKSI PROMPT (Tetap Lengkap) ---
    const prompt = `PERAN: Ahli Kurikulum (K13/Kurmer). 
KONTEKS: ${profile.mata_pelajaran}, ${profile.fase_kelas}, ${profile.jenis_kurikulum}.

TUGAS:
1) Ambil/rujuk SKL yang relevan (salin dari Permendikbud/aturan resmi yang berlaku untuk jenjangnya, jika tersedia dari dokumen input; jika tidak ada, tulis ringkasan SKL yang paling umum untuk mapel/jenjang).
2) Analisis dokumen input (KI/KD atau CP) lalu turunkan menjadi IPK yang terukur.
3) Identifikasi KATA KERJA OPERASIONAL (KKO) dari TP tersebut (misal: Menganalisis, Menyajikan).
4) Identifikasi KATA KUNCI (Glosarium) atau istilah-istilah penting dari materi tersebut.
5) Lengkapi: Materi Pembelajaran, Kegiatan Pembelajaran (contoh aktivitas siswa: Mengamati, Menanya, Mencoba, Menalar, Menyaji, Mencipta), Rencana Penilaian (Tes Tulis/Unjuk Kerja/Proyek), dan Sumber Belajar.
6) KHUSUS K13: isi Kompleksitas, Daya Dukung, Intake dalam bentuk angka 0-100, serta pastikan KKM = rata-rata (Kompleksitas + Daya Dukung + Intake) / 3 (bulatkan ke integer).

ATURAN PENTING:
- Output HARUS JSON ARRAY murni (tanpa markdown, tanpa penjelasan).
- IPK harus spesifik & bisa diukur.
- "KKO" diisi hanya kata kerjanya saja.
- "Kata Kunci" diisi daftar istilah penting dipisahkan koma.
- Output untuk 1 TAHUN (Semester 1 dan Semester 2) sesuai dokumen.
- Setiap baris WAJIB punya semester: "col5" = "1" atau "2" (jangan selain itu).
- Untuk Kurikulum Merdeka: 
  - Isi "KI" dengan Elemen CP (atau Profil/Elemen yang paling relevan),
  - Isi "KD" dengan kutipan CP yang relevan,
  - Isi "IPK" dengan TP yang operasional.
- Untuk Kurikulum 2013:
  - Isi "KI" dengan KI-3 (Pengetahuan) atau KI-4 (Keterampilan) yang sesuai,
  - Isi "KD" dengan KD 3.x atau 4.x,
  - Isi "IPK" diturunkan dari KD sesuai KKO.

FORMAT OUTPUT (WAJIB):
[
  {
    "SKL": "Salin/rujuk SKL (Permendikbud) atau ringkasan SKL yang relevan",
    "KI": "KI-3 / KI-4 atau Elemen CP",
    "KD": "KD 3.x/4.x atau kutipan CP",
    "IPK": "Target spesifik terukur",
    "KKO": "Kata Kerja Operasional (mis: Menganalisis)",
    "Kata Kunci": "Istilah penting / Glosarium",
    "Materi Pembelajaran": "Topik/Sub-topik",
    "Kegiatan Pembelajaran": "Aktivitas siswa (Mengamati, Menanya, Mencoba, dst.)",
    "Rencana Penilaian": "Tes Tulis / Unjuk Kerja / Proyek",
    "Sumber Belajar": "Buku paket/modul/LKPD/video/situs resmi/lingkungan sekitar (tulis ringkas)",
    "KKM/KKTP": "ANGKA 0-100 (contoh: 75). Untuk Kurikulum Merdeka, boleh pakai angka target (mis. 75) atau interval (mis. 70-100), tapi tetap NUMERIK.",
    "Kompleksitas": "KHUSUS K13: angka 0-100",
    "Daya Dukung": "KHUSUS K13: angka 0-100",
    "Intake": "KHUSUS K13: angka 0-100",

    "col_ki": "SAMA dengan KI",
    "col1": "SAMA dengan Materi Pembelajaran",
    "col2": "SAMA dengan KD",
    "col3": "SAMA dengan IPK",
    "col_kko": "SAMA dengan KKO",
    "col_katakunci": "SAMA dengan Kata Kunci",
    "col7": "SAMA dengan Kegiatan Pembelajaran",
    "col8": "SAMA dengan Rencana Penilaian",
    "col4": "SAMA dengan KKM/KKTP (angka)",
    "col5": "1 atau 2 (WAJIB string)",
    "col6": "2"
  }
]`;

    // --- 2. EKSEKUSI (ANTI-BLOCKER) ---
    // Strategi: Buka Gemini dulu, lalu minta user klik OK untuk buka Drive.
    // Ini satu-satunya cara agar browser tidak memblokir tab kedua.
    
    navigator.clipboard.writeText(prompt).then(() => {
        // A. Buka Gemini (Langsung)
        window.open('https://gemini.google.com/app', '_blank');

        // B. Tawarkan Buka Drive (Lewat Interaksi User)
        Swal.fire({
            icon: 'success',
            title: 'Prompt Tersalin & Gemini Terbuka!',
            html: 'Silakan paste prompt di Gemini.<br><br><b>Perlu materi dari Google Drive?</b>',
            showCancelButton: true,
            confirmButtonText: 'üìÇ Ya, Buka Folder Materi',
            cancelButtonText: 'Tutup',
            confirmButtonColor: '#2563eb',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                window.open('https://drive.google.com/drive/folders/11y3RA4CUBc0Fnt4CsRR5IOJ5H8Dws5Ul?usp=sharing', '_blank');
            }
        });
    });
}

  function _stripCodeFences(s){
    const m = (s||"").match(/```(?:json|JSON)?\s*([\s\S]*?)```/);
    return m ? m[1].trim() : (s||"");
  }
  
  function processJSON(raw){
    const kur = (profile?.jenis_kurikulum || '').toString().toLowerCase();
    const isMerdeka = (kur === 'km') || kur.includes('merdeka');
    try{
      let raw = document.getElementById('jsonInput').value || '';
      raw = _stripCodeFences(raw).trim();

      // 1) Jika ada teks sebelum/after JSON, ambil kandidat JSON Array pertama
      //    ambil dari '[' pertama sampai ']' terakhir
      const firstBracket = raw.indexOf('[');
      const lastBracket  = raw.lastIndexOf(']');
      if (firstBracket !== -1 && lastBracket !== -1 && lastBracket > firstBracket) {
        raw = raw.slice(firstBracket, lastBracket + 1);
      }

      // 2) Normalisasi karakter kutip (smart quotes) dan whitespace
      raw = raw
        .replace(/[\u201C\u201D]/g, '"')
        .replace(/[\u2018\u2019]/g, "'")
        .replace(/\r\n/g, '\n');

      // 3) Repair ringan: hapus trailing comma sebelum ']' atau '}'
      //    (LLM sering nambah koma terakhir)
      raw = raw.replace(/,\s*([\]}])/g, '$1');

      // 4) Validasi awal
      if(!raw.trim().startsWith('[')) throw new Error('Bukan JSON Array');

      dataList = JSON.parse(raw);

      // Normalisasi agar tabel selalu terisi meski Gemini hanya mengisi kolom standar
      dataList = (dataList || []).map((d)=> {
        d = d || {};
        const get = (keys, fb="") => {
          for (const k of keys){
            if(d[k] !== undefined && d[k] !== null && String(d[k]).trim() !== "") return d[k];
          }
          return fb;
        };
        d.col_skl = get(['col_skl','SKL','skl'], d.col_skl || '');
        d.col_ki  = get(['col_ki','KI','ki'], d.col_ki || '');
        d.col1    = get(['col1','Materi Pembelajaran','materi_pembelajaran','materi'], d.col1 || '');
        d.col2    = get(['col2','KD','kd','deskripsi'], d.col2 || '');
        d.col3    = get(['col3','IPK','ipk','detail_tp'], d.col3 || '');
        d.col7    = get(['col7','Kegiatan Pembelajaran','kegiatan_pembelajaran'], d.col7 || '');
        d.col8    = get(['col8','Rencana Penilaian','rencana_penilaian'], d.col8 || '');
        d.col_sumber = get(['col_sumber','sumber_belajar','Sumber Belajar','sumber'], d.col_sumber || '');

        // KM-only fields
        d.col_kko = get(['col_kko','kko','KKO','kata_kerja_operasional'], d.col_kko || '');
        d.col_katakunci = get(['col_katakunci','kata_kunci','katakunci','glosarium','Glosarium'], d.col_katakunci || '');

        // K13-only fields
        d.col_kompleksitas = get(['col_kompleksitas','kompleksitas'], d.col_kompleksitas || '');
        d.col_daya_dukung  = get(['col_daya_dukung','daya_dukung','dayadukung'], d.col_daya_dukung || '');
        d.col_intake       = get(['col_intake','intake'], d.col_intake || '');

        
        d.col_kompleksitas = toNum0100(d.col_kompleksitas, 'kompleksitas');
        d.col_daya_dukung  = toNum0100(d.col_daya_dukung, 'daya_dukung');
        d.col_intake       = toNum0100(d.col_intake, 'intake');
        // K13: sinkron otomatis KKM <-> 3 aspek (opsi B)
        // - Jika 3 aspek terisi: KKM dipaksa = rata-rata
        // - Jika KKM terisi tapi aspek kosong: aspek diisi = KKM
        // Catatan: sinkronisasi final dilakukan setelah d.col4 dinormalisasi numerik di bawah.
        // KKM/KKTP wajib numerik: ambil angka pertama jika ada teks tambahan
        let kkm = get(['col4','KKM/KKTP','kkm','kktp','detail_kktp'], d.col4 || '');
        const num = String(kkm).match(/(\d+(\.\d+)?)/);
        d.col4 = num ? num[1] : String(kkm).trim();

        // Sinkronisasi (K13) ‚Äî pastikan rata-rata 3 aspek = KKM (opsi B)
        if (!isMerdeka){
          const k = toNum0100(d.col_kompleksitas, 'kompleksitas');
          const dd = toNum0100(d.col_daya_dukung, 'daya_dukung');
          const it = toNum0100(d.col_intake, 'intake');
          const kkmN = toNum0100(d.col4, 'kkm');

          const hasAspek = (k !== '' && dd !== '' && it !== '');
          const hasKKM = (kkmN !== '');

          if (hasAspek){
            // Paksa KKM dari rata-rata aspek
            const avg = Math.round((Number(k)+Number(dd)+Number(it))/3);
            d.col_kompleksitas = String(k);
            d.col_daya_dukung  = String(dd);
            d.col_intake       = String(it);
            d.col4 = String(_clamp0100(avg));
          } else if (hasKKM){
            // Jika aspek kosong, isi semua = KKM
            d.col_kompleksitas = String(kkmN);
            d.col_daya_dukung  = String(kkmN);
            d.col_intake       = String(kkmN);
            d.col4 = String(kkmN);
          }
        }

        // Semester wajib 1 atau 2
        let sem = get(['col5','semester'], d.col5 || '1');
        sem = String(sem).trim();
        if (sem !== '1' && sem !== '2') sem = '1';
        d.col5 = sem;

        // JP
        d.col6 = String(get(['col6','alokasi_jp'], d.col6 || '2')).trim() || '2';

        return d;
      });

      render();
      enableSaveBtn();

    }catch(e){
      Swal.fire({
        icon:'error',
        title:'Format Salah',
        html:'Pastikan yang ditempel adalah <b>JSON Array</b> valid dari Gemini.<br><br>'
          + '<b>Tips:</b> minta Gemini output <b>JSON murni</b> (tanpa teks tambahan & tanpa markdown).<br>'
          + 'Jika Gemini menambahkan penjelasan, pastikan kamu hanya menempel bagian yang dimulai dengan <code>[</code> dan diakhiri <code>]</code>.'
      });
      console.error(e);
    }
  }


  function _getField(d, keys, fallback="") {
    for (const k of keys) {
      if (d && d[k] !== undefined && d[k] !== null && String(d[k]).trim() !== "") return d[k];
    }
    return fallback;
  }

  function render(){
    document.getElementById('resultArea').classList.remove('hidden');
    const kur = (profile.jenis_kurikulum || '').toString().toLowerCase();
    const isMerdeka = (kur === 'km') || kur.includes('merdeka');
    const b = document.getElementById('tableBody');
    b.innerHTML = '';

    dataList.forEach((d,i)=>{
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50 group transition align-top';

      const createCell = (text, key, cls='') => {
        const td = document.createElement('td');
        td.className = `p-3 border-b border-slate-100 outline-none focus:bg-blue-50 focus:ring-1 focus:ring-blue-300 ${cls}`;
        td.contentEditable = 'true';
        td.textContent = text ?? '';
        td.addEventListener('blur', () => {
            if (key === 'col_kompleksitas') {
              const v = toNum0100(td.innerText, 'kompleksitas');
              td.innerText = (v === '' ? '' : String(v));
              dataList[i][key] = td.innerText;
              syncKKMRow(i, 'from_aspek');
              render();
              return;
            }
            if (key === 'col_daya_dukung') {
              const v = toNum0100(td.innerText, 'daya_dukung');
              td.innerText = (v === '' ? '' : String(v));
              dataList[i][key] = td.innerText;
              syncKKMRow(i, 'from_aspek');
              render();
              return;
            }
            if (key === 'col_intake') {
              const v = toNum0100(td.innerText, 'intake');
              td.innerText = (v === '' ? '' : String(v));
              dataList[i][key] = td.innerText;
              // update KKM agar = rata-rata 3 aspek
              syncKKMRow(i, 'from_aspek');
              render();
              return;
            }
            // K13: bila KKM diedit, sesuaikan 3 aspek agar rata-rata = KKM
            if (key === 'col4' && !isMerdeka) {
              const v = toNum0100(td.innerText, 'kkm');
              td.innerText = (v === '' ? '' : String(v));
              dataList[i][key] = td.innerText;
              syncKKMRow(i, 'from_kkm');
              render();
              return;
            }
            dataList[i][key] = td.innerText;
          });
        return td;
      }

      tr.append(
          createCell(d.col_skl || '', 'col_skl', 'text-[10px] text-slate-500 leading-tight border-r border-slate-100'),
          createCell(d.col_ki || '', 'col_ki', 'text-[10px] text-slate-500 leading-tight border-r border-slate-100'),
          createCell(d.col1 || '', 'col1', 'text-xs font-medium border-r border-slate-100'),
          createCell(d.col2 || '', 'col2', 'text-[10px] text-slate-500 leading-tight border-r border-slate-100'),
          createCell(d.col3 || '', 'col3', 'text-xs font-medium border-r border-slate-100'),

          // KM-only
          ...(isMerdeka ? [
            createCell(d.col_kko || '', 'col_kko', 'text-xs font-medium border-r border-slate-100'),
            createCell(d.col_katakunci || '', 'col_katakunci', 'text-xs font-medium border-r border-slate-100 whitespace-pre-wrap')
          ] : []),

          createCell(d.col7 || '', 'col7', 'text-xs font-medium border-r border-slate-100 whitespace-pre-wrap'),
          createCell(d.col8 || '', 'col8', 'text-xs font-medium border-r border-slate-100 whitespace-pre-wrap'),
          createCell(d.col_sumber || '', 'col_sumber', 'text-xs font-medium border-r border-slate-100 whitespace-pre-wrap'),

          // K13-only
          ...(!isMerdeka ? [
            createCell(d.col_kompleksitas || '', 'col_kompleksitas', 'text-xs text-center font-medium border-r border-slate-100'),
            createCell(d.col_daya_dukung || '', 'col_daya_dukung', 'text-xs text-center font-medium border-r border-slate-100'),
            createCell(d.col_intake || '', 'col_intake', 'text-xs text-center font-medium border-r border-slate-100')
          ] : []),

          createCell(d.col4 || '', 'col4', 'text-xs text-center font-medium border-r border-slate-100'),
          createCell(d.col5 || '1', 'col5', 'text-xs text-center font-medium border-r border-slate-100'),
          createCell(d.col6 || '2', 'col6', 'text-xs text-center font-medium border-r border-slate-100')
      );

      const tdDel = document.createElement('td');
      tdDel.className = 'p-2 text-xs text-center font-medium border-r border-slate-100';

      const btnWrap = document.createElement('div');
      btnWrap.className = 'flex items-center justify-center gap-2';
      const del = document.createElement('button');
      del.className = 'text-slate-300 hover:text-red-500 font-bold transition px-2 py-1 hover:bg-red-50 rounded';
      del.innerHTML = 'Hapus';
      del.addEventListener('click', () => { dataList.splice(i,1); render(); });

      btnWrap.appendChild(del);
      tdDel.appendChild(btnWrap);

      tr.appendChild(tdDel);
      b.appendChild(tr);
    });
  }

  function addRow(){ 
    dataList.push({col_skl:"SKL", col_ki:"KI-3", col1:"Materi", col2:"KD 3.1", col3:"IPK (KKO)", col7:"Kegiatan", col8:"Penilaian", col4:"75", col5:"1", col6:"2"}); 
    render(); enableSaveBtn(); 
  }

  async function save(){
    const btn=document.getElementById('btnSave'); btn.innerHTML="‚è≥ Menyimpan..."; btn.disabled=true;
    
    // Mapping ke DB (Tambahkan field 'ki')
    const content = dataList.map(d => ({
        // Versi standar (untuk Buku Kerja)
        skl: d.SKL ?? d.skl ?? d.col_skl ?? '',
        ki_text: d.KI ?? d.col_ki ?? d.ki ?? '',
        kd: d.KD ?? d.col2 ?? d.deskripsi ?? '',
        ipk: d.IPK ?? d.col3 ?? d.detail_tp ?? '',
        materi_pembelajaran: d["Materi Pembelajaran"] ?? d.col1 ?? d.elemen ?? '',
        kegiatan_pembelajaran: d["Kegiatan Pembelajaran"] ?? d.kegiatan_pembelajaran ?? d.col7 ?? '',
        rencana_penilaian: d["Rencana Penilaian"] ?? d.rencana_penilaian ?? d.col8 ?? '',
        sumber_belajar: d.col_sumber ?? d.sumber_belajar ?? '',
        kko: d.col_kko ?? d.kko ?? '',
        kata_kunci: d.col_katakunci ?? d.kata_kunci ?? d.col_katakunci ?? '',
        kompleksitas: (toNum0100(d.col_kompleksitas ?? d.kompleksitas ?? '', 'kompleksitas') || ''),
        daya_dukung: (toNum0100(d.col_daya_dukung ?? d.daya_dukung ?? '', 'daya_dukung') || ''),
        intake: (toNum0100(d.col_intake ?? d.intake ?? '', 'intake') || ''),

        // Versi lama (agar kompatibel dengan step lain yang sudah ada)
        ki: d.col_ki ?? d.KI ?? '',
        elemen: d.col1 ?? d["Materi Pembelajaran"] ?? '',
        deskripsi: d.col2 ?? d.KD ?? '',
        detail_tp: d.col3 ?? d.IPK ?? '',
        detail_kktp: d.col4 ?? '',
        sumber_belajar: d.col_sumber ?? '',
        kko: d.col_kko ?? '',
        kata_kunci: d.col_katakunci ?? '',
        kompleksitas: (toNum0100(d.col_kompleksitas ?? '', 'kompleksitas') || ''),
        daya_dukung: (toNum0100(d.col_daya_dukung ?? '', 'daya_dukung') || ''),
        intake: (toNum0100(d.col_intake ?? '', 'intake') || ''),
        semester: d.col5 ?? '1',
        alokasi_jp: d.col6 ?? '2'
    }));
    
    const payload = {
      user_id: user.id, doc_type: 'master_cp_atp',
      subject_name: profile.mata_pelajaran, grade_level: profile.fase_kelas, curriculum_type: profile.jenis_kurikulum,
      content_data: content, status: 'confirmed'
    };
    
    const {error} = await db.from('work_drafts').upsert(payload, {onConflict:'user_id,doc_type'});
    if(error){ 
        Swal.fire('Gagal', error.message, 'error');
        btn.innerHTML = '<span>üíæ</span> Simpan & Lanjut (Kalender) ‚Üí'; btn.disabled = false;
    } else {
        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
        Toast.fire({icon: 'success', title: 'Data Tersimpan!'});
        setTimeout(()=> window.location.href='step3_kalender.html', 1500);
    }
  }

  async function deleteDraft(){
    const res = await Swal.fire({title: 'Hapus Data?', text:'Tabel analisis akan dikosongkan.', icon: 'warning', showCancelButton: true});
    if(res.isConfirmed){
        await db.from('work_drafts').delete().eq('user_id', user.id).eq('doc_type', 'master_cp_atp');
        location.reload();
    }
  }
</script>
</body>
</html>