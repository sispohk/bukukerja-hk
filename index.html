<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUKU KERJA PONTREN HK — BK1 (HTML)</title>
  <style>
    :root {
      --bg: #0b1220;
      --card2: #0f1729;
      --text: #e9eefc;
      --muted: #9fb0d0;
      --line: rgba(255,255,255,.08);
      --good: #38d39f;
      --warn: #ffcc66;
      --bad: #ff6b6b;
      --btn: #2a3a62;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: var(--sans); color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(138,180,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(56,211,159,.12), transparent 55%),
                  var(--bg);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; }
    header {
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding: 14px 16px; border: 1px solid var(--line); border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .brand { display:flex; flex-direction:column; gap:4px; }
    .brand h1 { margin:0; font-size: 16px; letter-spacing:.3px; }
    .brand .sub { font-size:12px; color: var(--muted); }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); border-radius: 999px;
      font-size: 12px; color: var(--muted);
    }
    .grid { display:grid; gap: 14px; margin-top: 14px; }
    .cols { grid-template-columns: 360px 1fr; }
    @media (max-width: 980px){ .cols { grid-template-columns: 1fr; } }

    .card {
      border:1px solid var(--line); border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd {
      padding: 12px 14px; border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.15);
    }
    .card .hd h2 { margin:0; font-size: 13px; color: var(--text); }
    .card .bd { padding: 14px; }

    .muted { color: var(--muted); }
    .mono { font-family: var(--mono); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom: 10px; }
    .field label { font-size: 12px; color: var(--muted); }

    input, textarea, select {
      width:100%; padding: 10px 11px; border-radius: 11px;
      border: 1px solid var(--line); background: var(--card2); color: var(--text);
      outline: none; font-size: 13px;
    }
    textarea { min-height: 92px; resize: vertical; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); vertical-align: top; }
    th { text-align:left; font-size: 12px; color: var(--muted); font-weight: 600; }
    td { font-size: 13px; }

    .btn {
      border:1px solid var(--line); background: var(--btn);
      color: var(--text); padding: 9px 11px; border-radius: 10px;
      cursor:pointer; font-size: 12px;
    }
    .btn:hover { background: #314372; }
    .btn.ghost { background: transparent; }
    .btn.small { padding: 7px 9px; border-radius: 9px; }
    .btn.good { background: rgba(56,211,159,.16); border-color: rgba(56,211,159,.32); }
    .btn.good:hover { background: rgba(56,211,159,.24); }
    .btn.warn { background: rgba(255,204,102,.12); border-color: rgba(255,204,102,.28); }
    .btn.warn:hover { background: rgba(255,204,102,.18); }
    .btn.danger { background: rgba(255,107,107,.16); border-color: rgba(255,107,107,.32); }
    .btn.danger:hover { background: rgba(255,107,107,.24); }

    .tag {
      display:inline-flex; align-items:center; gap:6px;
      padding: 5px 8px; border-radius: 999px; font-size: 11px;
      border:1px solid var(--line); background: rgba(255,255,255,.03); color: var(--muted);
    }
    .tag.good { color: var(--good); border-color: rgba(56,211,159,.28); background: rgba(56,211,159,.12); }
    .tag.warn { color: var(--warn); border-color: rgba(255,204,102,.28); background: rgba(255,204,102,.10); }
    .tag.bad { color: var(--bad); border-color: rgba(255,107,107,.28); background: rgba(255,107,107,.10); }

    .nav { display:flex; gap:8px; flex-wrap:wrap; }
    .nav .btn.active { outline: 2px solid rgba(138,180,255,.45); }

    .hr { height:1px; background: var(--line); margin: 12px 0; }
    .notice {
      padding: 10px 12px; border-radius: 12px; border:1px solid var(--line);
      background: rgba(138,180,255,.08); color: var(--text); font-size: 12px;
    }
    .err {
      padding: 10px 12px; border-radius: 12px; border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.12); color: var(--text); font-size: 12px;
    }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index: 9998; padding: 18px; }
    .modal{ width:min(860px, 100%); border:1px solid var(--line); border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); box-shadow: var(--shadow); overflow:hidden; }
    .modal .hd{ padding: 12px 14px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; gap:10px; }
    .modal .bd{ padding: 14px; max-height: 70vh; overflow:auto; }
    .modal .ft{ padding: 12px 14px; border-top: 1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; }

    /* PRINT */
    .print-area{ display:none; }
    @media print{
      body{ background:#fff !important; }
      header, .grid, .modal-backdrop { display:none !important; }
      .print-area{ display:block !important; color:#000; font-family: Arial, "Noto Sans", sans-serif; }
      .page{ page-break-after: always; padding: 12mm 12mm; }
      .page:last-child{ page-break-after: auto; }
      .p-title{ text-align:center; font-weight:700; font-size: 14pt; margin: 0 0 2mm; }
      .p-sub{ text-align:center; font-size: 10.5pt; margin:0 0 6mm; }
      .p-h2{ font-weight:700; font-size: 12pt; margin: 0 0 3mm; }
      .p-meta{ font-size: 10pt; margin:0 0 2mm; }
      .p-box{ border:1px solid #000; padding: 3mm; margin: 0 0 4mm; }
      .p-h3{ font-weight:700; margin:0 0 2mm; }
      .p-table{ width:100%; border-collapse: collapse; font-size: 9.5pt; }
      .p-table th,.p-table td{ border:1px solid #000; padding: 2mm; vertical-align: top; }
      .p-table th{ font-weight:700; background:#f2f2f2; }
      .small{ font-size: 9pt; }
      .sign-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10mm; margin-top: 10mm; }
      .sign{ border:1px solid #000; padding: 4mm; min-height: 42mm; }
      .sign .lbl{ font-size: 9.5pt; margin-bottom: 2mm; }
      .sign .name{ margin-top: 28mm; font-size: 10pt; font-weight:700; }
      .sign .role{ font-size: 9.5pt; }
      .cover-box{ border:1px solid #000; padding: 10mm; margin-top: 18mm; }
      .cover-line{ margin: 6mm 0; font-size: 11pt; }
      .center{ text-align:center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>BUKU KERJA PONTREN HK — <span class="muted">Buku 1 (HTML)</span></h1>
        <div class="sub">Tanpa Auth • Supabase REST • Export multi-halaman (Cover + Pengesahan)</div>
      </div>
      <div class="row">
        <span class="pill">Status: <span id="statusPill" class="mono">idle</span></span>
        <button class="btn ghost" id="btnReset">Reset pilihan</button>
      </div>
    </header>

    <div class="grid cols">
      <section class="card">
        <div class="hd">
          <h2>Konfigurasi Supabase</h2>
          <span class="tag warn">wajib</span>
        </div>
        <div class="bd">
          <div class="notice">Isi <span class="mono">SUPABASE_URL</span> dan <span class="mono">SUPABASE_ANON_KEY</span>. MVP internal (tanpa login).</div>
          <div class="hr"></div>

          <div class="field"><label>SUPABASE_URL</label><input id="sbUrl" placeholder="https://xxxx.supabase.co" /></div>
          <div class="field"><label>SUPABASE_ANON_KEY</label><input id="sbKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." /></div>

          <div class="row">
            <button class="btn good" id="btnConnect">Connect</button>
            <button class="btn" id="btnLoadAssignments">Load Assignments</button>
          </div>

          <div class="hr"></div>
          <div id="connMsg"></div>

          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0; font-size:13px;">Teaching Assignment</h3>
            <span class="tag" id="assignCount">0</span>
          </div>

          <div style="margin-top:10px; max-height: 420px; overflow:auto;">
            <table>
              <thead><tr><th>Mapel</th><th>Kelas</th><th style="text-align:right;">Aksi</th></tr></thead>
              <tbody id="assignmentTbody"><tr><td colspan="3" class="muted">Belum dimuat.</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2 id="mainTitle">Pilih assignment dulu</h2>
          <div class="nav" id="navBtns" style="display:none;">
            <button class="btn small active" data-view="dash">Dashboard</button>
            <button class="btn small" data-view="week">Minggu Efektif</button>
            <button class="btn small" data-view="prota">Prota</button>
            <button class="btn small" data-view="promes">Promes</button>
            <button class="btn small" data-view="atp">ATP</button>
            <button class="btn small" data-view="mastery">KKM/KKTP</button>
            <button class="btn small" data-view="resources">Sumber/Media</button>
            <button class="btn small" data-view="lesson">Modul Ajar</button>
            <button class="btn small" data-view="attachments">Lampiran</button>
            <button class="btn small" data-view="calendar">Kalender</button>
            <button class="btn small" data-view="sk">SK/Beban</button>
            <button class="btn small" data-view="mapping">Pemetaan</button>
            <button class="btn small" data-view="model">Model/Metode</button>
            <button class="btn small" data-view="export">Export BK1</button>
          </div>
        </div>
        <div class="bd" id="mainBody">
          <div class="notice">Alur cepat: Connect → Load Assignments → Pilih → isi data → Export (multi-halaman).</div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="hd">
        <div>
          <div style="font-weight:700; font-size:13px;">Editor Modul Ajar / RPP</div>
          <div class="muted" style="font-size:12px;" id="lpModalSub"></div>
        </div>
        <button class="btn small" id="btnCloseModal">Tutup</button>
      </div>
      <div class="bd" id="modalBody"></div>
      <div class="ft">
        <button class="btn danger" id="btnDeleteLP">Hapus</button>
        <button class="btn good" id="btnSaveLP">Simpan</button>
      </div>
    </div>
  </div>

  <div class="print-area" id="printArea"></div>

<script>
  // NOTE: Kode JS dipadatkan di file ini (tidak ditampilkan di chat versi ZIP). 
  // Tujuan: menjaga performa dan tetap satu-file.

  let SUPABASE_URL = "";
  let SUPABASE_KEY = "";
  let assignments = [];
  let active = null;
  let view = "dash";
  let toastEl = null;
  let currentLP = null;

  function setStatus(txt){ document.getElementById("statusPill").textContent = txt; }
  function saveConfig(){ localStorage.setItem("BKHK_SB_URL", SUPABASE_URL); localStorage.setItem("BKHK_SB_KEY", SUPABASE_KEY); }
  function loadConfig(){
    SUPABASE_URL = localStorage.getItem("BKHK_SB_URL") || "";
    SUPABASE_KEY = localStorage.getItem("BKHK_SB_KEY") || "";
    document.getElementById("sbUrl").value = SUPABASE_URL;
    document.getElementById("sbKey").value = SUPABASE_KEY;
  }
  loadConfig();

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function el(html){ const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstChild; }

  function showToast(text, isError=false){
    if(toastEl) toastEl.remove();
    toastEl = el(`<div style="position:fixed; left:50%; bottom:18px; transform:translateX(-50%); padding:10px 12px; border-radius: 12px; border:1px solid ${isError ? "rgba(255,107,107,.45)" : "rgba(56,211,159,.45)"}; background:${isError ? "rgba(255,107,107,.14)" : "rgba(56,211,159,.12)"}; box-shadow: var(--shadow); z-index:9999; font-size:12px;">${escapeHtml(text)}</div>`);
    document.body.appendChild(toastEl);
    setTimeout(()=>{ if(toastEl){ toastEl.remove(); toastEl=null; } }, 2400);
  }

  function msgBox(kind, text){
    const cls = kind === "err" ? "err" : "notice";
    return `<div class="${cls}">${text}</div>`;
  }
  function showConnMessage(kind, text){ document.getElementById("connMsg").innerHTML = msgBox(kind, escapeHtml(text)); }

  function restUrl(path){ return SUPABASE_URL.replace(/\/+$/, "") + "/rest/v1/" + path.replace(/^\/+/, ""); }

  async function sbFetch(path, { method="GET", params=null, body=null, prefer=null } = {}){
    if(!SUPABASE_URL || !SUPABASE_KEY) throw new Error("Config belum lengkap.");
    let url = restUrl(path);
    if(params){ const qs=new URLSearchParams(params); url += (url.includes("?")?"&":"?") + qs.toString(); }
    const headers = {
      "apikey": SUPABASE_KEY,
      "Authorization": "Bearer " + SUPABASE_KEY,
      "Content-Type": "application/json"
    };
    if(prefer) headers["Prefer"] = prefer;

    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    if(!res.ok){
      const msg = typeof data === "string" ? data : (data?.message || JSON.stringify(data));
      throw new Error(`HTTP ${res.status} — ${msg}`);
    }
    return data;
  }

  async function loadAssignments(){
    setStatus("loading assignments...");
    const data = await sbFetch("teaching_assignment", {
      params: {
        select: "id,jp_per_pekan,catatan,academic_term:academic_term_id(id,tahun_ajaran,semester),teacher:teacher_id(id,nama,unit),subject:subject_id(id,nama,kurikulum),class_group:class_group_id(id,jenjang,kelas,rombel,label)",
        order: "id.desc"
      }
    });
    assignments = data || [];
    renderAssignments();
    setStatus("ready");
  }

  function renderAssignments(){
    const tb = document.getElementById("assignmentTbody");
    document.getElementById("assignCount").textContent = assignments.length;
    if(!assignments.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">Tidak ada data. Pastikan sudah seed teaching_assignment.</td></tr>`;
      return;
    }
    tb.innerHTML = "";
    assignments.forEach(a=>{
      const tr = el(`
        <tr>
          <td>
            <div><b>${escapeHtml(a.subject?.nama ?? "-")}</b></div>
            <div class="muted" style="font-size:12px;">${escapeHtml(a.teacher?.nama ?? "-")} • ${escapeHtml(a.academic_term?.tahun_ajaran ?? "")} ${escapeHtml(a.academic_term?.semester ?? "")}</div>
          </td>
          <td>
            <div><b>${escapeHtml(a.class_group?.jenjang ?? "")} ${escapeHtml(a.class_group?.label ?? "")}</b></div>
            <div class="muted" style="font-size:12px;">JP/pekan: ${escapeHtml(a.jp_per_pekan ?? "-")}</div>
          </td>
          <td style="text-align:right;"><button class="btn small good">Pilih</button></td>
        </tr>
      `);
      tr.querySelector("button").onclick = ()=>selectAssignment(a);
      tb.appendChild(tr);
    });
  }

  function setActiveNav(){
    document.querySelectorAll("#navBtns .btn").forEach(b=> b.classList.toggle("active", b.dataset.view === view));
  }

  function selectAssignment(a){
    active = a;
    view = "dash";
    document.getElementById("navBtns").style.display = "flex";
    document.getElementById("mainTitle").textContent = `${a.subject?.nama ?? "Mapel"} — ${a.class_group?.jenjang ?? ""} ${a.class_group?.label ?? ""} (${a.academic_term?.tahun_ajaran ?? ""} ${a.academic_term?.semester ?? ""})`;
    renderMain();
  }

  async function getSingleRow(table, assignmentId){
    const rows = await sbFetch(table, { params: { select: "*", teaching_assignment_id: `eq.${assignmentId}`, limit: "1" } });
    return (rows && rows[0]) ? rows[0] : null;
  }

  async function ensureHeader(table){
    const existing = await getSingleRow(table, active.id);
    if(existing) return existing;
    const inserted = await sbFetch(table, { method: "POST", prefer: "return=representation", body: { teaching_assignment_id: active.id, deskripsi: null, status: "DRAFT" } });
    return inserted?.[0] || null;
  }

  async function ensureWeekPlan(){
    const existing = await getSingleRow("bk1_effective_week_plan", active.id);
    if(existing) return existing;
    const inserted = await sbFetch("bk1_effective_week_plan", { method:"POST", prefer:"return=representation", body: { teaching_assignment_id: active.id, total_minggu: null, minggu_efektif: null, catatan: null, status: "DRAFT" } });
    return inserted?.[0] || null;
  }

  async function updateById(table, id, patch){
    await sbFetch(table, { method:"PATCH", prefer:"return=minimal", params: { id: `eq.${id}` }, body: patch });
  }
  async function deleteById(table, id){
    await sbFetch(table, { method:"DELETE", prefer:"return=minimal", params: { id: `eq.${id}` } });
  }

  function renderStatusTag(st){
    if(st === "APPROVED") return `<span class="tag good">APPROVED</span>`;
    if(st === "REVIEW") return `<span class="tag warn">REVIEW</span>`;
    return `<span class="tag">DRAFT</span>`;
  }

  async function renderDashboard(){
    setStatus("loading dashboard...");
    const id = active.id;
    const [week, prota, promes, atp, mastery, resources] = await Promise.all([
      getSingleRow("bk1_effective_week_plan", id),
      getSingleRow("bk1_prota", id),
      getSingleRow("bk1_promes", id),
      getSingleRow("bk1_atp", id),
      getSingleRow("bk1_mastery_criteria", id),
      sbFetch("bk1_resource", { params: { select: "id,tipe,judul,url", teaching_assignment_id: `eq.${id}`, order: "created_at.desc", limit: "200" } })
    ]);

    const badge = (obj)=>{
      if(!obj) return `<span class="tag bad">Belum ada</span>`;
      const st = obj.status || "DRAFT";
      if(st === "APPROVED") return `<span class="tag good">APPROVED</span>`;
      if(st === "REVIEW") return `<span class="tag warn">REVIEW</span>`;
      return `<span class="tag">DRAFT</span>`;
    };

    document.getElementById("mainBody").innerHTML = `
      <div class="notice">Dashboard cek keberadaan + status header. Isi detail ada di tab masing-masing.</div>
      <div class="hr"></div>
      <table>
        <thead><tr><th>Komponen</th><th>Status</th><th style="text-align:right;">Aksi cepat</th></tr></thead>
        <tbody>
          <tr><td><b>Minggu Efektif</b></td><td>${badge(week)}</td><td style="text-align:right;"><button class="btn small" id="goWeek">Kelola</button></td></tr>
          <tr><td><b>Prota</b></td><td>${badge(prota)}</td><td style="text-align:right;"><button class="btn small" id="goProta">Kelola</button></td></tr>
          <tr><td><b>Promes</b></td><td>${badge(promes)}</td><td style="text-align:right;"><button class="btn small" id="goPromes">Kelola</button></td></tr>
          <tr><td><b>ATP</b></td><td>${badge(atp)}</td><td style="text-align:right;"><button class="btn small" id="goATP">Kelola</button></td></tr>
          <tr><td><b>KKM/KKTP</b></td><td>${badge(mastery)}</td><td style="text-align:right;"><button class="btn small" id="goMastery">Kelola</button></td></tr>
          <tr><td><b>Sumber/Media</b></td><td><span class="tag">${(resources||[]).length} item</span></td><td style="text-align:right;"><button class="btn small" id="goResources">Kelola</button></td></tr>
          <tr><td><b>Modul Ajar</b></td><td><span class="tag">—</span></td><td style="text-align:right;"><button class="btn small" id="goLesson">Kelola</button></td></tr>
          <tr><td><b>Export</b></td><td><span class="tag">multi-page</span></td><td style="text-align:right;"><button class="btn small" id="goExport">Buka</button></td></tr>
        </tbody>
      </table>
    `;
    document.getElementById("goWeek").onclick = ()=>{ view="week"; renderMain(); };
    document.getElementById("goProta").onclick = ()=>{ view="prota"; renderMain(); };
    document.getElementById("goPromes").onclick = ()=>{ view="promes"; renderMain(); };
    document.getElementById("goATP").onclick = ()=>{ view="atp"; renderMain(); };
    document.getElementById("goMastery").onclick = ()=>{ view="mastery"; renderMain(); };
    document.getElementById("goResources").onclick = ()=>{ view="resources"; renderMain(); };
    document.getElementById("goLesson").onclick = ()=>{ view="lesson"; renderMain(); };
    document.getElementById("goExport").onclick = ()=>{ view="export"; renderMain(); };
    setStatus("ready");
  }

  async function renderWeek(){
    setStatus("loading week...");
    const plan = await ensureWeekPlan();
    const details = await sbFetch("bk1_effective_week_detail", { params: { select:"*", week_plan_id: `eq.${plan.id}`, order:"minggu_ke.asc" } });
    setStatus("ready");

    document.getElementById("mainBody").innerHTML = `
      <div class="notice">Tip: tombol <b>Generate Minggu</b> akan menghapus detail lama lalu membuat minggu 1..N.</div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;">
        <div style="flex:1;">
          <div class="field"><label>Total Minggu</label><input id="wkTotal" type="number" value="${plan.total_minggu ?? ""}" placeholder="mis. 18" /></div>
          <div class="field"><label>Minggu Efektif</label><input id="wkEff" type="number" value="${plan.minggu_efektif ?? ""}" placeholder="mis. 16" /></div>
        </div>
        <div style="flex:1;">
          <div class="field"><label>Status</label>
            <select id="wkStatus">
              <option value="DRAFT">DRAFT</option>
              <option value="REVIEW">REVIEW</option>
              <option value="APPROVED">APPROVED</option>
            </select>
          </div>
          <div class="field"><label>Catatan</label><textarea id="wkNote">${escapeHtml(plan.catatan ?? "")}</textarea></div>
          <div class="row">
            <button class="btn good" id="btnSaveWeek">Simpan Plan</button>
            <button class="btn" id="btnReloadWeek">Reload</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="row"><b>Detail Minggu</b> <span class="tag">${(details||[]).length} baris</span></div>
        <div class="row">
          <button class="btn small warn" id="btnGenWeeks">Generate Minggu 1..N</button>
          <button class="btn small" id="btnAddWeekRow">Tambah Baris</button>
        </div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:70px;">Minggu</th><th style="width:140px;">Mulai</th><th style="width:140px;">Selesai</th><th style="width:130px;">Kategori</th><th>Keterangan</th><th style="text-align:right; width:160px;">Aksi</th></tr></thead>
          <tbody id="wkTbody">
            ${(details||[]).map(d=>`
              <tr data-id="${d.id}">
                <td><input data-k="minggu_ke" type="number" value="${d.minggu_ke}" /></td>
                <td><input data-k="start_date" type="date" value="${d.start_date ?? ""}" /></td>
                <td><input data-k="end_date" type="date" value="${d.end_date ?? ""}" /></td>
                <td>
                  <select data-k="kategori">
                    ${["EFEKTIF","LIBUR","UJIAN","KEGIATAN"].map(k=>`<option value="${k}" ${d.kategori===k?"selected":""}>${k}</option>`).join("")}
                  </select>
                </td>
                <td><input data-k="keterangan" value="${escapeHtml(d.keterangan ?? "")}" /></td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="save">Simpan</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="6" class="muted">Belum ada detail minggu.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;

    document.getElementById("wkStatus").value = plan.status || "DRAFT";

    document.getElementById("btnSaveWeek").onclick = async ()=>{
      try{
        setStatus("saving...");
        const total = parseInt(document.getElementById("wkTotal").value, 10);
        const eff = parseInt(document.getElementById("wkEff").value, 10);
        await updateById("bk1_effective_week_plan", plan.id, {
          total_minggu: Number.isFinite(total) ? total : null,
          minggu_efektif: Number.isFinite(eff) ? eff : null,
          status: document.getElementById("wkStatus").value,
          catatan: document.getElementById("wkNote").value.trim() || null
        });
        showToast("Plan minggu efektif tersimpan.");
        setStatus("ready");
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };
    document.getElementById("btnReloadWeek").onclick = ()=>renderMain();

    document.getElementById("btnAddWeekRow").onclick = async ()=>{
      try{
        const next = (details?.length ? Math.max(...details.map(x=>x.minggu_ke)) : 0) + 1;
        setStatus("saving...");
        await sbFetch("bk1_effective_week_detail", { method:"POST", prefer:"return=minimal", body: { week_plan_id: plan.id, minggu_ke: next, start_date: null, end_date: null, kategori: "EFEKTIF", keterangan: null } });
        showToast("Baris ditambahkan.");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.getElementById("btnGenWeeks").onclick = async ()=>{
      try{
        const N = parseInt(document.getElementById("wkTotal").value, 10);
        if(!Number.isFinite(N) || N <= 0) return showToast("Isi Total Minggu dulu (angka > 0).", true);
        if(!confirm(`Generate minggu 1..${N}? Ini akan menghapus detail minggu yang sudah ada.`)) return;

        setStatus("generating...");
        await sbFetch("bk1_effective_week_detail", { method:"DELETE", prefer:"return=minimal", params: { week_plan_id: `eq.${plan.id}` } });

        const payload=[];
        for(let i=1;i<=N;i++) payload.push({ week_plan_id: plan.id, minggu_ke:i, start_date:null, end_date:null, kategori:"EFEKTIF", keterangan:null });
        await sbFetch("bk1_effective_week_detail", { method:"POST", prefer:"return=minimal", body: payload });

        showToast("Minggu berhasil digenerate.");
        setStatus("ready");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.querySelectorAll("#wkTbody tr[data-id]").forEach(tr=>{
      const id = parseInt(tr.dataset.id, 10);
      tr.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.dataset.act;
            if(act === "del"){
              if(!confirm("Hapus baris minggu ini?")) return;
              setStatus("deleting...");
              await deleteById("bk1_effective_week_detail", id);
              showToast("Baris dihapus.");
              renderMain();
              return;
            }
            if(act === "save"){
              const patch = {};
              tr.querySelectorAll("[data-k]").forEach(inp=>{
                const k = inp.dataset.k;
                if(k === "minggu_ke") patch[k] = parseInt(inp.value, 10) || 0;
                else if(k === "kategori") patch[k] = inp.value;
                else if(k === "start_date" || k === "end_date") patch[k] = inp.value || null;
                else patch[k] = inp.value.trim() || null;
              });
              if(!patch.minggu_ke) return showToast("Minggu ke- wajib angka > 0.", true);
              setStatus("saving...");
              await updateById("bk1_effective_week_detail", id, patch);
              showToast("Baris tersimpan.");
              setStatus("ready");
            }
          }catch(e){ showToast(e.message, true); setStatus("error"); }
        };
      });
    });
  }

  // PROTA
  async function loadProta(){
    setStatus("loading prota...");
    const header = await ensureHeader("bk1_prota");
    const items = await sbFetch("bk1_prota_item", { params: { select:"*", prota_id: `eq.${header.id}`, order:"urutan.asc" } });
    setStatus("ready");
    return { header, items: items || [] };
  }
  async function addProtaItem(protaId, payload){ await sbFetch("bk1_prota_item", { method:"POST", prefer:"return=minimal", body: { prota_id: protaId, ...payload } }); }
  async function swapProtaOrder(items, idxA, idxB){
    const a=items[idxA], b=items[idxB]; if(!a||!b) return;
    await Promise.all([ updateById("bk1_prota_item", a.id, { urutan: b.urutan }), updateById("bk1_prota_item", b.id, { urutan: a.urutan }) ]);
  }
  async function renderProta(){
    const { header, items } = await loadProta();
    document.getElementById("mainBody").innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div style="flex:1;">
          <div class="field"><label>Deskripsi Prota</label><textarea id="protaDesc">${escapeHtml(header.deskripsi ?? "")}</textarea></div>
        </div>
        <div style="flex:1;">
          <div class="field"><label>Status</label>
            <select id="protaStatus"><option value="DRAFT">DRAFT</option><option value="REVIEW">REVIEW</option><option value="APPROVED">APPROVED</option></select>
          </div>
          <div class="row"><button class="btn good" id="saveProtaHeader">Simpan Header</button><button class="btn" id="btnReloadProta">Reload</button></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;"><div class="row"><b>Item Prota</b> <span class="tag">${items.length} baris</span></div></div>
      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:56px;">Urut</th><th>Topik</th><th style="width:90px;">JP</th><th>Integrasi HK</th><th style="text-align:right; width:210px;">Aksi</th></tr></thead>
          <tbody id="protaTbody">
            ${items.map((it, idx)=>`
              <tr data-id="${it.id}">
                <td><span class="mono">${it.urutan}</span></td>
                <td>
                  <input data-k="topik" value="${escapeHtml(it.topik)}" />
                  <div class="muted" style="font-size:12px; margin-top:6px;"><input data-k="catatan" placeholder="Catatan (opsional)" value="${escapeHtml(it.catatan ?? "")}" /></div>
                </td>
                <td><input data-k="alokasi_jp" type="number" value="${it.alokasi_jp ?? ""}" /></td>
                <td><input data-k="integrasi_hk" value="${escapeHtml(it.integrasi_hk ?? "")}" /></td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="save">Simpan</button>
                  <button class="btn small" data-act="up">↑</button>
                  <button class="btn small" data-act="down">↓</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="5" class="muted">Belum ada item.</td></tr>`}
          </tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="notice"><b>Tambah Item</b></div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:2;"><input id="newProtaTopik" placeholder="Topik" /></div>
        <div style="flex:1;"><input id="newProtaJP" type="number" placeholder="JP" /></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;"><input id="newProtaHK" placeholder="Integrasi HK (opsional)" /></div>
        <button class="btn good" id="btnAddProta">Tambah</button>
      </div>
    `;
    document.getElementById("protaStatus").value = header.status || "DRAFT";

    document.getElementById("saveProtaHeader").onclick = async ()=>{
      try{
        setStatus("saving...");
        await updateById("bk1_prota", header.id, {
          deskripsi: document.getElementById("protaDesc").value.trim() || null,
          status: document.getElementById("protaStatus").value
        });
        showToast("Header prota tersimpan.");
        setStatus("ready");
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };
    document.getElementById("btnReloadProta").onclick = ()=>renderMain();

    document.getElementById("btnAddProta").onclick = async ()=>{
      try{
        const topik = document.getElementById("newProtaTopik").value.trim();
        if(!topik) return showToast("Topik wajib diisi.", true);
        const jp = parseInt(document.getElementById("newProtaJP").value, 10);
        const hk = document.getElementById("newProtaHK").value.trim();
        const nextOrder = (items.length ? Math.max(...items.map(x=>x.urutan)) : 0) + 1;
        setStatus("saving...");
        await addProtaItem(header.id, { urutan: nextOrder, topik, alokasi_jp: Number.isFinite(jp) ? jp : null, integrasi_hk: hk || null });
        showToast("Item prota ditambahkan.");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.querySelectorAll("#protaTbody tr[data-id]").forEach((tr, idx)=>{
      const id = parseInt(tr.dataset.id, 10);
      tr.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.dataset.act;
            if(act === "del"){
              if(!confirm("Hapus item ini?")) return;
              setStatus("deleting...");
              await deleteById("bk1_prota_item", id);
              showToast("Item dihapus.");
              renderMain();
              return;
            }
            if(act === "up"){ if(idx===0) return; setStatus("reordering..."); await swapProtaOrder(items, idx, idx-1); renderMain(); return; }
            if(act === "down"){ if(idx===items.length-1) return; setStatus("reordering..."); await swapProtaOrder(items, idx, idx+1); renderMain(); return; }
            if(act === "save"){
              const patch = {};
              tr.querySelectorAll("input[data-k]").forEach(inp=>{
                const k = inp.dataset.k;
                if(k === "alokasi_jp"){
                  const n = parseInt(inp.value, 10);
                  patch[k] = Number.isFinite(n) ? n : null;
                }else patch[k] = inp.value.trim() || null;
              });
              if(!patch.topik) return showToast("Topik tidak boleh kosong.", true);
              setStatus("saving...");
              await updateById("bk1_prota_item", id, patch);
              showToast("Item disimpan.");
              setStatus("ready");
            }
          }catch(e){ showToast(e.message, true); setStatus("error"); }
        };
      });
    });
  }

  // PROMES
  async function loadPromes(){
    setStatus("loading promes...");
    const header = await ensureHeader("bk1_promes");
    const items = await sbFetch("bk1_promes_item", { params: { select:"*", promes_id: `eq.${header.id}`, order:"minggu_ke.asc,pertemuan_ke.asc" } });
    setStatus("ready");
    return { header, items: items || [] };
  }
  async function addPromesItem(promesId, payload){ await sbFetch("bk1_promes_item", { method:"POST", prefer:"return=minimal", body: { promes_id: promesId, ...payload } }); }

  async function renderPromes(){
    const { header, items } = await loadPromes();
    document.getElementById("mainBody").innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div style="flex:1;"><div class="field"><label>Deskripsi Promes</label><textarea id="promesDesc">${escapeHtml(header.deskripsi ?? "")}</textarea></div></div>
        <div style="flex:1;">
          <div class="field"><label>Status</label>
            <select id="promesStatus"><option value="DRAFT">DRAFT</option><option value="REVIEW">REVIEW</option><option value="APPROVED">APPROVED</option></select>
          </div>
          <div class="row"><button class="btn good" id="savePromesHeader">Simpan Header</button><button class="btn" id="btnReloadPromes">Reload</button></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;"><div class="row"><b>Item Promes</b> <span class="tag">${items.length} baris</span></div></div>
      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:72px;">Minggu</th><th style="width:84px;">Pert.</th><th>Topik</th><th style="width:84px;">JP</th><th>Target</th><th style="text-align:right; width:170px;">Aksi</th></tr></thead>
          <tbody id="promesTbody">
            ${items.map(it=>`
              <tr data-id="${it.id}">
                <td><input data-k="minggu_ke" type="number" value="${it.minggu_ke ?? 0}" /></td>
                <td><input data-k="pertemuan_ke" type="number" value="${it.pertemuan_ke ?? 0}" /></td>
                <td>
                  <input data-k="topik" value="${escapeHtml(it.topik)}" />
                  <div class="muted" style="font-size:12px; margin-top:6px;"><input data-k="integrasi_hk" placeholder="Integrasi HK (opsional)" value="${escapeHtml(it.integrasi_hk ?? "")}" /></div>
                </td>
                <td><input data-k="alokasi_jp" type="number" value="${it.alokasi_jp ?? ""}" /></td>
                <td><input data-k="target" value="${escapeHtml(it.target ?? "")}" /></td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="save">Simpan</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="6" class="muted">Belum ada item.</td></tr>`}
          </tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="notice"><b>Tambah Item</b></div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;"><input id="newPrM" type="number" value="1" placeholder="Minggu" /></div>
        <div style="flex:1;"><input id="newPrP" type="number" value="1" placeholder="Pertemuan" /></div>
        <div style="flex:3;"><input id="newPrTopik" placeholder="Topik" /></div>
        <div style="flex:1;"><input id="newPrJP" type="number" placeholder="JP" /></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:2;"><input id="newPrTarget" placeholder="Target (opsional)" /></div>
        <div style="flex:2;"><input id="newPrHK" placeholder="Integrasi HK (opsional)" /></div>
        <button class="btn good" id="btnAddPromes">Tambah</button>
      </div>
    `;
    document.getElementById("promesStatus").value = header.status || "DRAFT";

    document.getElementById("savePromesHeader").onclick = async ()=>{
      try{
        setStatus("saving...");
        await updateById("bk1_promes", header.id, {
          deskripsi: document.getElementById("promesDesc").value.trim() || null,
          status: document.getElementById("promesStatus").value
        });
        showToast("Header promes tersimpan.");
        setStatus("ready");
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };
    document.getElementById("btnReloadPromes").onclick = ()=>renderMain();

    document.getElementById("btnAddPromes").onclick = async ()=>{
      try{
        const minggu = parseInt(document.getElementById("newPrM").value, 10) || 0;
        const pertemuan = parseInt(document.getElementById("newPrP").value, 10) || 0;
        const topik = document.getElementById("newPrTopik").value.trim();
        if(!topik) return showToast("Topik wajib diisi.", true);
        const jp = parseInt(document.getElementById("newPrJP").value, 10);
        const target = document.getElementById("newPrTarget").value.trim();
        const hk = document.getElementById("newPrHK").value.trim();
        setStatus("saving...");
        await addPromesItem(header.id, { minggu_ke: minggu, pertemuan_ke: pertemuan, topik, alokasi_jp: Number.isFinite(jp) ? jp : null, target: target || null, integrasi_hk: hk || null });
        showToast("Item promes ditambahkan.");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.querySelectorAll("#promesTbody tr[data-id]").forEach(tr=>{
      const id = parseInt(tr.dataset.id, 10);
      tr.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.dataset.act;
            if(act === "del"){
              if(!confirm("Hapus item ini?")) return;
              setStatus("deleting...");
              await deleteById("bk1_promes_item", id);
              showToast("Item dihapus.");
              renderMain();
              return;
            }
            if(act === "save"){
              const patch = {};
              tr.querySelectorAll("input[data-k]").forEach(inp=>{
                const k = inp.dataset.k;
                if(k === "minggu_ke" || k === "pertemuan_ke" || k === "alokasi_jp"){
                  const n = parseInt(inp.value, 10);
                  patch[k] = Number.isFinite(n) ? n : (k === "alokasi_jp" ? null : 0);
                }else patch[k] = inp.value.trim() || null;
              });
              if(!patch.topik) return showToast("Topik tidak boleh kosong.", true);
              setStatus("saving...");
              await updateById("bk1_promes_item", id, patch);
              showToast("Item disimpan.");
              setStatus("ready");
            }
          }catch(e){ showToast(e.message, true); setStatus("error"); }
        };
      });
    });
  }

  // ATP
  async function loadATP(){
    setStatus("loading atp...");
    const header = await ensureHeader("bk1_atp");
    const units = await sbFetch("bk1_atp_unit", { params: { select:"*", atp_id: `eq.${header.id}`, order:"urutan.asc" } });
    setStatus("ready");
    return { header, units: units || [] };
  }
  async function addATPUnit(atpId, payload){ await sbFetch("bk1_atp_unit", { method:"POST", prefer:"return=minimal", body: { atp_id: atpId, ...payload } }); }
  async function swapATPOrder(units, idxA, idxB){
    const a=units[idxA], b=units[idxB]; if(!a||!b) return;
    await Promise.all([ updateById("bk1_atp_unit", a.id, { urutan: b.urutan }), updateById("bk1_atp_unit", b.id, { urutan: a.urutan }) ]);
  }
  async function renderATP(){
    const { header, units } = await loadATP();
    document.getElementById("mainBody").innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div style="flex:1;"><div class="field"><label>Deskripsi ATP</label><textarea id="atpDesc">${escapeHtml(header.deskripsi ?? "")}</textarea></div></div>
        <div style="flex:1;">
          <div class="field"><label>Status</label>
            <select id="atpStatus"><option value="DRAFT">DRAFT</option><option value="REVIEW">REVIEW</option><option value="APPROVED">APPROVED</option></select>
          </div>
          <div class="row"><button class="btn good" id="saveATPHeader">Simpan Header</button><button class="btn" id="btnReloadATP">Reload</button></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;"><div class="row"><b>Unit ATP</b> <span class="tag">${units.length} unit</span></div><span class="tag">Generator modul ajar mengambil dari sini</span></div>
      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:56px;">Urut</th><th>Tujuan</th><th>Materi</th><th style="width:84px;">JP</th><th style="text-align:right; width:230px;">Aksi</th></tr></thead>
          <tbody id="atpTbody">
            ${units.map((u, idx)=>`
              <tr data-id="${u.id}">
                <td><span class="mono">${u.urutan}</span></td>
                <td>
                  <textarea data-k="tujuan" style="min-height:72px;">${escapeHtml(u.tujuan)}</textarea>
                  <div class="muted" style="font-size:12px; margin-top:6px;"><input data-k="integrasi_hk" placeholder="Integrasi HK" value="${escapeHtml(u.integrasi_hk ?? "")}" /></div>
                </td>
                <td><textarea data-k="materi" style="min-height:72px;">${escapeHtml(u.materi ?? "")}</textarea></td>
                <td><input data-k="alokasi_jp" type="number" value="${u.alokasi_jp ?? ""}" /></td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="save">Simpan</button>
                  <button class="btn small" data-act="up">↑</button>
                  <button class="btn small" data-act="down">↓</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="5" class="muted">Belum ada unit.</td></tr>`}
          </tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="notice"><b>Tambah Unit</b></div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:3;"><textarea id="newATPTujuan" placeholder="Tujuan"></textarea></div>
        <div style="flex:2;"><textarea id="newATPMateri" placeholder="Materi (opsional)"></textarea></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;"><input id="newATPJP" type="number" placeholder="JP" /></div>
        <div style="flex:3;"><input id="newATPHK" placeholder="Integrasi HK (opsional)" /></div>
        <button class="btn good" id="btnAddATP">Tambah</button>
      </div>
    `;
    document.getElementById("atpStatus").value = header.status || "DRAFT";

    document.getElementById("saveATPHeader").onclick = async ()=>{
      try{
        setStatus("saving...");
        await updateById("bk1_atp", header.id, { deskripsi: document.getElementById("atpDesc").value.trim() || null, status: document.getElementById("atpStatus").value });
        showToast("Header ATP tersimpan.");
        setStatus("ready");
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };
    document.getElementById("btnReloadATP").onclick = ()=>renderMain();

    document.getElementById("btnAddATP").onclick = async ()=>{
      try{
        const tujuan = document.getElementById("newATPTujuan").value.trim();
        if(!tujuan) return showToast("Tujuan wajib diisi.", true);
        const materi = document.getElementById("newATPMateri").value.trim();
        const jp = parseInt(document.getElementById("newATPJP").value, 10);
        const hk = document.getElementById("newATPHK").value.trim();
        const nextOrder = (units.length ? Math.max(...units.map(x=>x.urutan)) : 0) + 1;
        setStatus("saving...");
        await addATPUnit(header.id, { urutan: nextOrder, tujuan, materi: materi || null, alokasi_jp: Number.isFinite(jp) ? jp : null, integrasi_hk: hk || null });
        showToast("Unit ATP ditambahkan.");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.querySelectorAll("#atpTbody tr[data-id]").forEach((tr, idx)=>{
      const id = parseInt(tr.dataset.id, 10);
      tr.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.dataset.act;
            if(act === "del"){
              if(!confirm("Hapus unit ini?")) return;
              setStatus("deleting...");
              await deleteById("bk1_atp_unit", id);
              showToast("Unit dihapus.");
              renderMain();
              return;
            }
            if(act === "up"){ if(idx===0) return; setStatus("reordering..."); await swapATPOrder(units, idx, idx-1); renderMain(); return; }
            if(act === "down"){ if(idx===units.length-1) return; setStatus("reordering..."); await swapATPOrder(units, idx, idx+1); renderMain(); return; }
            if(act === "save"){
              const patch = {};
              tr.querySelectorAll("[data-k]").forEach(inp=>{
                const k = inp.dataset.k;
                if(k === "alokasi_jp"){
                  const n = parseInt(inp.value, 10);
                  patch[k] = Number.isFinite(n) ? n : null;
                }else patch[k] = inp.value.trim() || null;
              });
              if(!patch.tujuan) return showToast("Tujuan tidak boleh kosong.", true);
              setStatus("saving...");
              await updateById("bk1_atp_unit", id, patch);
              showToast("Unit disimpan.");
              setStatus("ready");
            }
          }catch(e){ showToast(e.message, true); setStatus("error"); }
        };
      });
    });
  }

  // LESSON PLAN
  function openModal(){ document.getElementById("modalBackdrop").style.display = "flex"; }
  function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }

  async function loadLessonPlans(){
    setStatus("loading lesson plans...");
    const rows = await sbFetch("bk1_lesson_plan", { params: { select:"*", teaching_assignment_id: `eq.${active.id}`, order:"pertemuan_ke.asc" } });
    setStatus("ready");
    return rows || [];
  }

  async function createLessonPlan(payload){
    const rep = await sbFetch("bk1_lesson_plan", { method:"POST", prefer:"return=representation", body: payload });
    return rep?.[0] || null;
  }

  async function createLessonPlansBatch(payload){
    await sbFetch("bk1_lesson_plan", { method:"POST", prefer:"return=minimal", body: payload });
  }

  async function openLessonEditor(lp){
    currentLP = lp;
    document.getElementById("lpModalSub").textContent = `Pertemuan ke-${lp.pertemuan_ke || 0} • Tipe: ${lp.tipe || "MODUL_AJAR"}`;
    document.getElementById("modalBody").innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div style="flex:1;">
          <div class="field"><label>Tipe</label>
            <select id="lpTipe"><option value="MODUL_AJAR">MODUL_AJAR</option><option value="RPP">RPP</option></select>
          </div>
        </div>
        <div style="flex:1;">
          <div class="field"><label>Status</label>
            <select id="lpStatus"><option value="DRAFT">DRAFT</option><option value="REVIEW">REVIEW</option><option value="APPROVED">APPROVED</option></select>
          </div>
        </div>
      </div>
      <div class="row">
        <div style="flex:1;"><div class="field"><label>Pertemuan</label><input id="lpMeet" type="number" value="${lp.pertemuan_ke ?? 0}" /></div></div>
        <div style="flex:1;"><div class="field"><label>Tanggal</label><input id="lpDate" type="date" value="${lp.tanggal ?? ""}" /></div></div>
      </div>
      <div class="field"><label>Tujuan</label><textarea id="lpTujuan">${escapeHtml(lp.tujuan ?? "")}</textarea></div>
      <div class="field"><label>Langkah Pembelajaran</label><textarea id="lpLangkah">${escapeHtml(lp.langkah_pembelajaran ?? "")}</textarea></div>
      <div class="field"><label>Asesmen</label><textarea id="lpAsesmen">${escapeHtml(lp.asesmen ?? "")}</textarea></div>
      <div class="row">
        <div style="flex:1;"><div class="field"><label>Diferensiasi</label><textarea id="lpDiff">${escapeHtml(lp.diferensiasi ?? "")}</textarea></div></div>
        <div style="flex:1;"><div class="field"><label>Refleksi</label><textarea id="lpRef">${escapeHtml(lp.refleksi ?? "")}</textarea></div></div>
      </div>
      <div class="row">
        <div style="flex:1;"><div class="field"><label>Referensi</label><textarea id="lpRefSrc">${escapeHtml(lp.referensi ?? "")}</textarea></div></div>
        <div style="flex:1;"><div class="field"><label>Integrasi HK</label><textarea id="lpHK">${escapeHtml(lp.integrasi_hk ?? "")}</textarea></div></div>
      </div>
    `;

    document.getElementById("lpTipe").value = lp.tipe || "MODUL_AJAR";
    document.getElementById("lpStatus").value = lp.status || "DRAFT";

    document.getElementById("btnDeleteLP").onclick = async ()=>{
      try{
        if(!confirm("Hapus modul ajar ini?")) return;
        setStatus("deleting...");
        await deleteById("bk1_lesson_plan", lp.id);
        showToast("Modul ajar dihapus.");
        closeModal();
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.getElementById("btnSaveLP").onclick = async ()=>{
      try{
        const meet = parseInt(document.getElementById("lpMeet").value, 10) || 0;
        if(meet <= 0) return showToast("Pertemuan harus > 0.", true);
        setStatus("saving...");
        await updateById("bk1_lesson_plan", lp.id, {
          tipe: document.getElementById("lpTipe").value,
          status: document.getElementById("lpStatus").value,
          pertemuan_ke: meet,
          tanggal: document.getElementById("lpDate").value || null,
          tujuan: document.getElementById("lpTujuan").value.trim() || null,
          langkah_pembelajaran: document.getElementById("lpLangkah").value.trim() || null,
          asesmen: document.getElementById("lpAsesmen").value.trim() || null,
          diferensiasi: document.getElementById("lpDiff").value.trim() || null,
          refleksi: document.getElementById("lpRef").value.trim() || null,
          referensi: document.getElementById("lpRefSrc").value.trim() || null,
          integrasi_hk: document.getElementById("lpHK").value.trim() || null
        });
        showToast("Modul ajar tersimpan.");
        setStatus("ready");
        closeModal();
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    openModal();
  }

  async function renderLessonPlans(){
    const plans = await loadLessonPlans();
    document.getElementById("mainBody").innerHTML = `
      <div class="notice">Modul Ajar bisa dibuat manual atau <b>Generate dari ATP</b> (append dari pertemuan terakhir).</div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;">
        <div class="row"><b>Daftar Modul Ajar</b> <span class="tag">${plans.length} pertemuan</span></div>
        <div class="row">
          <button class="btn small warn" id="btnGenLP">Generate dari ATP</button>
          <button class="btn small" id="btnNewLP">Tambah Manual</button>
          <button class="btn small" id="btnReloadLP">Reload</button>
        </div>
      </div>
      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:90px;">Pert.</th><th>Tujuan (ringkas)</th><th style="width:110px;">Tipe</th><th style="width:120px;">Status</th><th style="text-align:right; width:130px;">Aksi</th></tr></thead>
          <tbody id="lpTbody">
            ${plans.map(p=>`
              <tr data-id="${p.id}">
                <td><span class="mono">${p.pertemuan_ke ?? 0}</span></td>
                <td>${escapeHtml((p.tujuan ?? "").slice(0, 140))}${(p.tujuan ?? "").length>140?"…":""}</td>
                <td>${escapeHtml(p.tipe ?? "MODUL_AJAR")}</td>
                <td>${renderStatusTag(p.status)}</td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="edit">Edit</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join("") || `<tr><td colspan="5" class="muted">Belum ada modul ajar.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;

    document.getElementById("btnReloadLP").onclick = ()=>renderMain();

    document.getElementById("btnNewLP").onclick = async ()=>{
      try{
        const maxMeet = plans.length ? Math.max(...plans.map(x=>x.pertemuan_ke||0)) : 0;
        setStatus("saving...");
        const newLP = await createLessonPlan({
          teaching_assignment_id: active.id,
          tipe: "MODUL_AJAR",
          pertemuan_ke: maxMeet + 1,
          tanggal: null,
          tujuan: null,
          langkah_pembelajaran: null,
          asesmen: null,
          diferensiasi: null,
          refleksi: null,
          referensi: null,
          integrasi_hk: null,
          status: "DRAFT"
        });
        setStatus("ready");
        showToast("Modul ajar dibuat. Silakan edit.");
        openLessonEditor(newLP);
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.getElementById("btnGenLP").onclick = async ()=>{
      try{
        const atpHeader = await getSingleRow("bk1_atp", active.id);
        if(!atpHeader) return showToast("ATP belum ada. Isi ATP dulu.", true);
        const units = await sbFetch("bk1_atp_unit", { params: { select:"*", atp_id:`eq.${atpHeader.id}`, order:"urutan.asc" } });
        if(!units?.length) return showToast("Unit ATP masih kosong.", true);

        const maxMeet = plans.length ? Math.max(...plans.map(x=>x.pertemuan_ke||0)) : 0;
        if(!confirm(`Generate ${units.length} pertemuan dari ATP? (Mulai pertemuan ${maxMeet+1})`)) return;

        setStatus("generating...");
        const payload = units.map((u, idx)=>({
          teaching_assignment_id: active.id,
          tipe: "MODUL_AJAR",
          pertemuan_ke: maxMeet + idx + 1,
          tanggal: null,
          tujuan: u.tujuan || null,
          langkah_pembelajaran: u.kegiatan || null,
          asesmen: u.asesmen || null,
          diferensiasi: null,
          refleksi: null,
          referensi: u.sumber || null,
          integrasi_hk: u.integrasi_hk || null,
          status: "DRAFT"
        }));
        await createLessonPlansBatch(payload);
        showToast("Generate selesai.");
        setStatus("ready");
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.querySelectorAll("#lpTbody tr[data-id]").forEach(tr=>{
      const id = parseInt(tr.dataset.id, 10);
      const lp = plans.find(x=>x.id === id);
      tr.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.dataset.act;
            if(act === "edit"){ openLessonEditor(lp); return; }
            if(act === "del"){
              if(!confirm("Hapus modul ajar ini?")) return;
              setStatus("deleting...");
              await deleteById("bk1_lesson_plan", id);
              showToast("Modul ajar dihapus.");
              setStatus("ready");
              renderMain();
            }
          }catch(e){ showToast(e.message, true); setStatus("error"); }
        };
      });
    });
  }

  // EXPORT: multi-page
  function safeCell(x){ return escapeHtml(x ?? ""); }

  async function buildExportHTML(){
    setStatus("building export...");
    const assignmentId = active.id;

    const [weekPlan, protaH, promesH, atpH, masteryC] = await Promise.all([
      getSingleRow("bk1_effective_week_plan", assignmentId),
      getSingleRow("bk1_prota", assignmentId),
      getSingleRow("bk1_promes", assignmentId),
      getSingleRow("bk1_atp", assignmentId),
      getSingleRow("bk1_mastery_criteria", assignmentId)
    ]);

    const [weekDetail, protaItems, promesItems, atpUnits, lessonPlans, resources, attachments, calEvents, skDocs, mappingRows, modelMetode] = await Promise.all([
      weekPlan ? sbFetch("bk1_effective_week_detail", { params: { select:"*", week_plan_id:`eq.${weekPlan.id}`, order:"minggu_ke.asc" } }) : [],
      protaH ? sbFetch("bk1_prota_item", { params: { select:"*", prota_id:`eq.${protaH.id}`, order:"urutan.asc" } }) : [],
      promesH ? sbFetch("bk1_promes_item", { params: { select:"*", promes_id:`eq.${promesH.id}`, order:"minggu_ke.asc,pertemuan_ke.asc" } }) : [],
      atpH ? sbFetch("bk1_atp_unit", { params: { select:"*", atp_id:`eq.${atpH.id}`, order:"urutan.asc" } }) : [],
      sbFetch("bk1_lesson_plan", { params: { select:"*", teaching_assignment_id:`eq.${assignmentId}`, order:"pertemuan_ke.asc" } }),
      sbFetch("bk1_resource", { params: { select:"*", teaching_assignment_id:`eq.${assignmentId}`, order:"created_at.desc", limit:"500" } }),
      safeFetchTable("bk1_attachment", { params:{ select:"id,label,kategori,asset_id,file_asset(id,filename)", teaching_assignment_id:`eq.${assignmentId}`, order:"created_at.desc", limit:"2000" } }),
      safeFetchTable("bk1_calendar_event", { params:{ select:"*", academic_term_id:`eq.${active.academic_term?.id}`, order:"tanggal.asc", limit:"4000" } }),
      safeFetchTable("bk1_admin_doc", { params:{ select:"jenis,nomor,tanggal,tentang,asset_id,file_asset(id,filename)", academic_term_id:`eq.${active.academic_term?.id}`, order:"tanggal.desc", limit:"2000" } }),
      safeFetchTable("bk1_mapping_matrix", { params:{ select:"*", teaching_assignment_id:`eq.${assignmentId}`, order:"id.asc", limit:"4000" } }),
      safeFetchTable("bk1_model_metode", { params:{ select:"*", teaching_assignment_id:`eq.${assignmentId}`, limit:"1" } })
    ]);

    const metaTable = `
      <table class="p-table">
        <tbody>
          <tr><th style="width:35mm;">Satuan Pendidikan</th><td>Pontren HK</td></tr>
          <tr><th>Guru</th><td>${safeCell(active.teacher?.nama ?? "-")}</td></tr>
          <tr><th>Mapel</th><td>${safeCell(active.subject?.nama ?? "-")} (${safeCell(active.subject?.kurikulum ?? "-")})</td></tr>
          <tr><th>Kelas</th><td>${safeCell(active.class_group?.jenjang ?? "")} ${safeCell(active.class_group?.label ?? "")}</td></tr>
          <tr><th>Tahun Ajaran</th><td>${safeCell(active.academic_term?.tahun_ajaran ?? "")} • ${safeCell(active.academic_term?.semester ?? "")}</td></tr>
          <tr><th>JP / Pekan</th><td>${safeCell(active.jp_per_pekan ?? "-")}</td></tr>
        </tbody>
      </table>
    `;

    const cover = `
      <div class="page">
        <div class="p-title">BUKU KERJA GURU</div>
        <div class="p-sub">BUKU KERJA 1</div>
        <div class="cover-box">
          <div class="center" style="font-size:12pt; font-weight:700;">PONDOK PESANTREN HUSNUL KHOTIMAH</div>
          <div class="center" style="font-size:10.5pt; margin-top:2mm;">Kuningan, Jawa Barat</div>
          <div class="cover-line"><b>Mapel:</b> ${safeCell(active.subject?.nama ?? "-")}</div>
          <div class="cover-line"><b>Kelas:</b> ${safeCell(active.class_group?.jenjang ?? "")} ${safeCell(active.class_group?.label ?? "")}</div>
          <div class="cover-line"><b>Guru:</b> ${safeCell(active.teacher?.nama ?? "-")}</div>
          <div class="cover-line"><b>Tahun Ajaran:</b> ${safeCell(active.academic_term?.tahun_ajaran ?? "")} (${safeCell(active.academic_term?.semester ?? "")})</div>
          <div class="center" style="margin-top:10mm; font-size:9.5pt;">(Dokumen internal — BK1)</div>
        </div>
      </div>
    `;

    const identitas = `
      <div class="page">
        <div class="p-h2">Identitas Buku Kerja 1</div>
        <div class="p-box">${metaTable}</div>
        <div class="p-box">
          <div class="p-h3">Ringkasan Status Dokumen</div>
          <table class="p-table">
            <thead><tr><th style="width:55mm;">Bagian</th><th style="width:35mm;">Status</th><th>Catatan</th></tr></thead>
            <tbody>
              <tr><td>Minggu Efektif</td><td>${safeCell(weekPlan?.status ?? "-")}</td><td>${safeCell(weekPlan?.catatan ?? "-")}</td></tr>
              <tr><td>Prota</td><td>${safeCell(protaH?.status ?? "-")}</td><td>${safeCell(protaH?.deskripsi ?? "-")}</td></tr>
              <tr><td>Promes</td><td>${safeCell(promesH?.status ?? "-")}</td><td>${safeCell(promesH?.deskripsi ?? "-")}</td></tr>
              <tr><td>ATP</td><td>${safeCell(atpH?.status ?? "-")}</td><td>${safeCell(atpH?.deskripsi ?? "-")}</td></tr>
              <tr><td>Modul Ajar (Ringkasan)</td><td>-</td><td>Jumlah pertemuan: ${safeCell((lessonPlans||[]).length)}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;



    const kalender = `
      <div class="page">
        <div class="p-h2">Kalender Pendidikan</div>
        <div class="p-box">
          <div class="p-meta">Sumber acuan: Pedoman Kalender Pendidikan Madrasah Ditjen Pendis + penyesuaian daerah/pontren.</div>
        </div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:28mm;">Tanggal</th><th style="width:32mm;">Tipe</th><th>Nama</th><th>Keterangan</th></tr></thead>
            <tbody>
              ${(Array.isArray(calEvents) ? calEvents : []).map(e=>`
                <tr>
                  <td>${safeCell(e.tanggal||'')}</td>
                  <td>${safeCell(e.tipe||'')}</td>
                  <td>${safeCell(e.nama||'')}</td>
                  <td>${safeCell(e.keterangan||'')}</td>
                </tr>
              `).join('') || `<tr><td colspan="4">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const skBeban = `
      <div class="page">
        <div class="p-h2">SK Pembagian Tugas / Beban Mengajar</div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:36mm;">Jenis</th><th style="width:42mm;">Nomor</th><th style="width:26mm;">Tanggal</th><th>Tentang</th><th style="width:40mm;">Lampiran</th></tr></thead>
            <tbody>
              ${(Array.isArray(skDocs) ? skDocs : []).map(d=>`
                <tr>
                  <td>${safeCell(d.jenis||'')}</td>
                  <td>${safeCell(d.nomor||'')}</td>
                  <td>${safeCell(d.tanggal||'')}</td>
                  <td>${safeCell(d.tentang||'')}</td>
                  <td>${safeCell(d.file_asset?.filename || (d.asset_id ? ('asset #' + d.asset_id) : '-'))}</td>
                </tr>
              `).join('') || `<tr><td colspan="5">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const pemetaan = `
      <div class="page">
        <div class="p-h2">Pemetaan CP→TP / KI-KD→Indikator</div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:16mm;">Kur</th><th style="width:40mm;">CP/KD</th><th>TP/Indikator</th><th style="width:35mm;">Materi</th><th style="width:30mm;">Asesmen</th><th style="width:10mm;">M</th><th style="width:10mm;">P</th></tr></thead>
            <tbody>
              ${(Array.isArray(mappingRows) ? mappingRows : []).map(r=>`
                <tr>
                  <td>${safeCell(r.kurikulum||'')}</td>
                  <td>${safeCell(r.cp_kd||'')}</td>
                  <td>${safeCell(r.tp_indikator||'')}</td>
                  <td>${safeCell(r.materi||'')}</td>
                  <td>${safeCell(r.asesmen||'')}</td>
                  <td>${safeCell(r.minggu_ke??'')}</td>
                  <td>${safeCell(r.pertemuan_ke??'')}</td>
                </tr>
              `).join('') || `<tr><td colspan="7">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const modelMetodePage = (()=>{
      const mm = (Array.isArray(modelMetode) && modelMetode[0]) ? modelMetode[0] : null;
      return `
        <div class="page">
          <div class="p-h2">Perencanaan Model/Metode</div>
          <div class="p-box">
            <div class="p-meta"><b>Model:</b> ${safeCell(mm?.model||'-')}</div>
            <div class="p-meta"><b>Pendekatan:</b> ${safeCell(mm?.pendekatan||'-')}</div>
            <div class="p-meta"><b>Status:</b> ${safeCell(mm?.status||'-')}</div>
          </div>
          <div class="p-box"><div class="p-h3">Metode</div><div>${safeCell(mm?.metode||'-')}</div></div>
          <div class="p-box"><div class="p-h3">Media/Alat/Bahan</div><div>${safeCell(mm?.media||'-')}</div></div>
          <div class="p-box"><div class="p-h3">Strategi/Skema</div><div>${safeCell(mm?.strategi||'-')}</div></div>
          <div class="p-box"><div class="p-h3">Diferensiasi</div><div>${safeCell(mm?.diferensiasi||'-')}</div></div>
          <div class="p-box"><div class="p-h3">Catatan</div><div>${safeCell(mm?.catatan||'-')}</div></div>
        </div>
      `;
    })();

    const lampiran = `
      <div class="page">
        <div class="p-h2">Lampiran</div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th>Label</th><th style="width:26mm;">Kategori</th><th style="width:60mm;">Nama File</th></tr></thead>
            <tbody>
              ${(Array.isArray(attachments) ? attachments : []).map(a=>`
                <tr>
                  <td>${safeCell(a.label||'-')}</td>
                  <td>${safeCell(a.kategori||'-')}</td>
                  <td>${safeCell(a.file_asset?.filename || (a.asset_id ? ('asset #' + a.asset_id) : '-'))}</td>
                </tr>
              `).join('') || `<tr><td colspan="3">-</td></tr>`}
            </tbody>
          </table>
          <div class="p-meta" style="margin-top:4mm;">Catatan: file lampiran disimpan terpisah di aplikasi (menu Lampiran). Dokumen PDF export ini hanya mencantumkan daftar lampiran.</div>
        </div>
      </div>
    `;
    const mingguEfektif = `
      <div class="page">
        <div class="p-h2">A. Minggu Efektif</div>
        <div class="p-box">
          <div class="p-meta"><b>Total minggu:</b> ${safeCell(weekPlan?.total_minggu ?? "-")}</div>
          <div class="p-meta"><b>Minggu efektif:</b> ${safeCell(weekPlan?.minggu_efektif ?? "-")}</div>
          <div class="p-meta"><b>Status:</b> ${safeCell(weekPlan?.status ?? "-")}</div>
          <div class="p-meta"><b>Catatan:</b> ${safeCell(weekPlan?.catatan ?? "-")}</div>
        </div>
        <div class="p-box">
          <div class="p-h3">Detail Minggu</div>
          <table class="p-table">
            <thead><tr><th style="width:14mm;">Minggu</th><th style="width:28mm;">Mulai</th><th style="width:28mm;">Selesai</th><th style="width:25mm;">Kategori</th><th>Keterangan</th></tr></thead>
            <tbody>
              ${(weekDetail||[]).map(d=>`
                <tr>
                  <td>${d.minggu_ke}</td>
                  <td>${safeCell(d.start_date ?? "")}</td>
                  <td>${safeCell(d.end_date ?? "")}</td>
                  <td>${safeCell(d.kategori ?? "")}</td>
                  <td>${safeCell(d.keterangan ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="5">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const prota = `
      <div class="page">
        <div class="p-h2">B. Program Tahunan (Prota)</div>
        <div class="p-box">
          <div class="p-meta"><b>Status:</b> ${safeCell(protaH?.status ?? "-")}</div>
          <div class="p-meta"><b>Catatan:</b> ${safeCell(protaH?.deskripsi ?? "-")}</div>
        </div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:10mm;">No</th><th>Topik</th><th style="width:14mm;">JP</th><th style="width:45mm;">Integrasi HK</th></tr></thead>
            <tbody>
              ${(protaItems||[]).map(it=>`
                <tr>
                  <td>${safeCell(it.urutan)}</td>
                  <td>${safeCell(it.topik ?? "")}${it.catatan?`<br><span class="small">Catatan: ${safeCell(it.catatan)}</span>`:""}</td>
                  <td>${safeCell(it.alokasi_jp ?? "")}</td>
                  <td>${safeCell(it.integrasi_hk ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="4">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const promes = `
      <div class="page">
        <div class="p-h2">C. Program Semester (Promes)</div>
        <div class="p-box">
          <div class="p-meta"><b>Status:</b> ${safeCell(promesH?.status ?? "-")}</div>
          <div class="p-meta"><b>Catatan:</b> ${safeCell(promesH?.deskripsi ?? "-")}</div>
        </div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:14mm;">Minggu</th><th style="width:14mm;">Pert.</th><th>Topik</th><th style="width:14mm;">JP</th><th style="width:40mm;">Target</th></tr></thead>
            <tbody>
              ${(promesItems||[]).map(it=>`
                <tr>
                  <td>${safeCell(it.minggu_ke ?? "")}</td>
                  <td>${safeCell(it.pertemuan_ke ?? "")}</td>
                  <td>${safeCell(it.topik ?? "")}${it.integrasi_hk?`<br><span class="small">Integrasi: ${safeCell(it.integrasi_hk)}</span>`:""}</td>
                  <td>${safeCell(it.alokasi_jp ?? "")}</td>
                  <td>${safeCell(it.target ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="5">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const atp = `
      <div class="page">
        <div class="p-h2">D. ATP / Silabus</div>
        <div class="p-box">
          <div class="p-meta"><b>Status:</b> ${safeCell(atpH?.status ?? "-")}</div>
          <div class="p-meta"><b>Catatan:</b> ${safeCell(atpH?.deskripsi ?? "-")}</div>
        </div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:10mm;">No</th><th style="width:55mm;">Tujuan</th><th>Materi</th><th style="width:14mm;">JP</th><th style="width:35mm;">Integrasi HK</th></tr></thead>
            <tbody>
              ${(atpUnits||[]).map(u=>`
                <tr>
                  <td>${safeCell(u.urutan)}</td>
                  <td>${safeCell(u.tujuan ?? "")}</td>
                  <td>${safeCell(u.materi ?? "")}</td>
                  <td>${safeCell(u.alokasi_jp ?? "")}</td>
                  <td>${safeCell(u.integrasi_hk ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="5">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;

    const modulAjarRingkas = `
      <div class="page">
        <div class="p-h2">E. Modul Ajar / RPP (Ringkasan)</div>
        <div class="p-box">
          <div class="p-meta">Jumlah pertemuan: <b>${safeCell((lessonPlans||[]).length)}</b></div>
          <div class="p-meta">Catatan: Halaman ini ringkasan. Lampiran modul ajar lengkap dapat dicetak terpisah.</div>
        </div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:14mm;">Pert.</th><th style="width:20mm;">Tipe</th><th style="width:20mm;">Status</th><th>Tujuan</th><th>Asesmen</th></tr></thead>
            <tbody>
              ${(lessonPlans||[]).map(p=>`
                <tr>
                  <td>${safeCell(p.pertemuan_ke ?? "")}</td>
                  <td>${safeCell(p.tipe ?? "")}</td>
                  <td>${safeCell(p.status ?? "")}</td>
                  <td>${safeCell(p.tujuan ?? "")}</td>
                  <td>${safeCell(p.asesmen ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="5">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;



    const kkmkktp = `
      <div class="page">
        <div class="p-h2">F. KKM / KKTP</div>
        <div class="p-box">
          <div class="p-meta"><b>Nama Kriteria:</b> ${safeCell(masteryC?.nama_kriteria ?? "-")}</div>
          <div class="p-meta"><b>Nilai Minimum:</b> ${safeCell(masteryC?.nilai_minimum ?? "-")}</div>
          <div class="p-meta"><b>Status:</b> ${safeCell(masteryC?.status ?? "-")}</div>
          <div class="p-meta"><b>Deskripsi:</b> ${safeCell(masteryC?.deskripsi ?? "-")}</div>
        </div>
      </div>
    `;

    const sumberMedia = `
      <div class="page">
        <div class="p-h2">G. Sumber / Media</div>
        <div class="p-box">
          <table class="p-table">
            <thead><tr><th style="width:20mm;">Tipe</th><th>Judul</th><th style="width:60mm;">Detail</th><th style="width:55mm;">URL</th></tr></thead>
            <tbody>
              ${(resources||[]).map(r=>`
                <tr>
                  <td>${safeCell(r.tipe ?? "")}</td>
                  <td>${safeCell(r.judul ?? "")}</td>
                  <td>${safeCell(r.detail ?? "")}</td>
                  <td>${safeCell(r.url ?? "")}</td>
                </tr>
              `).join("") || `<tr><td colspan="4">-</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;


    const pengesahan = `
      <div class="page">
        <div class="p-h2">Halaman Pengesahan</div>
        <div class="p-box">
          <div class="p-meta">Dokumen ini disusun sebagai Buku Kerja Guru (Buku 1) untuk mendukung perencanaan pembelajaran.</div>
          <div class="p-meta">Tanggal: ____________________</div>
        </div>
        <div class="sign-grid">
          <div class="sign">
            <div class="lbl">Disusun oleh,</div>
            <div class="name">${safeCell(active.teacher?.nama ?? "-")}</div>
            <div class="role">Guru Mapel</div>
          </div>
          <div class="sign">
            <div class="lbl">Diperiksa oleh,</div>
            <div class="name">________________________</div>
            <div class="role">Koordinator/UPMP</div>
          </div>
          <div class="sign">
            <div class="lbl">Mengetahui,</div>
            <div class="name">________________________</div>
            <div class="role">Waka Kurikulum</div>
          </div>
          <div class="sign">
            <div class="lbl">Mengesahkan,</div>
            <div class="name">________________________</div>
            <div class="role">Kepala Madrasah/Pimpinan</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("printArea").innerHTML = cover + identitas + kalender + skBeban + mingguEfektif + prota + promes + atp + pemetaan + modelMetodePage + modulAjarRingkas + kkmkktp + sumberMedia + lampiran + pengesahan;
    setStatus("ready");
  }



  // ===== KKM/KKTP (Mastery Criteria) =====
  async function ensureMasteryCriteria(){
    const existing = await getSingleRow("bk1_mastery_criteria", active.id);
    if(existing) return existing;
    const k = (active.subject?.kurikulum === 'K13') ? 'KKM' : 'KKTP';
    const inserted = await sbFetch("bk1_mastery_criteria", {
      method: "POST",
      prefer: "return=representation",
      body: { teaching_assignment_id: active.id, nama_kriteria: k, nilai_minimum: null, deskripsi: null, status: "DRAFT" }
    });
    return inserted?.[0] || null;
  }

  async function renderMastery(){
    setStatus("loading mastery...");
    const mc = await ensureMasteryCriteria();
    setStatus("ready");

    const kur = active.subject?.kurikulum || '-';
    const label = (kur === 'K13') ? 'KKM (Kriteria Ketuntasan Minimal)' : 'KKTP (Kriteria Ketercapaian Tujuan Pembelajaran)';

    document.getElementById("mainBody").innerHTML = `
      <div class="notice">
        <b>${label}</b><br>
        Kurikulum: <b>${escapeHtml(kur)}</b>. Rekomendasi Kurikulum Merdeka: gunakan deskripsi capaian (boleh ditambah interval nilai bila dibutuhkan).
      </div>
      <div class="hr"></div>
      <div class="split">
        <div>
          <div class="field"><label>Nama Kriteria</label>
            <select id="mcName">
              <option value="KKTP">KKTP</option>
              <option value="KKM">KKM</option>
            </select>
          </div>
          <div class="field"><label>Nilai Minimum (opsional)</label><input id="mcMin" type="number" step="0.01" value="${mc.nilai_minimum ?? ''}" placeholder="mis. 75" /></div>
        </div>
        <div>
          <div class="field"><label>Status</label>
            <select id="mcStatus">
              <option value="DRAFT">DRAFT</option>
              <option value="REVIEW">REVIEW</option>
              <option value="APPROVED">APPROVED</option>
            </select>
          </div>
          <div class="field"><label>Deskripsi/Indikator Ketercapaian</label>
            <textarea id="mcDesc" placeholder="Contoh: Peserta didik mampu ... (kriteria bukti kerja/asesmen)">${escapeHtml(mc.deskripsi ?? '')}</textarea>
          </div>
          <div class="row">
            <button class="btn good" id="btnSaveMC">Simpan</button>
            <button class="btn" id="btnReloadMC">Reload</button>
          </div>
        </div>
      </div>
    `;

    // defaults
    document.getElementById('mcName').value = (mc.nama_kriteria || ((kur === 'K13') ? 'KKM' : 'KKTP'));
    document.getElementById('mcStatus').value = (mc.status || 'DRAFT');

    document.getElementById('btnReloadMC').onclick = ()=>renderMain();
    document.getElementById('btnSaveMC').onclick = async ()=>{
      try{
        setStatus('saving...');
        const name = document.getElementById('mcName').value;
        const minRaw = document.getElementById('mcMin').value;
        const minVal = (minRaw === '' ? null : Number(minRaw));
        const desc = document.getElementById('mcDesc').value.trim() || null;
        const status = document.getElementById('mcStatus').value;
        await sbFetch('bk1_mastery_criteria', {
          method: 'PATCH',
          prefer: 'return=minimal',
          params: { id: `eq.${mc.id}` },
          body: { nama_kriteria: name, nilai_minimum: (Number.isFinite(minVal) ? minVal : null), deskripsi: desc, status }
        });
        showToast('KKM/KKTP tersimpan.');
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };
  }

  // ===== Resources (Sumber/Media/Buku Pegangan) =====
  async function loadResources(){
    setStatus('loading resources...');
    const rows = await sbFetch('bk1_resource', { params: { select:'*', teaching_assignment_id: `eq.${active.id}`, order:'created_at.desc', limit:'500' } });
    setStatus('ready');
    return rows || [];
  }

  async function renderResources(){
    const rows = await loadResources();
    const types = ['BUKU','LINK','VIDEO','ALAT','NARASUMBER','LAINNYA'];

    document.getElementById('mainBody').innerHTML = `
      <div class="notice">
        <b>Sumber/Media</b> dipakai untuk mencatat buku pegangan, link video, alat, narasumber, dll.
      </div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;">
        <div class="row"><b>Daftar Sumber</b> <span class="tag">${rows.length} item</span></div>
        <button class="btn small" id="btnReloadRes">Reload</button>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead><tr><th style="width:22mm;">Tipe</th><th>Judul</th><th>Detail</th><th style="width:34mm;">URL</th><th style="width:160px; text-align:right;">Aksi</th></tr></thead>
          <tbody id="resTbody">
            ${rows.map(r=>`
              <tr data-id="${r.id}">
                <td>
                  <select data-k="tipe">
                    ${types.map(t=>`<option value="${t}">${t}</option>`).join('')}
                  </select>
                </td>
                <td><input data-k="judul" value="${escapeHtml(r.judul ?? '')}" /></td>
                <td><input data-k="detail" value="${escapeHtml(r.detail ?? '')}" placeholder="keterangan singkat" /></td>
                <td><input data-k="url" value="${escapeHtml(r.url ?? '')}" placeholder="https://..." /></td>
                <td style="text-align:right;">
                  <button class="btn small" data-act="save">Simpan</button>
                  <button class="btn small danger" data-act="del">Hapus</button>
                </td>
              </tr>
            `).join('') || `<tr><td colspan="5" class="muted">Belum ada sumber.</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="card" style="box-shadow:none; background: rgba(0,0,0,.10);">
        <div class="hd"><h2>Tambah Sumber</h2></div>
        <div class="bd">
          <div class="split">
            <div class="field"><label>Tipe</label>
              <select id="newResType">${types.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
            </div>
            <div class="field"><label>Judul</label><input id="newResTitle" placeholder="Buku/LKPD/Video/..." /></div>
          </div>
          <div class="split">
            <div class="field"><label>Detail</label><input id="newResDetail" placeholder="Penulis/kelas/edisi/keterangan" /></div>
            <div class="field"><label>URL (opsional)</label><input id="newResUrl" placeholder="https://..." /></div>
          </div>
          <div class="row"><button class="btn good" id="btnAddRes">Tambah</button></div>
        </div>
      </div>
    `;

    // set select values per row
    document.querySelectorAll('#resTbody tr[data-id]').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const row = rows.find(x=>String(x.id)===String(id));
      if(row){
        tr.querySelector('select[data-k="tipe"]').value = row.tipe || 'LAINNYA';
      }
    });

    document.getElementById('btnReloadRes').onclick = ()=>renderMain();

    document.getElementById('btnAddRes').onclick = async ()=>{
      try{
        const tipe = document.getElementById('newResType').value;
        const judul = document.getElementById('newResTitle').value.trim();
        if(!judul) return showToast('Judul wajib diisi.', true);
        const detail = document.getElementById('newResDetail').value.trim() || null;
        const url = document.getElementById('newResUrl').value.trim() || null;
        setStatus('saving...');
        await sbFetch('bk1_resource', {
          method:'POST',
          prefer:'return=minimal',
          body:{ teaching_assignment_id: active.id, tipe, judul, detail, url }
        });
        showToast('Sumber ditambahkan.');
        renderMain();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    // row actions
    document.querySelectorAll('#resTbody tr[data-id]').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      tr.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.onclick = async ()=>{
          try{
            const act = btn.getAttribute('data-act');
            if(act === 'del'){
              if(!confirm('Hapus sumber ini?')) return;
              setStatus('deleting...');
              await sbFetch('bk1_resource', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
              showToast('Sumber dihapus.');
              renderMain();
              return;
            }
            if(act === 'save'){
              const tipe = tr.querySelector('[data-k="tipe"]').value;
              const judul = tr.querySelector('[data-k="judul"]').value.trim();
              if(!judul) return showToast('Judul tidak boleh kosong.', true);
              const detail = tr.querySelector('[data-k="detail"]').value.trim() || null;
              const url = tr.querySelector('[data-k="url"]').value.trim() || null;
              setStatus('saving...');
              await sbFetch('bk1_resource', { method:'PATCH', prefer:'return=minimal', params:{ id:`eq.${id}` }, body:{ tipe, judul, detail, url } });
              showToast('Sumber disimpan.');
              setStatus('ready');
              return;
            }
          }catch(e){ showToast(e.message, true); setStatus('error'); }
        };
      });
    });
  }


  // ===== BK1 Tambahan (BK1 v3): Lampiran, Kalender, SK/Beban, Pemetaan, Model/Metode =====
  function isMissingTableErr(msg){
    const m = (msg||"").toLowerCase();
    return m.includes('relation') && m.includes('does not exist');
  }
  function missingTableNotice(table){
    return `<div class="notice">Modul ini butuh tabel <span class="mono">${escapeHtml(table)}</span>. Jalankan file <span class="mono">migration.sql</span> (di folder ZIP) pada Supabase SQL Editor.</div>`;
  }

  async function safeFetchTable(table, opts){
    try{ return await sbFetch(table, opts); }
    catch(e){
      if(isMissingTableErr(e.message)) return { __missing_table: table, __error: e };
      throw e;
    }
  }

  // --- Lampiran (upload ke tabel file_asset.data_url + relasi bk1_attachment)
  async function renderAttachments(){
    const body = document.getElementById('mainBody');
    body.innerHTML = `
      <div class="notice">Lampiran disimpan sebagai <span class="mono">data_url</span> di tabel <span class="mono">file_asset</span> (tanpa Storage/Auth). Cocok untuk file kecil-menengah. Untuk file besar, nanti kita upgrade ke Storage.</div>
      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Tambah Lampiran</h2></div>
        <div class="bd">
          <div class="row">
            <div style="flex:1; min-width:240px;">
              <div class="field"><label>Label Lampiran</label><input id="attLabel" placeholder="Contoh: SK Pembelajaran, RPP PDF, dll" /></div>
            </div>
            <div style="width:180px; min-width:180px;">
              <div class="field"><label>Kategori</label>
                <select id="attCat">
                  <option value="ADMIN">ADMIN</option>
                  <option value="PEMBELAJARAN">PEMBELAJARAN</option>
                  <option value="ASESMEN">ASESMEN</option>
                  <option value="LAINNYA">LAINNYA</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <input type="file" id="attFile" />
            <button class="btn good" id="btnUploadAtt">Upload</button>
          </div>
          <div id="attMsg" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Daftar Lampiran</h2><span class="tag" id="attCount">0</span></div>
        <div class="bd">
          <div style="max-height:420px; overflow:auto;">
            <table>
              <thead><tr><th>Label</th><th>Kategori</th><th>File</th><th style="text-align:right;">Aksi</th></tr></thead>
              <tbody id="attTbody"><tr><td colspan="4" class="muted">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    const showAttMsg = (type, msg)=>{ document.getElementById('attMsg').innerHTML = msgBox(type, msg); };

    const res = await safeFetchTable('bk1_attachment', {
      params:{
        select:'id,label,kategori,catatan,asset_id,created_at,file_asset(id,filename,mime,size)',
        teaching_assignment_id:`eq.${active.id}`,
        order:'created_at.desc',
        limit:'500'
      }
    });

    if(res.__missing_table){
      showAttMsg('notice', missingTableNotice('bk1_attachment'));
      document.getElementById('attTbody').innerHTML = `<tr><td colspan="4">-</td></tr>`;
      document.getElementById('attCount').textContent = '0';
    } else {
      const rows = Array.isArray(res) ? res : [];
      document.getElementById('attCount').textContent = String(rows.length);
      document.getElementById('attTbody').innerHTML = rows.map(r=>{
        const f = r.file_asset || {};
        const fname = f.filename || ('asset #' + r.asset_id);
        return `
          <tr data-id="${r.id}" data-asset="${r.asset_id}">
            <td>${safeCell(r.label||'-')}</td>
            <td>${safeCell(r.kategori||'-')}</td>
            <td>${safeCell(fname)}</td>
            <td style="text-align:right; white-space:nowrap;">
              <button class="btn small" data-act="dl">Download</button>
              <button class="btn small danger" data-act="del">Hapus</button>
            </td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="4">-</td></tr>`;
    }

    document.getElementById('btnUploadAtt').onclick = async ()=>{
      const label = document.getElementById('attLabel').value.trim() || null;
      const kategori = document.getElementById('attCat').value;
      const file = document.getElementById('attFile').files[0];
      if(!file) return showToast('Pilih file dulu.', true);
      try{
        setStatus('uploading...');
        const dataUrl = await new Promise((resolve, reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(String(r.result||''));
          r.onerror = ()=>reject(new Error('Gagal membaca file.'));
          r.readAsDataURL(file);
        });
        const assetIns = await sbFetch('file_asset', { method:'POST', prefer:'return=representation', body:{ filename:file.name, mime:file.type||null, size:file.size||null, data_url:dataUrl } });
        const asset = Array.isArray(assetIns) ? assetIns[0] : assetIns;
        await sbFetch('bk1_attachment', { method:'POST', prefer:'return=minimal', body:{ teaching_assignment_id: active.id, asset_id: asset.id, label, kategori, catatan: null } });
        showToast('Lampiran diupload.');
        view='attachments';
        await renderMain();
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    body.querySelectorAll('#attTbody tr').forEach(tr=>{
      tr.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = tr.getAttribute('data-id');
          const assetId = tr.getAttribute('data-asset');
          const act = btn.getAttribute('data-act');
          try{
            if(act==='dl'){
              setStatus('loading...');
              const a = await sbFetch('file_asset', { params:{ select:'*', id:`eq.${assetId}` } });
              const row = (a&&a[0])||null;
              if(!row||!row.data_url) throw new Error('File tidak ditemukan (data_url kosong).');
              const link = document.createElement('a');
              link.href = row.data_url;
              link.download = row.filename || 'lampiran';
              document.body.appendChild(link);
              link.click();
              link.remove();
              setStatus('ready');
              return;
            }
            if(act==='del'){
              if(!confirm('Hapus lampiran ini?')) return;
              setStatus('deleting...');
              await sbFetch('bk1_attachment', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
              showToast('Lampiran dihapus.');
              view='attachments';
              await renderMain();
              setStatus('ready');
            }
          }catch(e){ showToast(e.message, true); setStatus('error'); }
        };
      });
    });
  }

  // --- Kalender Pendidikan (per tahun ajaran/semester)
  async function renderCalendar(){
    const body = document.getElementById('mainBody');
    const termId = active.academic_term?.id;
    body.innerHTML = `
      <div class="notice">Kalender pendidikan madrasah biasanya mengacu ke pedoman Ditjen Pendis (Kemenag) dan penyesuaian daerah/pontren. Modul ini menyimpan event per <b>tahun ajaran/semester</b>.</div>
      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Tambah Event Kalender</h2></div>
        <div class="bd">
          <div class="row">
            <div style="width:180px; min-width:180px;"><div class="field"><label>Tanggal</label><input type="date" id="calDate" /></div></div>
            <div style="width:220px; min-width:220px;"><div class="field"><label>Tipe</label>
              <select id="calType">
                <option value="AKADEMIK">AKADEMIK</option>
                <option value="LIBUR_NASIONAL">LIBUR_NASIONAL</option>
                <option value="LIBUR_DAERAH">LIBUR_DAERAH</option>
                <option value="KEGIATAN">KEGIATAN</option>
              </select>
            </div></div>
            <div style="flex:1; min-width:240px;"><div class="field"><label>Nama Event</label><input id="calName" placeholder="Contoh: MPLS / ASAS / Libur Idul Fitri" /></div></div>
          </div>
          <div class="field"><label>Keterangan</label><textarea id="calNote" placeholder="Opsional"></textarea></div>
          <div class="row"><button class="btn good" id="btnAddCal">Tambah</button></div>
          <div id="calMsg" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Daftar Event</h2><span class="tag" id="calCount">0</span></div>
        <div class="bd">
          <div style="max-height:420px; overflow:auto;">
            <table>
              <thead><tr><th>Tanggal</th><th>Tipe</th><th>Nama</th><th style="text-align:right;">Aksi</th></tr></thead>
              <tbody id="calTbody"><tr><td colspan="4" class="muted">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    const showCalMsg = (type, msg)=>{ document.getElementById('calMsg').innerHTML = msgBox(type, msg); };
    if(!termId){ showCalMsg('err', 'Academic term belum terbaca di assignment ini.'); return; }

    const res = await safeFetchTable('bk1_calendar_event', { params:{ select:'*', academic_term_id:`eq.${termId}`, order:'tanggal.asc', limit:'2000' } });
    if(res.__missing_table){
      showCalMsg('notice', missingTableNotice('bk1_calendar_event'));
      document.getElementById('calTbody').innerHTML = `<tr><td colspan="4">-</td></tr>`;
      document.getElementById('calCount').textContent = '0';
    } else {
      const rows = Array.isArray(res) ? res : [];
      document.getElementById('calCount').textContent = String(rows.length);
      document.getElementById('calTbody').innerHTML = rows.map(r=>`
        <tr data-id="${r.id}">
          <td>${safeCell(r.tanggal||'')}</td>
          <td>${safeCell(r.tipe||'')}</td>
          <td>${safeCell(r.nama||'')}</td>
          <td style="text-align:right;"><button class="btn small danger" data-act="del">Hapus</button></td>
        </tr>
      `).join('') || `<tr><td colspan="4">-</td></tr>`;
    }

    document.getElementById('btnAddCal').onclick = async ()=>{
      const tanggal = document.getElementById('calDate').value;
      const tipe = document.getElementById('calType').value;
      const nama = document.getElementById('calName').value.trim();
      const keterangan = document.getElementById('calNote').value.trim() || null;
      if(!tanggal || !nama) return showToast('Tanggal & nama wajib diisi.', true);
      try{
        setStatus('saving...');
        await sbFetch('bk1_calendar_event', { method:'POST', prefer:'return=minimal', body:{ academic_term_id: termId, tanggal, tipe, nama, keterangan } });
        showToast('Event ditambah.');
        view='calendar';
        await renderMain();
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    body.querySelectorAll('#calTbody tr[data-id]').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const btn = tr.querySelector('button[data-act="del"]');
      if(btn) btn.onclick = async ()=>{
        if(!confirm('Hapus event ini?')) return;
        try{
          setStatus('deleting...');
          await sbFetch('bk1_calendar_event', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
          showToast('Event dihapus.');
          view='calendar';
          await renderMain();
          setStatus('ready');
        }catch(e){ showToast(e.message, true); setStatus('error'); }
      };
    });
  }

  // --- SK Pembagian Tugas / Beban Mengajar (lampiran administratif)
  async function renderSKBeban(){
    const body = document.getElementById('mainBody');
    const termId = active.academic_term?.id;
    const teacherId = active.teacher?.id;
    body.innerHTML = `
      <div class="notice">SK pembagian tugas/beban mengajar biasanya diputuskan per <b>tahun ajaran</b>. Di sini bisa disimpan nomor SK + lampiran file.</div>
      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Tambah Dokumen</h2></div>
        <div class="bd">
          <div class="row">
            <div style="width:240px; min-width:240px;"><div class="field"><label>Jenis</label>
              <select id="skJenis">
                <option value="SK_PEMBAGIAN_TUGAS">SK_PEMBAGIAN_TUGAS</option>
                <option value="BEBAN_MENGAJAR">BEBAN_MENGAJAR</option>
                <option value="LAINNYA">LAINNYA</option>
              </select>
            </div></div>
            <div style="flex:1; min-width:240px;"><div class="field"><label>Nomor</label><input id="skNomor" placeholder="Contoh: 123/...." /></div></div>
            <div style="width:180px; min-width:180px;"><div class="field"><label>Tanggal</label><input type="date" id="skTanggal" /></div></div>
          </div>
          <div class="field"><label>Tentang</label><input id="skTentang" placeholder="Contoh: Pembagian Tugas Guru Semester Ganjil" /></div>
          <div class="row"><input type="file" id="skFile" /><button class="btn good" id="btnAddSk">Simpan</button></div>
          <div id="skMsg" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Daftar Dokumen</h2><span class="tag" id="skCount">0</span></div>
        <div class="bd">
          <div style="max-height:420px; overflow:auto;">
            <table>
              <thead><tr><th>Jenis</th><th>Nomor</th><th>Tanggal</th><th>Tentang</th><th style="text-align:right;">Aksi</th></tr></thead>
              <tbody id="skTbody"><tr><td colspan="5" class="muted">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    const showSkMsg = (type, msg)=>{ document.getElementById('skMsg').innerHTML = msgBox(type, msg); };
    if(!termId){ showSkMsg('err', 'Academic term belum terbaca.'); return; }

    const params = { select:'id,jenis,nomor,tanggal,tentang,asset_id,file_asset(id,filename)', academic_term_id:`eq.${termId}`, order:'tanggal.desc', limit:'500' };
    if(teacherId) params.teacher_id = `eq.${teacherId}`;

    const res = await safeFetchTable('bk1_admin_doc', { params });
    if(res.__missing_table){
      showSkMsg('notice', missingTableNotice('bk1_admin_doc'));
      document.getElementById('skTbody').innerHTML = `<tr><td colspan="5">-</td></tr>`;
      document.getElementById('skCount').textContent = '0';
    } else {
      const rows = Array.isArray(res) ? res : [];
      document.getElementById('skCount').textContent = String(rows.length);
      document.getElementById('skTbody').innerHTML = rows.map(r=>{
        const fname = r.file_asset?.filename || (r.asset_id ? ('asset #' + r.asset_id) : '-');
        return `
          <tr data-id="${r.id}" data-asset="${r.asset_id||''}">
            <td>${safeCell(r.jenis||'-')}</td>
            <td>${safeCell(r.nomor||'-')}</td>
            <td>${safeCell(r.tanggal||'-')}</td>
            <td>${safeCell(r.tentang||'-')}<br><span class="muted" style="font-size:12px;">${safeCell(fname)}</span></td>
            <td style="text-align:right; white-space:nowrap;">
              ${r.asset_id?'<button class="btn small" data-act="dl">Download</button>':''}
              <button class="btn small danger" data-act="del">Hapus</button>
            </td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="5">-</td></tr>`;
    }

    document.getElementById('btnAddSk').onclick = async ()=>{
      const jenis = document.getElementById('skJenis').value;
      const nomor = document.getElementById('skNomor').value.trim() || null;
      const tanggal = document.getElementById('skTanggal').value || null;
      const tentang = document.getElementById('skTentang').value.trim() || null;
      const file = document.getElementById('skFile').files[0] || null;
      try{
        setStatus('saving...');
        let asset_id = null;
        if(file){
          const dataUrl = await new Promise((resolve, reject)=>{
            const r = new FileReader();
            r.onload = ()=>resolve(String(r.result||''));
            r.onerror = ()=>reject(new Error('Gagal membaca file.'));
            r.readAsDataURL(file);
          });
          const assetIns = await sbFetch('file_asset', { method:'POST', prefer:'return=representation', body:{ filename:file.name, mime:file.type||null, size:file.size||null, data_url:dataUrl } });
          const asset = Array.isArray(assetIns) ? assetIns[0] : assetIns;
          asset_id = asset.id;
        }
        await sbFetch('bk1_admin_doc', { method:'POST', prefer:'return=minimal', body:{ academic_term_id: termId, teacher_id: teacherId||null, jenis, nomor, tanggal, tentang, asset_id } });
        showToast('Dokumen disimpan.');
        view='sk';
        await renderMain();
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    body.querySelectorAll('#skTbody tr[data-id]').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const assetId = tr.getAttribute('data-asset');
      tr.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.onclick = async ()=>{
          const act = btn.getAttribute('data-act');
          try{
            if(act==='dl'){
              setStatus('loading...');
              const a = await sbFetch('file_asset', { params:{ select:'*', id:`eq.${assetId}` } });
              const row = (a&&a[0])||null;
              if(!row||!row.data_url) throw new Error('File tidak ditemukan (data_url kosong).');
              const link = document.createElement('a');
              link.href = row.data_url;
              link.download = row.filename || 'dokumen';
              document.body.appendChild(link);
              link.click();
              link.remove();
              setStatus('ready');
              return;
            }
            if(act==='del'){
              if(!confirm('Hapus dokumen ini?')) return;
              setStatus('deleting...');
              await sbFetch('bk1_admin_doc', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
              showToast('Dokumen dihapus.');
              view='sk';
              await renderMain();
              setStatus('ready');
            }
          }catch(e){ showToast(e.message, true); setStatus('error'); }
        };
      });
    });
  }

  // --- Pemetaan CP→TP / KI-KD + indikator (matriks)
  async function renderMapping(){
    const body = document.getElementById('mainBody');
    body.innerHTML = `
      <div class="notice">Matriks pemetaan: <b>CP/KD</b> → <b>TP/Indikator</b> → Materi/Asesmen → (opsional) Minggu/Pertemuan.</div>
      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Tambah Baris Pemetaan</h2></div>
        <div class="bd">
          <div class="row">
            <div style="width:180px; min-width:180px;"><div class="field"><label>Kurikulum</label>
              <select id="mapKuri"><option value="KURMER">KURMER</option><option value="K13">K13</option></select>
            </div></div>
            <div style="flex:1; min-width:240px;"><div class="field"><label>CP / KD</label><input id="mapCpKd" placeholder="Contoh: CP Fikih Fase D / KD 3.1" /></div></div>
          </div>
          <div class="field"><label>TP / Indikator</label><textarea id="mapTpInd" placeholder="Tuliskan TP atau indikator rinci"></textarea></div>
          <div class="row">
            <div style="flex:1; min-width:240px;"><div class="field"><label>Materi</label><input id="mapMateri" placeholder="Ringkas" /></div></div>
            <div style="flex:1; min-width:240px;"><div class="field"><label>Asesmen</label><input id="mapAses" placeholder="Contoh: Observasi, tes tulis, praktik" /></div></div>
          </div>
          <div class="row">
            <div style="width:140px; min-width:140px;"><div class="field"><label>Minggu</label><input type="number" id="mapMinggu" placeholder="ops" /></div></div>
            <div style="width:140px; min-width:140px;"><div class="field"><label>Pertemuan</label><input type="number" id="mapPert" placeholder="ops" /></div></div>
            <div style="flex:1; min-width:240px;"><div class="field"><label>Catatan</label><input id="mapNote" placeholder="opsional" /></div></div>
          </div>
          <div class="row"><button class="btn good" id="btnAddMap">Tambah</button></div>
          <div id="mapMsg" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Matriks Pemetaan</h2><span class="tag" id="mapCount">0</span></div>
        <div class="bd">
          <div style="max-height:460px; overflow:auto;">
            <table>
              <thead><tr><th>K</th><th>CP/KD</th><th>TP/Indikator</th><th>Materi</th><th>Asesmen</th><th>M</th><th>P</th><th style="text-align:right;">Aksi</th></tr></thead>
              <tbody id="mapTbody"><tr><td colspan="8" class="muted">Memuat...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    const showMapMsg = (type, msg)=>{ document.getElementById('mapMsg').innerHTML = msgBox(type, msg); };

    const res = await safeFetchTable('bk1_mapping_matrix', { params:{ select:'*', teaching_assignment_id:`eq.${active.id}`, order:'id.asc', limit:'2000' } });
    if(res.__missing_table){
      showMapMsg('notice', missingTableNotice('bk1_mapping_matrix'));
      document.getElementById('mapTbody').innerHTML = `<tr><td colspan="8">-</td></tr>`;
      document.getElementById('mapCount').textContent = '0';
    } else {
      const rows = Array.isArray(res) ? res : [];
      document.getElementById('mapCount').textContent = String(rows.length);
      document.getElementById('mapTbody').innerHTML = rows.map(r=>`
        <tr data-id="${r.id}">
          <td>${safeCell(r.kurikulum||'')}</td>
          <td>${safeCell(r.cp_kd||'')}</td>
          <td>${safeCell(r.tp_indikator||'')}</td>
          <td>${safeCell(r.materi||'')}</td>
          <td>${safeCell(r.asesmen||'')}</td>
          <td>${safeCell(r.minggu_ke??'')}</td>
          <td>${safeCell(r.pertemuan_ke??'')}</td>
          <td style="text-align:right;"><button class="btn small danger" data-act="del">Hapus</button></td>
        </tr>
      `).join('') || `<tr><td colspan="8">-</td></tr>`;
    }

    document.getElementById('btnAddMap').onclick = async ()=>{
      const kurikulum = document.getElementById('mapKuri').value;
      const cp_kd = document.getElementById('mapCpKd').value.trim();
      const tp_indikator = document.getElementById('mapTpInd').value.trim();
      const materi = document.getElementById('mapMateri').value.trim() || null;
      const asesmen = document.getElementById('mapAses').value.trim() || null;
      const minggu_ke = intOrNull(document.getElementById('mapMinggu').value);
      const pertemuan_ke = intOrNull(document.getElementById('mapPert').value);
      const catatan = document.getElementById('mapNote').value.trim() || null;
      if(!cp_kd || !tp_indikator) return showToast('CP/KD dan TP/Indikator wajib diisi.', true);
      try{
        setStatus('saving...');
        await sbFetch('bk1_mapping_matrix', { method:'POST', prefer:'return=minimal', body:{ teaching_assignment_id: active.id, kurikulum, cp_kd, tp_indikator, materi, asesmen, minggu_ke, pertemuan_ke, catatan } });
        showToast('Baris pemetaan ditambah.');
        view='mapping';
        await renderMain();
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    body.querySelectorAll('#mapTbody tr[data-id]').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const btn = tr.querySelector('button[data-act="del"]');
      if(btn) btn.onclick = async ()=>{
        if(!confirm('Hapus baris ini?')) return;
        try{
          setStatus('deleting...');
          await sbFetch('bk1_mapping_matrix', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
          showToast('Baris dihapus.');
          view='mapping';
          await renderMain();
          setStatus('ready');
        }catch(e){ showToast(e.message, true); setStatus('error'); }
      };
    });
  }

  // --- Perencanaan Model/Metode (dokumen formal)
  async function renderModelMetode(){
    const body = document.getElementById('mainBody');
    body.innerHTML = `
      <div class="notice">Bagian ini untuk mencatat <b>model pembelajaran</b> (PBL/PjBL/dll), metode, media, strategi, dan hal-hal formal lain yang biasanya diminta saat audit/perangkat.</div>
      <div class="hr"></div>
      <div id="mmWrap"></div>
    `;

    const existing = await safeFetchTable('bk1_model_metode', { params:{ select:'*', teaching_assignment_id:`eq.${active.id}`, limit:'1' } });
    if(existing.__missing_table){
      document.getElementById('mmWrap').innerHTML = missingTableNotice('bk1_model_metode');
      return;
    }

    const row = (Array.isArray(existing) && existing[0]) ? existing[0] : null;
    const model = row?.model || '';
    const metode = row?.metode || '';
    const pendekatan = row?.pendekatan || '';
    const media = row?.media || '';
    const strategi = row?.strategi || '';
    const diferensiasi = row?.diferensiasi || '';
    const catatan = row?.catatan || '';
    const status = row?.status || 'DRAFT';

    document.getElementById('mmWrap').innerHTML = `
      <div class="card" style="box-shadow:none;">
        <div class="hd"><h2>Perencanaan Model/Metode</h2></div>
        <div class="bd">
          <div class="row">
            <div style="flex:1; min-width:220px;"><div class="field"><label>Model Pembelajaran</label><input id="mmModel" value="${escapeHtml(model)}" placeholder="Contoh: PBL / PjBL / Inquiry / Blended" /></div></div>
            <div style="width:200px; min-width:200px;"><div class="field"><label>Status</label>
              <select id="mmStatus">
                <option value="DRAFT">DRAFT</option>
                <option value="FINAL">FINAL</option>
              </select>
            </div></div>
          </div>
          <div class="field"><label>Metode</label><textarea id="mmMetode" placeholder="Diskusi, demonstrasi, praktik, dst">${escapeHtml(metode)}</textarea></div>
          <div class="field"><label>Pendekatan</label><input id="mmPendekatan" value="${escapeHtml(pendekatan)}" placeholder="Contoh: Saintifik / Kontekstual" /></div>
          <div class="field"><label>Media/Alat/Bahan</label><textarea id="mmMedia" placeholder="Buku, PPT, video, alat peraga...">${escapeHtml(media)}</textarea></div>
          <div class="field"><label>Strategi/Skema (ringkas)</label><textarea id="mmStrategi" placeholder="Langkah besar / alur pembelajaran...">${escapeHtml(strategi)}</textarea></div>
          <div class="field"><label>Diferensiasi</label><textarea id="mmDif" placeholder="Konten/proses/produk...">${escapeHtml(diferensiasi)}</textarea></div>
          <div class="field"><label>Catatan</label><textarea id="mmCat" placeholder="Opsional">${escapeHtml(catatan)}</textarea></div>
          <div class="row"><button class="btn good" id="btnSaveMM">Simpan</button></div>
        </div>
      </div>
    `;

    document.getElementById('mmStatus').value = status;

    document.getElementById('btnSaveMM').onclick = async ()=>{
      try{
        setStatus('saving...');
        const payload = {
          teaching_assignment_id: active.id,
          model: document.getElementById('mmModel').value.trim() || null,
          metode: document.getElementById('mmMetode').value.trim() || null,
          pendekatan: document.getElementById('mmPendekatan').value.trim() || null,
          media: document.getElementById('mmMedia').value.trim() || null,
          strategi: document.getElementById('mmStrategi').value.trim() || null,
          diferensiasi: document.getElementById('mmDif').value.trim() || null,
          catatan: document.getElementById('mmCat').value.trim() || null,
          status: document.getElementById('mmStatus').value
        };

        if(row?.id){
          await sbFetch('bk1_model_metode', { method:'PATCH', prefer:'return=minimal', params:{ id:`eq.${row.id}` }, body: payload });
        } else {
          await sbFetch('bk1_model_metode', { method:'POST', prefer:'return=minimal', body: payload });
        }
        showToast('Perencanaan disimpan.');
        view='model';
        await renderMain();
        setStatus('ready');
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };
  }



  // ===== BK1 tambahan: Lampiran, Kalender, SK/Beban, Pemetaan, Model/Metode =====
  function missingTableNotice(table){
    return `<div class="notice">Tabel <span class="mono">${escapeHtml(table)}</span> belum ada. Jalankan <span class="mono">migration.sql</span> (di folder ZIP) pada Supabase SQL Editor, lalu reload.</div>`;
  }

  async function safeFetchTable(table, opts){
    try{ return await sbFetch(table, opts); }
    catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      // pesan khas PostgREST saat tabel belum ada
      if(msg.toLowerCase().includes('relation') && msg.toLowerCase().includes('does not exist')){
        return { __missing_table: table, __error: msg };
      }
      throw e;
    }
  }

  // ---- Lampiran (file_asset + bk1_attachment) ----
  async function renderAttachments(){
    const tbodyId = 'attTbody';
    document.getElementById('mainBody').innerHTML = `
      <div class="notice">
        Lampiran menyimpan file ke tabel <span class="mono">file_asset</span> (kolom <span class="mono">data_url</span>) lalu dihubungkan via <span class="mono">bk1_attachment</span>.
        Ini MVP: cocok untuk file kecil/menengah. Untuk file besar nanti kita migrasi ke Storage.
      </div>
      <div class="hr"></div>
      <div class="row" style="align-items:flex-end;">
        <div class="field" style="flex:2; min-width:220px;">
          <label>Label Lampiran</label>
          <input id="attLabel" placeholder="Contoh: SK Pembagian Tugas, RPP Final, Lembar Observasi" />
        </div>
        <div class="field" style="flex:1; min-width:170px;">
          <label>Kategori</label>
          <select id="attCat">
            <option value="ADMIN">ADMIN</option>
            <option value="PEMBELAJARAN">PEMBELAJARAN</option>
            <option value="ASESMEN">ASESMEN</option>
            <option value="LAINNYA">LAINNYA</option>
          </select>
        </div>
        <div class="field" style="flex:2; min-width:220px;">
          <label>Pilih file</label>
          <input id="attFile" type="file" />
        </div>
        <button class="btn good" id="btnUploadAtt">Upload</button>
      </div>
      <div class="hr"></div>
      <table>
        <thead>
          <tr>
            <th>Label</th><th>Kategori</th><th>Nama File</th><th>Ukuran</th><th style="text-align:right;">Aksi</th>
          </tr>
        </thead>
        <tbody id="${tbodyId}"><tr><td colspan="5" class="muted">Memuat...</td></tr></tbody>
      </table>
    `;

    const list = await safeFetchTable('bk1_attachment', {
      params:{
        select:'id,label,kategori,catatan,created_at,asset_id,file_asset(id,filename,mime,size)',
        teaching_assignment_id:`eq.${active.id}`,
        order:'created_at.desc',
        limit:'500'
      }
    });

    if(list && list.__missing_table){
      document.getElementById('mainBody').innerHTML = missingTableNotice(list.__missing_table);
      return;
    }

    const tbody = document.getElementById(tbodyId);
    const rows = Array.isArray(list) ? list : [];
    if(!rows.length){ tbody.innerHTML = `<tr><td colspan="5" class="muted">Belum ada lampiran.</td></tr>`; }
    else {
      tbody.innerHTML = rows.map(r=>{
        const fa = r.file_asset || {};
        const size = fa.size ? (Math.round(fa.size/1024)+' KB') : '-';
        return `
          <tr>
            <td>${safeCell(r.label||'-')}</td>
            <td>${safeCell(r.kategori||'-')}</td>
            <td>${safeCell(fa.filename||'-')}</td>
            <td>${safeCell(size)}</td>
            <td style="text-align:right;">
              <button class="btn small" data-act="dl" data-aid="${fa.id||''}" ${fa.id?'' : 'disabled'}>Download</button>
              <button class="btn small danger" data-act="del" data-id="${r.id}">Hapus</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('btnUploadAtt').onclick = async ()=>{
      try{
        const label = document.getElementById('attLabel').value.trim() || null;
        const kategori = document.getElementById('attCat').value;
        const file = document.getElementById('attFile').files[0];
        if(!file) return showToast('Pilih file dulu.', true);
        setStatus('uploading...');
        const data_url = await readFileAsDataURL(file);
        // simpan asset
        const fa = await sbFetch('file_asset', { method:'POST', prefer:'return=representation', body:{ filename:file.name, mime:file.type||null, size:file.size||null, data_url } });
        const assetId = (Array.isArray(fa) && fa[0] && fa[0].id) ? fa[0].id : (fa.id||null);
        if(!assetId) throw new Error('Gagal menyimpan file_asset.');
        await sbFetch('bk1_attachment', { method:'POST', prefer:'return=minimal', body:{ teaching_assignment_id: active.id, label, kategori, asset_id: assetId } });
        showToast('Lampiran diupload.');
        setStatus('ready');
        await renderAttachments();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      try{
        if(act==='del'){
          const id = btn.dataset.id;
          if(!confirm('Hapus lampiran ini?')) return;
          setStatus('deleting...');
          await sbFetch('bk1_attachment', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
          showToast('Lampiran dihapus.');
          setStatus('ready');
          await renderAttachments();
        }
        if(act==='dl'){
          const aid = btn.dataset.aid;
          if(!aid) return;
          setStatus('loading...');
          const got = await sbFetch('file_asset', { params:{ select:'id,filename,data_url,mime', id:`eq.${aid}`, limit:'1' } });
          const one = Array.isArray(got) ? got[0] : got;
          if(!one || !one.data_url) throw new Error('File tidak ditemukan / kosong.');
          downloadDataUrl(one.data_url, one.filename || ('lampiran-'+aid));
          setStatus('ready');
        }
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    }, { once:true });
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onerror = ()=>reject(new Error('Gagal membaca file.'));
      fr.onload = ()=>resolve(String(fr.result||''));
      fr.readAsDataURL(file);
    });
  }

  function downloadDataUrl(dataUrl, filename){
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ---- Kalender Pendidikan (manual) ----
  async function renderCalendar(){
    const termId = active.academic_term?.id;
    document.getElementById('mainBody').innerHTML = `
      <div class="notice">Kalender pendidikan di BK1 mengikuti pedoman Kemenag (madrasah) + penyesuaian Kanwil/Daerah. Di sini kita input manual event penting: awal semester, PTS/PAS, libur nasional/daerah, dll.</div>
      <div class="hr"></div>
      <div class="row" style="align-items:flex-end;">
        <div class="field" style="flex:1; min-width:160px;"><label>Tanggal</label><input id="calDate" type="date" /></div>
        <div class="field" style="flex:1; min-width:180px;"><label>Tipe</label>
          <select id="calType">
            <option value="AKADEMIK">AKADEMIK</option>
            <option value="LIBUR_NASIONAL">LIBUR_NASIONAL</option>
            <option value="LIBUR_DAERAH">LIBUR_DAERAH</option>
            <option value="KEGIATAN">KEGIATAN</option>
          </select>
        </div>
        <div class="field" style="flex:2; min-width:220px;"><label>Nama</label><input id="calName" placeholder="Contoh: MPLS, PTS, Libur Idul Fitri" /></div>
        <div class="field" style="flex:2; min-width:220px;"><label>Keterangan</label><input id="calNote" placeholder="Opsional" /></div>
        <button class="btn good" id="btnAddCal">Tambah</button>
      </div>
      <div class="hr"></div>
      <table>
        <thead><tr><th style="width:30mm;">Tanggal</th><th style="width:40mm;">Tipe</th><th>Nama</th><th style="text-align:right;">Aksi</th></tr></thead>
        <tbody id="calTbody"><tr><td colspan="4" class="muted">Memuat...</td></tr></tbody>
      </table>
    `;

    if(!termId){
      document.getElementById('calTbody').innerHTML = `<tr><td colspan="4" class="muted">Academic term belum ada pada assignment ini.</td></tr>`;
      return;
    }

    const rows = await safeFetchTable('bk1_calendar_event', { params:{ select:'*', academic_term_id:`eq.${termId}`, order:'tanggal.asc', limit:'1000' } });
    if(rows && rows.__missing_table){
      document.getElementById('mainBody').innerHTML = missingTableNotice(rows.__missing_table);
      return;
    }

    const tbody = document.getElementById('calTbody');
    const arr = Array.isArray(rows) ? rows : [];
    tbody.innerHTML = arr.length ? arr.map(r=>`
      <tr>
        <td>${safeCell(r.tanggal||'')}</td>
        <td>${safeCell(r.tipe||'')}</td>
        <td>${safeCell(r.nama||'')}${r.keterangan?`<br><span class="muted" style="font-size:12px;">${safeCell(r.keterangan)}</span>`:''}</td>
        <td style="text-align:right;"><button class="btn small danger" data-id="${r.id}">Hapus</button></td>
      </tr>
    `).join('') : `<tr><td colspan="4" class="muted">Belum ada event.</td></tr>`;

    document.getElementById('btnAddCal').onclick = async ()=>{
      try{
        const tanggal = document.getElementById('calDate').value;
        const tipe = document.getElementById('calType').value;
        const nama = document.getElementById('calName').value.trim();
        const keterangan = document.getElementById('calNote').value.trim() || null;
        if(!tanggal || !nama) return showToast('Tanggal dan nama wajib diisi.', true);
        setStatus('saving...');
        await sbFetch('bk1_calendar_event', { method:'POST', prefer:'return=minimal', body:{ academic_term_id: termId, tanggal, tipe, nama, keterangan } });
        showToast('Event ditambahkan.');
        setStatus('ready');
        await renderCalendar();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    tbody.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-id]');
      if(!b) return;
      if(!confirm('Hapus event kalender?')) return;
      try{
        setStatus('deleting...');
        await sbFetch('bk1_calendar_event', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${b.dataset.id}` } });
        showToast('Event dihapus.');
        setStatus('ready');
        await renderCalendar();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    }, { once:true });
  }

  // ---- SK Pembagian Tugas / Beban Mengajar (lampiran administratif) ----
  async function renderSK(){
    const termId = active.academic_term?.id;
    const teacherId = active.teacher?.id;
    document.getElementById('mainBody').innerHTML = `
      <div class="notice">SK Pembagian Tugas & beban mengajar disimpan sebagai dokumen administratif per tahun ajaran/semester (dan bisa diikat ke guru).</div>
      <div class="hr"></div>
      <div class="row" style="align-items:flex-end;">
        <div class="field" style="flex:1; min-width:160px;"><label>Nomor SK</label><input id="skNo" placeholder="Contoh: 123/UPMP/HK/I/2026" /></div>
        <div class="field" style="flex:1; min-width:160px;"><label>Tanggal</label><input id="skDate" type="date" /></div>
        <div class="field" style="flex:2; min-width:240px;"><label>Tentang</label><input id="skAbout" placeholder="Pembagian Tugas Mengajar Semester ..." /></div>
        <div class="field" style="flex:2; min-width:240px;"><label>Lampiran (file)</label><input id="skFile" type="file" /></div>
        <button class="btn good" id="btnAddSK">Simpan</button>
      </div>
      <div class="hr"></div>
      <table>
        <thead><tr><th>Nomor</th><th style="width:28mm;">Tanggal</th><th>Tentang</th><th style="text-align:right;">Aksi</th></tr></thead>
        <tbody id="skTbody"><tr><td colspan="4" class="muted">Memuat...</td></tr></tbody>
      </table>
    `;

    if(!termId){
      document.getElementById('skTbody').innerHTML = `<tr><td colspan="4" class="muted">Academic term belum ada pada assignment ini.</td></tr>`;
      return;
    }

    const docs = await safeFetchTable('bk1_admin_doc', { params:{ select:'id,nomor,tanggal,tentang,asset_id,file_asset(id,filename)', academic_term_id:`eq.${termId}`, teacher_id: teacherId?`eq.${teacherId}`:undefined, order:'tanggal.desc', limit:'200' } });
    if(docs && docs.__missing_table){
      document.getElementById('mainBody').innerHTML = missingTableNotice(docs.__missing_table);
      return;
    }

    const tbody = document.getElementById('skTbody');
    const arr = Array.isArray(docs) ? docs : [];
    tbody.innerHTML = arr.length ? arr.map(d=>`
      <tr>
        <td>${safeCell(d.nomor||'-')}${d.file_asset?.filename?`<br><span class="muted" style="font-size:12px;">${safeCell(d.file_asset.filename)}</span>`:''}</td>
        <td>${safeCell(d.tanggal||'')}</td>
        <td>${safeCell(d.tentang||'')}</td>
        <td style="text-align:right;">
          <button class="btn small" data-act="dl" data-aid="${d.asset_id||''}" ${d.asset_id?'' : 'disabled'}>Download</button>
          <button class="btn small danger" data-id="${d.id}">Hapus</button>
        </td>
      </tr>
    `).join('') : `<tr><td colspan="4" class="muted">Belum ada dokumen.</td></tr>`;

    document.getElementById('btnAddSK').onclick = async ()=>{
      try{
        const nomor = document.getElementById('skNo').value.trim() || null;
        const tanggal = document.getElementById('skDate').value || null;
        const tentang = document.getElementById('skAbout').value.trim() || null;
        const file = document.getElementById('skFile').files[0] || null;
        if(!tentang) return showToast('Kolom "Tentang" wajib diisi.', true);
        setStatus('saving...');
        let assetId = null;
        if(file){
          const data_url = await readFileAsDataURL(file);
          const fa = await sbFetch('file_asset', { method:'POST', prefer:'return=representation', body:{ filename:file.name, mime:file.type||null, size:file.size||null, data_url } });
          assetId = (Array.isArray(fa) && fa[0] && fa[0].id) ? fa[0].id : (fa.id||null);
        }
        await sbFetch('bk1_admin_doc', { method:'POST', prefer:'return=minimal', body:{ academic_term_id: termId, teacher_id: teacherId||null, nomor, tanggal, tentang, asset_id: assetId } });
        showToast('Dokumen disimpan.');
        setStatus('ready');
        await renderSK();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    tbody.addEventListener('click', async (e)=>{
      const bDel = e.target.closest('button[data-id]');
      const bAct = e.target.closest('button[data-act]');
      try{
        if(bAct && bAct.dataset.act==='dl'){
          const aid = bAct.dataset.aid;
          if(!aid) return;
          setStatus('loading...');
          const got = await sbFetch('file_asset', { params:{ select:'id,filename,data_url', id:`eq.${aid}`, limit:'1' } });
          const one = Array.isArray(got) ? got[0] : got;
          if(!one || !one.data_url) throw new Error('File tidak ditemukan / kosong.');
          downloadDataUrl(one.data_url, one.filename || ('dokumen-'+aid));
          setStatus('ready');
          return;
        }
        if(bDel){
          if(!confirm('Hapus dokumen ini?')) return;
          setStatus('deleting...');
          await sbFetch('bk1_admin_doc', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${bDel.dataset.id}` } });
          showToast('Dokumen dihapus.');
          setStatus('ready');
          await renderSK();
        }
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    }, { once:true });
  }

  // ---- Pemetaan CP→TP (atau KI-KD→Indikator) ----
  async function renderMapping(){
    document.getElementById('mainBody').innerHTML = `
      <div class="notice">Matriks pemetaan: CP/KD → TP/Indikator → Materi → Asesmen → Minggu/Pertemuan.</div>
      <div class="hr"></div>
      <div class="row" style="align-items:flex-end;">
        <div class="field" style="flex:1; min-width:160px;"><label>Kurikulum</label>
          <select id="mapKur">
            <option value="KURMER">KURMER (CP→TP)</option>
            <option value="K13">K13 (KI-KD→Indikator)</option>
          </select>
        </div>
        <div class="field" style="flex:2; min-width:220px;"><label>CP / KI-KD</label><input id="mapCP" placeholder="Contoh: CP Fikih Fase D (Thaharah & Shalat) / KD 3.1" /></div>
        <div class="field" style="flex:2; min-width:220px;"><label>TP / Indikator</label><input id="mapTP" placeholder="Contoh: Menjelaskan jenis air dan najis..." /></div>
        <div class="field" style="flex:2; min-width:220px;"><label>Materi</label><input id="mapMat" placeholder="Ringkas" /></div>
        <button class="btn good" id="btnAddMap">Tambah</button>
      </div>
      <div class="hr"></div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:22mm;">Kur</th>
              <th>CP/KD</th>
              <th>TP/Indikator</th>
              <th>Materi</th>
              <th style="width:18mm;">Mgg</th>
              <th style="width:18mm;">Pert</th>
              <th style="text-align:right; width:32mm;">Aksi</th>
            </tr>
          </thead>
          <tbody id="mapTbody"><tr><td colspan="7" class="muted">Memuat...</td></tr></tbody>
        </table>
      </div>
      <div class="muted" style="font-size:12px; margin-top:10px;">Tip: Edit langsung pada tabel (klik sel), lalu klik Simpan.</div>
    `;

    const rows = await safeFetchTable('bk1_mapping_matrix', { params:{ select:'*', teaching_assignment_id:`eq.${active.id}`, order:'created_at.desc', limit:'1000' } });
    if(rows && rows.__missing_table){
      document.getElementById('mainBody').innerHTML = missingTableNotice(rows.__missing_table);
      return;
    }

    const tbody = document.getElementById('mapTbody');
    const arr = Array.isArray(rows) ? rows : [];
    tbody.innerHTML = arr.length ? arr.map(r=>`\
      <tr data-id="${r.id}">\
        <td>${safeCell(r.kurikulum||'')}</td>\
        <td><input value="${escapeHtml(r.cp_kd||'')}" data-k="cp_kd" /></td>\
        <td><input value="${escapeHtml(r.tp_indikator||'')}" data-k="tp_indikator" /></td>\
        <td><input value="${escapeHtml(r.materi||'')}" data-k="materi" /></td>\
        <td><input value="${escapeHtml(r.minggu_ke??'')}" data-k="minggu_ke" style="width:60px;" /></td>\
        <td><input value="${escapeHtml(r.pertemuan_ke??'')}" data-k="pertemuan_ke" style="width:60px;" /></td>\
        <td style="text-align:right;">\
          <button class="btn small" data-act="save">Simpan</button>\
          <button class="btn small danger" data-act="del">Hapus</button>\
        </td>\
      </tr>\
    `).join('') : `<tr><td colspan="7" class="muted">Belum ada data pemetaan.</td></tr>`;

    document.getElementById('btnAddMap').onclick = async ()=>{
      try{
        const kurikulum = document.getElementById('mapKur').value;
        const cp_kd = document.getElementById('mapCP').value.trim() || null;
        const tp_indikator = document.getElementById('mapTP').value.trim() || null;
        const materi = document.getElementById('mapMat').value.trim() || null;
        if(!cp_kd || !tp_indikator) return showToast('CP/KD dan TP/Indikator wajib.', true);
        setStatus('saving...');
        await sbFetch('bk1_mapping_matrix', { method:'POST', prefer:'return=minimal', body:{ teaching_assignment_id: active.id, kurikulum, cp_kd, tp_indikator, materi } });
        showToast('Pemetaan ditambahkan.');
        setStatus('ready');
        await renderMapping();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const tr = btn.closest('tr[data-id]');
      const id = tr.dataset.id;
      const act = btn.dataset.act;
      try{
        if(act==='del'){
          if(!confirm('Hapus baris pemetaan?')) return;
          setStatus('deleting...');
          await sbFetch('bk1_mapping_matrix', { method:'DELETE', prefer:'return=minimal', params:{ id:`eq.${id}` } });
          showToast('Dihapus.');
          setStatus('ready');
          await renderMapping();
        }
        if(act==='save'){
          const patch={};
          tr.querySelectorAll('input[data-k]').forEach(i=>{
            const k=i.dataset.k;
            const v=i.value.trim();
            patch[k] = v===''?null:(k in {'minggu_ke':1,'pertemuan_ke':1}? (isNaN(Number(v))?null:Number(v)) : v);
          });
          setStatus('saving...');
          await sbFetch('bk1_mapping_matrix', { method:'PATCH', prefer:'return=minimal', params:{ id:`eq.${id}` }, body: patch });
          showToast('Tersimpan.');
          setStatus('ready');
        }
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    }, { once:true });
  }

  // ---- Model / Metode pembelajaran (dokumen formal) ----
  async function renderModelMetode(){
    const existing = await safeFetchTable('bk1_model_metode', { params:{ select:'*', teaching_assignment_id:`eq.${active.id}`, limit:'1' } });
    if(existing && existing.__missing_table){
      document.getElementById('mainBody').innerHTML = missingTableNotice(existing.__missing_table);
      return;
    }
    const row = Array.isArray(existing) ? existing[0] : null;

    document.getElementById('mainBody').innerHTML = `
      <div class="notice">Bagian formal: perencanaan model/metode (PBL/PjBL/dll), media, strategi, diferensiasi, dan asesmen.</div>
      <div class="hr"></div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="field"><label>Model</label><input id="mmModel" placeholder="PBL / PjBL / Inquiry / Direct" value="${escapeHtml(row?.model||'')}" /></div>
        <div class="field"><label>Pendekatan</label><input id="mmPend" placeholder="Saintifik / Kontekstual / dll" value="${escapeHtml(row?.pendekatan||'')}" /></div>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="field"><label>Metode</label><textarea id="mmMetode" placeholder="Diskusi, demonstrasi, latihan, dst">${escapeHtml(row?.metode||'')}</textarea></div>
        <div class="field"><label>Media/Alat</label><textarea id="mmMedia" placeholder="Buku, video, alat peraga, dll">${escapeHtml(row?.media||'')}</textarea></div>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="field"><label>Strategi (kelas/pondok)</label><textarea id="mmStrategi" placeholder="Langkah umum/strategi pengelolaan">${escapeHtml(row?.strategi||'')}</textarea></div>
        <div class="field"><label>Diferensiasi</label><textarea id="mmDifer" placeholder="Konten/proses/produk; kebutuhan santri">${escapeHtml(row?.diferensiasi||'')}</textarea></div>
      </div>
      <div class="field"><label>Catatan Asesmen</label><textarea id="mmAses" placeholder="Penilaian formatif/sumatif, rubrik, dsb">${escapeHtml(row?.asesmen||'')}</textarea></div>
      <div class="row">
        <button class="btn good" id="btnSaveMM">Simpan</button>
        <span class="tag">${row?('Terakhir update: '+safeCell(row.updated_at||row.created_at||'')):'Belum tersimpan'}</span>
      </div>
    `;

    document.getElementById('btnSaveMM').onclick = async ()=>{
      try{
        const payload = {
          teaching_assignment_id: active.id,
          model: document.getElementById('mmModel').value.trim() || null,
          pendekatan: document.getElementById('mmPend').value.trim() || null,
          metode: document.getElementById('mmMetode').value.trim() || null,
          media: document.getElementById('mmMedia').value.trim() || null,
          strategi: document.getElementById('mmStrategi').value.trim() || null,
          diferensiasi: document.getElementById('mmDifer').value.trim() || null,
          asesmen: document.getElementById('mmAses').value.trim() || null,
        };
        setStatus('saving...');
        if(row && row.id){
          await sbFetch('bk1_model_metode', { method:'PATCH', prefer:'return=minimal', params:{ id:`eq.${row.id}` }, body: payload });
        }else{
          await sbFetch('bk1_model_metode', { method:'POST', prefer:'return=minimal', body: payload });
        }
        showToast('Disimpan.');
        setStatus('ready');
        await renderModelMetode();
      }catch(e){ showToast(e.message, true); setStatus('error'); }
    };
  }

  async function renderExport(){
    document.getElementById("mainBody").innerHTML = `
      <div class="notice">Export sudah <b>multi-halaman</b>: Cover → Identitas → Minggu Efektif → Prota → Promes → ATP → KKM/KKTP → Sumber/Media → Ringkasan Modul Ajar → Pengesahan.</div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn good" id="btnBuildExport">Siapkan Dokumen</button>
        <button class="btn" id="btnPrint" disabled>Print / Save PDF</button>
        <span class="tag">Setelah siap, pilih Save as PDF di dialog print.</span>
      </div>
      <div class="hr"></div>
      <div class="muted" style="font-size:12px;">Tip: Untuk hasil lebih rapi, aktifkan opsi "Background graphics" di print (kalau perlu). Print akan pakai layout hitam-putih.</div>
    `;

    document.getElementById("btnBuildExport").onclick = async ()=>{
      try{
        await buildExportHTML();
        document.getElementById("btnPrint").disabled = false;
        showToast("Dokumen siap. Klik Print / Save PDF.");
      }catch(e){ showToast(e.message, true); setStatus("error"); }
    };

    document.getElementById("btnPrint").onclick = ()=>window.print();
  }

  async function renderMain(){
    if(!active){
      document.getElementById("mainBody").innerHTML = msgBox("notice", "Pilih assignment dulu.");
      return;
    }
    setActiveNav();
    try{
      if(view === "dash") return await renderDashboard();
      if(view === "week") return await renderWeek();
      if(view === "prota") return await renderProta();
      if(view === "promes") return await renderPromes();
      if(view === "atp") return await renderATP();
      if(view === "mastery") return await renderMastery();
      if(view === "resources") return await renderResources();
      if(view === "lesson") return await renderLessonPlans();
      if(view === "attachments") return await renderAttachments();
      if(view === "calendar") return await renderCalendar();
      if(view === "sk") return await renderSKBeban();
      if(view === "mapping") return await renderMapping();
      if(view === "model") return await renderModelMetode();
      if(view === "export") return await renderExport();
    }catch(e){
      document.getElementById("mainBody").innerHTML = msgBox("err", escapeHtml(e.message));
      setStatus("error");
    }
  }

  // Events
  document.getElementById("btnConnect").onclick = async ()=>{
    SUPABASE_URL = document.getElementById("sbUrl").value.trim();
    SUPABASE_KEY = document.getElementById("sbKey").value.trim();
    saveConfig();
    try{
      setStatus("testing...");
      await sbFetch("academic_term", { params: { select: "id", limit: "1" } });
      showConnMessage("notice", "Koneksi OK. Klik Load Assignments.");
      setStatus("ready");
    }catch(e){
      showConnMessage("err", "Gagal connect: " + e.message);
      setStatus("error");
    }
  };

  document.getElementById("btnLoadAssignments").onclick = async ()=>{
    try{
      await loadAssignments();
      showConnMessage("notice", "Assignments dimuat. Silakan pilih salah satu.");
    }catch(e){
      showConnMessage("err", "Gagal load assignments: " + e.message);
      setStatus("error");
    }
  };

  document.getElementById("btnReset").onclick = ()=>{
    active = null;
    view = "dash";
    document.getElementById("navBtns").style.display = "none";
    document.getElementById("mainTitle").textContent = "Pilih assignment dulu";
    document.getElementById("mainBody").innerHTML = msgBox("notice", "Pilih assignment dulu.");
  };

  document.getElementById("navBtns").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    view = btn.dataset.view;
    renderMain();
  });

  document.getElementById("btnCloseModal").onclick = closeModal;
  document.getElementById("modalBackdrop").addEventListener("click", (e)=>{ if(e.target.id === "modalBackdrop") closeModal(); });

  (async ()=>{
    if(SUPABASE_URL && SUPABASE_KEY){
      try{
        setStatus("auto-connect...");
        await sbFetch("academic_term", { params: { select: "id", limit: "1" } });
        showConnMessage("notice", "Auto-connect OK. Klik Load Assignments.");
        setStatus("ready");
      }catch{ setStatus("idle"); }
    }
  })();
</script>
</body>
</html>
