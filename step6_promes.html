<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Langkah 6: Program Semester (Promes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script src="layout.js"></script>

    <style>
        /* Hilangkan Spinner Input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* Container Table */
        .table-container { 
            overflow-x: auto; 
            padding-bottom: 20px; 
            background: white;
        }
        
        table { border-collapse: separate; border-spacing: 0; min-width: max-content; }
        
        /* Sticky Header (Hanya Judul Kolom Tabel yang Sticky) */
        thead th { 
            position: sticky; top: 0; z-index: 40; 
            background-color: #f8fafc; border-bottom: 2px solid #cbd5e1; 
            height: 40px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Konfigurasi Lebar Kolom (Tanpa Sticky Left) */
        .col-no { width: 50px; text-align: center; }
        .col-materi { width: 320px; min-width: 320px; max-width: 400px; }
        .col-target { width: 70px; text-align: center; background-color: #eff6ff !important; color: #1d4ed8; border-right: 2px solid #cbd5e1; }

        /* Text Wrap Logic */
        .wrap-text { 
            white-space: normal !important; 
            word-wrap: break-word; 
            line-height: 1.4;
        }

        /* Warna Header Minggu */
        .week-header { cursor: pointer; user-select: none; transition: 0.2s; }
        .week-header:hover { filter: brightness(0.95); }
        .week-full { background-color: #ffffff; color: #64748b; }
        .week-partial { background-color: #fef3c7; color: #d97706; }
        .week-off { background-color: #ffe4e6; color: #e11d48; }
        
        .jp-input { font-size: 11px; font-weight: 600; }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen flex font-sans overflow-hidden">

    <div id="sidebar-container"></div>

    <div class="flex-1 flex flex-col relative min-w-0">
        
        <header class="h-20 bg-white border-b border-slate-200 px-6 py-3 shadow-sm z-10 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-lg font-bold text-slate-900">6. Program Semester (Promes)</h1>
                <p class="text-xs text-slate-500">Distribusikan JP ke dalam matriks minggu efektif.</p>
            </div>
            
            <div class="hidden md:flex gap-3 text-[10px] items-center font-medium text-slate-500 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                <span class="text-xs font-bold text-slate-700 mr-1">Legenda:</span>
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-white border border-slate-300 rounded"></div> Efektif</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-amber-100 border border-amber-300 rounded"></div> Sebagian</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-rose-100 border border-rose-300 rounded"></div> Libur</div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-slate-100 pb-32 flex flex-col gap-10">
            
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col relative pl-1">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                
                <div class="px-5 py-4 bg-white border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center shrink-0">
                    <h3 class="font-bold text-blue-800 text-sm flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-600 rounded-full"></span> Semester 1 (Ganjil)
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="resetMatrix(1)" class="text-[10px] text-rose-600 font-bold px-3 py-1.5 border border-rose-200 rounded hover:bg-rose-50 transition">
                            Reset Smt 1
                        </button>
                        <button onclick="autoDistribute(1)" class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1.5 rounded text-[10px] font-bold hover:bg-blue-700 shadow-sm transition">
                            <span>‚ö°</span> Isi Otomatis
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="text-xs text-left w-full">
                        <thead>
                            <tr id="thead_m_1"></tr>
                            <tr id="thead_w_1"></tr>
                        </thead>
                        <tbody id="tbody_1" class="divide-y divide-gray-100 bg-white text-slate-600"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col relative pl-1">
                <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                
                <div class="px-5 py-4 bg-white border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center shrink-0">
                    <h3 class="font-bold text-indigo-800 text-sm flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-600 rounded-full"></span> Semester 2 (Genap)
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="resetMatrix(2)" class="text-[10px] text-rose-600 font-bold px-3 py-1.5 border border-rose-200 rounded hover:bg-rose-50 transition">
                            Reset Smt 2
                        </button>
                        <button onclick="autoDistribute(2)" class="flex items-center gap-1 bg-indigo-600 text-white px-3 py-1.5 rounded text-[10px] font-bold hover:bg-indigo-700 shadow-sm transition">
                            <span>‚ö°</span> Isi Otomatis
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="text-xs text-left w-full">
                        <thead>
                            <tr id="thead_m_2"></tr>
                            <tr id="thead_w_2"></tr>
                        </thead>
                        <tbody id="tbody_2" class="divide-y divide-gray-100 bg-white text-slate-600"></tbody>
                    </table>
                </div>
            </div>

            <div id="p5Banner" class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-xl relative pl-1 overflow-visible shadow-sm">
                <div class="absolute top-0 left-0 w-1 h-full bg-amber-500 rounded-l-xl"></div>
                <div class="p-4 flex items-start gap-4">
                    <span class="text-2xl pt-1">üí°</span>
                    <div>
                        <h4 class="font-bold text-amber-800 text-sm uppercase tracking-wide mb-1">Mode P5 Aktif</h4>
                        <p class="text-xs text-amber-700 leading-relaxed">
                            Baris <b>Projek Penguatan Profil Pelajar Pancasila (P5)</b> telah ditambahkan otomatis di bagian bawah setiap tabel semester.<br>
                            Isi alokasi P5 secara manual sesuai sistem blok atau reguler di sekolah Anda.
                        </p>
                    </div>
                </div>
            </div>

        </main>

        <footer class="h-20 bg-white border-t border-slate-200 px-6 absolute bottom-0 w-full flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <a href="step5_prota.html" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-800 text-sm transition flex items-center gap-1"><span>‚Üê</span> Kembali</a>
            <button onclick="save()" id="btnSave" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition transform active:scale-95 flex items-center gap-2 text-sm">
                <span>üíæ</span> Simpan & Lanjut (Modul Ajar) ‚Üí
            </button>
        </footer>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-slate-200 border-t-blue-600 mb-4"></div>
            <span class="text-sm font-bold text-slate-500">Memuat Data Promes...</span>
        </div>
    </div>

<script>
    const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
    let user, profile = {}, protaData = {}, localPromes = {};
    let jpPerWeekGlobal = 4;
    let calendarHolidays = {}; 

    const MONTH_CONFIG = {
        1: ["Juli", "Agustus", "September", "Oktober", "November", "Desember"],
        2: ["Januari", "Februari", "Maret", "April", "Mei", "Juni"]
    };

    let appState = {
        1: { values: {}, capacities: {}, materi: [] },
        2: { values: {}, capacities: {}, materi: [] }
    };

    async function init() {
        const { data: { session } } = await db.auth.getSession();
        if (session) { user = session.user; loadData(); }
        else { window.location.href = 'index.html'; }
    }
    init();

    async function loadData() {
        const [prof, d5, d3, d6] = await Promise.all([
            db.from('profiles').select('*').eq('id', user.id).maybeSingle(),
            db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'prota_data').maybeSingle(),
            db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'calendar_data').maybeSingle(),
            db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'promes_data').maybeSingle()
        ]);

        if(prof.data) { 
            profile = prof.data; 
            jpPerWeekGlobal = parseInt(profile.jp_per_week) || parseInt(profile.jumlah_jp) || 4; 
        }
        if(d5.data && d5.data.content_data) protaData = d5.data.content_data;
        if(d3.data && d3.data.content_data && d3.data.content_data.holidays) calendarHolidays = d3.data.content_data.holidays;
        if(d6.data && d6.data.content_data) localPromes = d6.data.content_data;

        initSemesterState(1);
        initSemesterState(2);

        renderTable(1);
        renderTable(2);

        if(protaData.p5_settings && protaData.p5_settings.active) {
            document.getElementById('p5Banner').classList.remove('hidden');
        }

        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function initSemesterState(sem) {
        const semKey = 'semester_' + sem;
        let materiList = [];
        if (protaData[semKey] && Array.isArray(protaData[semKey])) {
            materiList = JSON.parse(JSON.stringify(protaData[semKey]));
        }

        const p5Settings = protaData.p5_settings || { active: false, percentage: 0 };
        if (p5Settings.active) {
            const totalIntra = materiList.reduce((acc, item) => acc + (parseInt(item.alokasi_jp)||0), 0);
            const pct = parseFloat(p5Settings.percentage);
            const totalGlobal = Math.round(totalIntra / (1 - pct));
            let jpP5 = totalGlobal - totalIntra;
            if (jpPerWeekGlobal % 2 === 0 && jpP5 % 2 !== 0) jpP5 += 1; 

            if (jpP5 > 0) {
                materiList.push({
                    elemen: "PROJEK P5",
                    detail_tp: "Tema: Kearifan Lokal / Gaya Hidup Berkelanjutan",
                    alokasi_jp: jpP5,
                    is_p5: true
                });
            }
        }
        appState[sem].materi = materiList;

        if(localPromes[semKey]) {
            appState[sem].values = localPromes[semKey].values || {};
            appState[sem].capacities = localPromes[semKey].capacities || detectCalendarConflicts(sem);
        } else {
            appState[sem].values = {};
            appState[sem].capacities = detectCalendarConflicts(sem);
        }
    }

    function getWeeksInMonth(year, monthIdx) {
        const days = new Date(year, monthIdx + 1, 0).getDate();
        return days > 28 ? 5 : 4;
    }

    function detectCalendarConflicts(sem) {
        let caps = {};
        const startMonthIdx = sem === 1 ? 6 : 0; 
        const yearBase = sem === 1 ? 2025 : 2026;

        for (let mOffset = 0; mOffset < 6; mOffset++) {
            const realMonthIdx = startMonthIdx + mOffset;
            const currentYear = (realMonthIdx > 11) ? yearBase + 1 : yearBase;
            const daysInMonth = new Date(currentYear, realMonthIdx + 1, 0).getDate();
            const totalWeeks = getWeeksInMonth(currentYear, realMonthIdx);

            for (let w = 1; w <= totalWeeks; w++) {
                let startDate = (w - 1) * 7 + 1;
                let endDate = Math.min(w * 7, daysInMonth);
                const weekKey = `${mOffset}_${w}`;
                
                if (startDate > daysInMonth) { caps[weekKey] = -1; continue; }

                let hasHoliday = false;
                for (let d = startDate; d <= endDate; d++) {
                    const dateObj = new Date(currentYear, realMonthIdx, d);
                    if (dateObj.getDay() === 0) continue; 
                    const dateKey = `${currentYear}-${String(realMonthIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if (calendarHolidays[dateKey]) { hasHoliday = true; break; }
                }

                if (hasHoliday) caps[weekKey] = Math.floor(jpPerWeekGlobal / 2);
                else caps[weekKey] = jpPerWeekGlobal;
            }
        }
        return caps;
    }

    function toggleCapacity(sem, weekKey) {
        const current = appState[sem].capacities[weekKey] || 0;
        let nextVal = 0;
        if (current === jpPerWeekGlobal) nextVal = Math.floor(jpPerWeekGlobal / 2); 
        else if (current > 0) nextVal = 0; 
        else nextVal = jpPerWeekGlobal; 
        
        appState[sem].capacities[weekKey] = nextVal;
        if (nextVal === 0) {
            for (const k in appState[sem].values) if (k.includes(`_${weekKey}`)) delete appState[sem].values[k];
        }
        renderTable(sem);
    }

    function renderTable(sem) {
        const months = MONTH_CONFIG[sem];
        const hRowM = document.getElementById(`thead_m_${sem}`);
        const hRowW = document.getElementById(`thead_w_${sem}`);
        const tbody = document.getElementById(`tbody_${sem}`);
        
        let htmlM = `<th rowspan="2" class="p-3 col-no bg-slate-50 border-b font-medium">No</th>
                     <th rowspan="2" class="p-3 col-materi bg-slate-50 border-b font-medium">Materi Pokok / TP</th>
                     <th rowspan="2" class="p-3 col-target bg-slate-50 border-b border-r font-medium">Target</th>`;
        let htmlW = ``;

        const startMonthIdx = sem === 1 ? 6 : 0;
        const yearBase = sem === 1 ? 2025 : 2026;

        months.forEach((mName, mIdx) => {
            const realMonthIdx = startMonthIdx + mIdx;
            const currentYear = (realMonthIdx > 11) ? yearBase + 1 : yearBase;
            const totalWeeks = getWeeksInMonth(currentYear, realMonthIdx);

            htmlM += `<th colspan="${totalWeeks}" class="p-2 text-center border-r border-slate-200 bg-slate-50 font-bold text-slate-600 min-w-[120px] uppercase text-[9px] tracking-wider">${mName}</th>`;
            
            for(let w=1; w<=totalWeeks; w++) {
                const weekKey = `${mIdx}_${w}`;
                const cap = appState[sem].capacities[weekKey];
                
                let cssClass = "", title = "", label = w;
                if (cap === undefined) { cssClass = "bg-slate-50 text-slate-300 pointer-events-none"; label=w; }
                else if (cap === 0) { cssClass = "week-off font-bold"; title=`Libur (0 JP)`; }
                else if (cap < jpPerWeekGlobal) { cssClass = "week-partial font-bold"; title=`Parsial (${cap} JP)`; }
                else { cssClass = "week-full"; title=`Full (${cap} JP)`; }

                htmlW += `<th onclick="toggleCapacity(${sem}, '${weekKey}')" class="p-1 w-8 text-center border-r border-slate-200 week-header ${cssClass} text-[10px]" title="${title}">${label}</th>`;
            }
        });
        
        htmlM += `<th rowspan="2" class="p-3 w-[80px] text-center border-l bg-slate-50 shadow-sm border-b">Status</th>`;
        hRowM.innerHTML = htmlM;
        hRowW.innerHTML = htmlW;

        tbody.innerHTML = '';
        const materiList = appState[sem].materi;

        if(materiList.length === 0) {
            tbody.innerHTML = `<tr><td colspan="40" class="p-8 text-center text-slate-400">Data Materi kosong.</td></tr>`;
            return;
        }

        materiList.forEach((item, rIdx) => {
            const target = parseInt(item.alokasi_jp) || 0;
            const isP5 = item.is_p5 === true;
            const rowClass = isP5 ? "bg-amber-50 hover:bg-amber-100" : "bg-white hover:bg-slate-50";
            const cellClass = isP5 ? "bg-amber-50" : "bg-white";

            let rowHTML = `
                <td class="p-3 border-b border-slate-100 col-no text-center ${cellClass} font-medium align-top">${isP5 ? '*' : rIdx + 1}</td>
                <td class="p-3 border-b border-slate-100 col-materi align-top ${cellClass}">
                    <div class="text-[11px] font-bold ${isP5 ? 'text-amber-800' : 'text-slate-800'} mb-1">${item.elemen || ''}</div>
                    <div class="text-[10px] text-slate-500 wrap-text leading-snug">${item.detail_tp || ''}</div>
                </td>
                <td class="p-3 border-b border-r border-slate-200 col-target font-bold align-top pt-4 text-xs" id="target_${sem}_${rIdx}">${target}</td>
            `;

            months.forEach((_, mIdx) => {
                const realMonthIdx = startMonthIdx + mIdx;
                const currentYear = (realMonthIdx > 11) ? yearBase + 1 : yearBase;
                const totalWeeks = getWeeksInMonth(currentYear, realMonthIdx);

                for(let w=1; w<=totalWeeks; w++) {
                    const weekKey = `${mIdx}_${w}`;
                    const cellKey = `${rIdx}_${mIdx}_${w}`;
                    const val = appState[sem].values[cellKey] || '';
                    const cap = appState[sem].capacities[weekKey];

                    let bgClass = "", disabled = "";
                    if (cap === 0) { bgClass = "bg-rose-50"; disabled = "disabled"; }
                    else if (val) { bgClass = isP5 ? "bg-amber-200" : "bg-emerald-100 font-bold text-emerald-700"; }

                    const stepVal = (jpPerWeekGlobal % 2 === 0) ? 2 : 1;

                    rowHTML += `<td class="p-0 border-r border-b border-slate-100 text-center ${bgClass} w-8 align-top">
                        <input type="number" value="${val}" ${disabled} max="${cap}" step="${stepVal}"
                        onchange="updateMatrix(${sem}, '${cellKey}', this.value, ${rIdx}, ${cap})" 
                        class="w-full h-14 text-center jp-input outline-none bg-transparent focus:bg-blue-100 p-0 m-0">
                    </td>`;
                }
            });

            rowHTML += `<td class="p-2 border-l border-b border-slate-100 text-center ${cellClass} align-top pt-4" id="status_${sem}_${rIdx}">-</td>`;
            
            const tr = document.createElement('tr');
            tr.innerHTML = rowHTML;
            tr.className = `${cellClass} ${rowClass} transition group`;
            tbody.appendChild(tr);
            
            validateRow(sem, rIdx, target);
        });
    }

    function updateMatrix(sem, key, val, rowIdx, maxCap) {
        let numVal = parseInt(val);
        if(val !== '' && isNaN(numVal)) val = '';
        else if (val !== '') {
            if(numVal > maxCap) numVal = maxCap;
            const isWeekEven = (jpPerWeekGlobal % 2 === 0);
            if (isWeekEven && (numVal % 2 !== 0)) numVal = (numVal > 1) ? numVal - 1 : 0;
            val = numVal;
        }
        if (val === 0 || val === '0') val = '';
        
        appState[sem].values[key] = val;
        
        const inputEl = document.querySelector(`input[onchange*="'${key}'"]`);
        if(inputEl && String(val) !== String(inputEl.value)) inputEl.value = val;

        const target = parseInt(document.getElementById(`target_${sem}_${rowIdx}`).innerText) || 0;
        validateRow(sem, rowIdx, target);
    }

    function validateRow(sem, rIdx, target) {
        let currentSum = 0;
        const prefix = `${rIdx}_`;
        for (const key in appState[sem].values) {
            if (key.startsWith(prefix)) currentSum += (parseInt(appState[sem].values[key]) || 0);
        }
        const statEl = document.getElementById(`status_${sem}_${rIdx}`);
        if(!statEl) return;

        if(currentSum === target) {
            statEl.innerHTML = `<span class="text-emerald-600 text-[16px]">‚úÖ</span>`;
        } else if (currentSum < target) {
            statEl.innerHTML = `<span class="text-amber-500 font-bold text-[9px] bg-amber-50 px-2 py-1 rounded">-${target - currentSum}</span>`;
        } else {
            statEl.innerHTML = `<span class="text-rose-500 font-bold text-[9px] bg-rose-50 px-2 py-1 rounded">+${currentSum - target}</span>`;
        }
    }

    function autoDistribute(sem) {
        const materiList = appState[sem].materi;
        if(materiList.length === 0) return;

        let availableSlots = [];
        const startMonthIdx = sem === 1 ? 6 : 0;
        const yearBase = sem === 1 ? 2025 : 2026;

        for(let m=0; m<6; m++) {
            const realMonthIdx = startMonthIdx + m;
            const currentYear = (realMonthIdx > 11) ? yearBase + 1 : yearBase;
            const totalWeeks = getWeeksInMonth(currentYear, realMonthIdx);

            for(let w=1; w<=totalWeeks; w++) {
                const weekKey = `${m}_${w}`;
                const cap = appState[sem].capacities[weekKey];
                if(cap > 0) availableSlots.push({ m, w, cap, used: 0 });
            }
        }

        if(availableSlots.length === 0) return Swal.fire('Penuh', 'Tidak ada minggu efektif tersedia.', 'warning');

        appState[sem].values = {}; 
        let slotIdx = 0;

        materiList.forEach((item, rIdx) => {
            let demand = parseInt(item.alokasi_jp) || 0;
            const isWeekEven = (jpPerWeekGlobal % 2 === 0);

            while(demand > 0 && slotIdx < availableSlots.length) {
                let slot = availableSlots[slotIdx];
                let remainingCap = slot.cap - slot.used;
                
                if (remainingCap > 0) {
                    let fill = Math.min(demand, remainingCap);
                    if (isWeekEven && (fill % 2 !== 0)) {
                        fill = fill - 1; 
                        if (fill <= 0) { break; } 
                    }
                    
                    const cellKey = `${rIdx}_${slot.m}_${slot.w}`;
                    appState[sem].values[cellKey] = (appState[sem].values[cellKey] || 0) + fill;
                    
                    demand -= fill;
                    slot.used += fill;
                    
                    if(slot.used >= slot.cap) slotIdx++;
                } else {
                    slotIdx++;
                }
            }
        });

        renderTable(sem);
        Swal.fire({icon: 'success', title: `Semester ${sem} Terisi!`, timer: 1500, showConfirmButton:false});
    }

    function resetMatrix(sem) {
        Swal.fire({ 
            title: `Reset Semester ${sem}?`, 
            text: "Isian JP akan dihapus. Status minggu dikembalikan ke default Kalender.", 
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Reset'
        }).then((res) => { 
            if(res.isConfirmed) { 
                appState[sem].values = {}; 
                appState[sem].capacities = detectCalendarConflicts(sem);
                renderTable(sem); 
                Swal.fire('Tereset', '', 'success');
            } 
        });
    }

    async function save() {
        const btn = document.getElementById('btnSave'); btn.innerHTML = '‚è≥ Menyimpan...'; btn.disabled = true;
        
        const payloadData = {
            semester_1: { values: appState[1].values, capacities: appState[1].capacities },
            semester_2: { values: appState[2].values, capacities: appState[2].capacities }
        };

        const payload = {
            user_id: user.id, doc_type: 'promes_data',
            subject_name: profile.mata_pelajaran || 'Umum', grade_level: profile.fase_kelas || 'Umum', curriculum_type: profile.jenis_kurikulum || 'Merdeka',
            content_data: payloadData, status: 'draft'
        };
        
        const { error } = await db.from('work_drafts').upsert(payload, { onConflict: 'user_id,doc_type' });
        
        if (error) { 
            Swal.fire('Gagal', error.message, 'error'); 
            btn.innerHTML = '<span>üíæ</span> Simpan & Lanjut (Modul Ajar) ‚Üí'; btn.disabled = false; 
        } else { 
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            Toast.fire({icon: 'success', title: 'Promes Tersimpan!'});
            setTimeout(() => window.location.href = 'step7_rpp.html', 1500);
        }
    }
</script>
</body>
</html>