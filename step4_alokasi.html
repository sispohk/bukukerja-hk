<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Langkah 4: Alokasi Waktu (RPE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <script src="layout.js"></script>
    <style>
        /* Sticky Header untuk Tabel Panjang */
        thead th { 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            background-color: #f8fafc; /* slate-50 */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex font-sans overflow-hidden">

    <div id="sidebar-container"></div>

    <div class="flex-1 flex flex-col relative min-w-0">
        
        <header class="h-20 bg-white border-b border-slate-200 px-6 py-4 shadow-sm z-20 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-lg font-bold text-slate-900">4. Rincian Pekan Efektif (RPE)</h1>
                <p class="text-xs text-slate-500">Hitung ketersediaan JP berdasarkan kalender.</p>
            </div>
            
            <div id="p5Container" class="flex items-center gap-3 bg-amber-50 border border-amber-200 px-3 py-1.5 rounded-full shadow-sm transition-all duration-300">
                <div class="text-[10px] font-bold text-amber-700 uppercase tracking-wide">Mode P5:</div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleP5" class="sr-only peer" onchange="calculateRPE()">
                    <div class="w-8 h-4 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-amber-500"></div>
                </label>
                <select id="p5Percent" onchange="calculateRPE()" disabled class="text-xs font-bold border-none bg-transparent text-slate-600 disabled:opacity-30 focus:ring-0 cursor-pointer p-0 outline-none">
                    <option value="0.2">20%</option>
                    <option value="0.25" selected>25%</option>
                    <option value="0.3">30%</option>
                </select>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-slate-100 flex flex-col md:flex-row gap-6 items-start">
            
            <div class="flex-1 flex flex-col gap-6 w-full">
                
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative pl-5">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div> <div class="px-4 py-4 bg-white border-b border-slate-100 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="font-bold text-blue-800 text-sm flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span> Semester 1 (Ganjil)
                        </h3>
                        <span class="text-[10px] bg-blue-50 px-2 py-1 rounded border border-blue-100 font-bold text-blue-600" id="s1_eff_weeks">0 Pekan</span>
                    </div>
                    
                    <div class="w-full">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border-b">Bulan</th>
                                    <th class="p-3 border-b text-center">Pekan</th>
                                    <th class="p-3 border-b text-center text-rose-500">Libur</th>
                                    <th class="p-3 border-b text-center text-emerald-600">Efektif</th>
                                    <th class="p-3 border-b text-center">Total JP</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_s1" class="divide-y divide-slate-50 text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative pl-5">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div> <div class="px-4 py-4 bg-white border-b border-slate-100 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="font-bold text-indigo-800 text-sm flex items-center gap-2">
                            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span> Semester 2 (Genap)
                        </h3>
                        <span class="text-[10px] bg-indigo-50 px-2 py-1 rounded border border-indigo-100 font-bold text-indigo-600" id="s2_eff_weeks">0 Pekan</span>
                    </div>
                    
                    <div class="w-full">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border-b">Bulan</th>
                                    <th class="p-3 border-b text-center">Pekan</th>
                                    <th class="p-3 border-b text-center text-rose-500">Libur</th>
                                    <th class="p-3 border-b text-center text-emerald-600">Efektif</th>
                                    <th class="p-3 border-b text-center">Total JP</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_s2" class="divide-y divide-slate-50 text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-80 flex flex-col gap-6 sticky top-0">
                
                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b pb-2">Ketersediaan Waktu</h3>
                    
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-[10px] text-blue-500 font-bold uppercase block mb-1">Semester 1</span>
                            <div class="text-2xl font-black text-slate-800 leading-none" id="s1_intra_jp">0</div>
                            <div class="text-[10px] text-slate-400">JP Tatap Muka</div>
                        </div>
                        <div class="text-right p5-row hidden bg-amber-50 px-2 py-1 rounded border border-amber-100">
                            <div class="text-xs font-bold text-amber-600" id="s1_p5_jp">0</div>
                            <div class="text-[9px] text-amber-500 uppercase font-bold">P5</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                        <div>
                            <span class="text-[10px] text-indigo-500 font-bold uppercase block mb-1">Semester 2</span>
                            <div class="text-2xl font-black text-slate-800 leading-none" id="s2_intra_jp">0</div>
                            <div class="text-[10px] text-slate-400">JP Tatap Muka</div>
                        </div>
                        <div class="text-right p5-row hidden bg-amber-50 px-2 py-1 rounded border border-amber-100">
                            <div class="text-xs font-bold text-amber-600" id="s2_p5_jp">0</div>
                            <div class="text-[9px] text-amber-500 uppercase font-bold">P5</div>
                        </div>
                    </div>
                </div>

                <div class="bg-emerald-50 rounded-xl border border-emerald-200 p-5 shadow-sm">
                    <h3 class="text-xs font-bold text-emerald-800 uppercase tracking-widest mb-4 flex items-center gap-2 border-b border-emerald-200 pb-2">
                        <span>‚öñÔ∏è</span> Status Distribusi
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="bg-white/80 rounded-lg p-3 border border-emerald-100">
                            <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                <span>Kebutuhan (Step 2)</span>
                                <span>Tersedia</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-slate-700" id="val_dem_s1">0</span>
                                <span class="text-[10px] text-slate-300">vs</span>
                                <span class="font-bold text-emerald-700" id="val_sup_s1">0</span>
                            </div>
                            <span id="validBadgeS1" class="text-[10px] font-bold px-2 py-1 rounded-md bg-slate-100 text-slate-400 block w-full text-center">-</span>
                        </div>

                        <div class="bg-white/80 rounded-lg p-3 border border-emerald-100">
                            <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                <span>Kebutuhan (Step 2)</span>
                                <span>Tersedia</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-slate-700" id="val_dem_s2">0</span>
                                <span class="text-[10px] text-slate-300">vs</span>
                                <span class="font-bold text-emerald-700" id="val_sup_s2">0</span>
                            </div>
                            <span id="validBadgeS2" class="text-[10px] font-bold px-2 py-1 rounded-md bg-slate-100 text-slate-400 block w-full text-center">-</span>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <footer class="h-20 bg-white border-t border-slate-200 px-6 absolute bottom-0 w-full flex justify-between items-center z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <a href="step3_kalender.html" class="px-4 py-2 text-slate-500 font-bold hover:text-slate-800 text-sm transition flex items-center gap-1"><span>‚Üê</span> Kembali</a>
            <button onclick="saveAndNext()" id="btnSave" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition transform active:scale-95 flex items-center gap-2 text-sm">
                <span>üíæ</span> Simpan & Lanjut (Prota) ‚Üí
            </button>
        </footer>
    </div>

<script>
    const db = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
    let user, profile = {}, calendarData = {}, existingAlloc = {};
    
    const SEM_1_MONTHS = ["Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const SEM_2_MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni"];
    let jpPerWeek = 4;

    async function init() {
        const { data: { session } } = await db.auth.getSession();
        if (session) { user = session.user; loadData(); }
    }
    init();

    async function loadData() {
        const [prof, cal, alloc] = await Promise.all([
            db.from('profiles').select('*').eq('id', user.id).maybeSingle(),
            db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'calendar_data').maybeSingle(),
            db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'allocation_data').maybeSingle()
        ]);

        if(prof.data) {
            profile = prof.data;
            jpPerWeek = parseInt(profile.jp_per_week) || 4;
            
            const kur = (profile.jenis_kurikulum || '').toUpperCase();
            if (kur.includes('13') || kur.includes('K13') || kur.includes('2013')) {
                const p5Container = document.getElementById('p5Container');
                if(p5Container) p5Container.style.display = 'none'; 
                const toggle = document.getElementById('toggleP5');
                if(toggle) toggle.checked = false;
            }
        }
        
        if(cal.data && cal.data.content_data) calendarData = cal.data.content_data.holidays || {};
        
        if(alloc.data && alloc.data.content_data && alloc.data.content_data.p5_settings) {
            const p5 = alloc.data.content_data.p5_settings;
            const kur = (profile.jenis_kurikulum || '').toUpperCase();
            if (!(kur.includes('13') || kur.includes('K13'))) {
                document.getElementById('toggleP5').checked = p5.active || false;
                if(p5.percentage) document.getElementById('p5Percent').value = p5.percentage;
            }
        }

        calculateRPE();
    }

    function countWeeksAndHolidays(monthIndex, year) {
        let mondays = 0;
        let brokenWeeks = 0;
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

        for (let d = 1; d <= daysInMonth; d++) {
            let date = new Date(year, monthIndex, d);
            if (date.getDay() === 1) { 
                mondays++;
                let holidayCount = 0;
                for(let k=0; k<5; k++) {
                    let checkDate = new Date(year, monthIndex, d+k);
                    if(checkDate.getMonth() !== monthIndex) continue;
                    let key = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;
                    if(calendarData[key]) holidayCount++;
                }
                if(holidayCount >= 3) brokenWeeks++;
            }
        }
        return { total: mondays, ineffective: brokenWeeks };
    }

    function calculateRPE() {
        let s1 = { total:0, ineff:0, eff:0, total_jp:0 };
        let s2 = { total:0, ineff:0, eff:0, total_jp:0 };

        const tbody1 = document.getElementById('tbody_s1');
        const tbody2 = document.getElementById('tbody_s2');
        tbody1.innerHTML = ''; tbody2.innerHTML = '';

        const renderRow = (m, total, ineff, eff, jp) => `
            <tr class="hover:bg-blue-50 transition border-b border-slate-100 last:border-0">
                <td class="p-3 font-medium">${m}</td>
                <td class="p-3 text-center text-slate-500">${total}</td>
                <td class="p-3 text-center text-rose-500 font-medium">${ineff}</td>
                <td class="p-3 text-center font-bold text-slate-800">${eff}</td>
                <td class="p-3 text-center bg-slate-50 font-bold text-slate-600">${jp} JP</td>
            </tr>`;

        SEM_1_MONTHS.forEach((m, i) => {
            const res = countWeeksAndHolidays(6 + i, 2025);
            const eff = Math.max(0, res.total - res.ineffective);
            s1.total += res.total; s1.ineff += res.ineffective; s1.eff += eff;
            tbody1.innerHTML += renderRow(m, res.total, res.ineffective, eff, eff*jpPerWeek);
        });
        s1.total_jp = s1.eff * jpPerWeek;

        SEM_2_MONTHS.forEach((m, i) => {
            const res = countWeeksAndHolidays(i, 2026);
            const eff = Math.max(0, res.total - res.ineffective);
            s2.total += res.total; s2.ineff += res.ineffective; s2.eff += eff;
            tbody2.innerHTML += renderRow(m, res.total, res.ineffective, eff, eff*jpPerWeek);
        });
        s2.total_jp = s2.eff * jpPerWeek;

        const isP5 = document.getElementById('toggleP5').checked;
        const p5Select = document.getElementById('p5Percent');
        
        p5Select.disabled = !isP5;
        document.querySelectorAll('.p5-row').forEach(el => el.classList.toggle('hidden', !isP5));

        let p5_s1 = 0, p5_s2 = 0;
        let intra_s1 = s1.total_jp, intra_s2 = s2.total_jp;

        if (isP5) {
            const pct = parseFloat(p5Select.value);
            p5_s1 = Math.round(s1.total_jp * pct);
            p5_s2 = Math.round(s2.total_jp * pct);
            
            intra_s1 = s1.total_jp - p5_s1;
            intra_s2 = s2.total_jp - p5_s2;

            if (jpPerWeek % 2 === 0) {
                if (intra_s1 % 2 !== 0) { p5_s1 += 1; intra_s1 -= 1; }
                if (intra_s2 % 2 !== 0) { p5_s2 += 1; intra_s2 -= 1; }
            }
        }

        document.getElementById('s1_eff_weeks').innerText = s1.eff + " Pekan Efektif";
        document.getElementById('s1_p5_jp').innerText = p5_s1 + " JP";
        document.getElementById('s1_intra_jp').innerText = intra_s1;

        document.getElementById('s2_eff_weeks').innerText = s2.eff + " Pekan Efektif";
        document.getElementById('s2_p5_jp').innerText = p5_s2 + " JP";
        document.getElementById('s2_intra_jp').innerText = intra_s2;

        window.allocationData = {
            s1: { total: s1.total, ineff: s1.ineff, eff: s1.eff, jp: s1.total_jp, p5: p5_s1, intra: intra_s1 },
            s2: { total: s2.total, ineff: s2.ineff, eff: s2.eff, jp: s2.total_jp, p5: p5_s2, intra: intra_s2 },
            p5_settings: { active: isP5, percentage: isP5 ? p5Select.value : 0 }
        };

        validateJPDemand();
    }

    async function validateJPDemand(){
        const supply1 = window.allocationData.s1.intra; 
        const supply2 = window.allocationData.s2.intra;

        document.getElementById('val_sup_s1').innerText = supply1;
        document.getElementById('val_sup_s2').innerText = supply2;

        const { data: cp } = await db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'master_cp_atp').maybeSingle();
        const arr = (cp && cp.content_data) ? cp.content_data : [];
        
        const demand1 = arr.filter(m => String(m.semester) === '1').reduce((sum, m) => sum + (parseInt(m.alokasi_jp)||0), 0);
        const demand2 = arr.filter(m => String(m.semester) === '2').reduce((sum, m) => sum + (parseInt(m.alokasi_jp)||0), 0);

        document.getElementById('val_dem_s1').innerText = demand1;
        document.getElementById('val_dem_s2').innerText = demand2;

        const diff1 = supply1 - demand1;
        const diff2 = supply2 - demand2;

        const setBadge = (idBadge, diff) => {
            const badge = document.getElementById(idBadge);
            if (diff === 0) {
                badge.className = "text-[10px] font-bold px-2 py-1 rounded-md bg-emerald-100 text-emerald-700 block w-full text-center";
                badge.innerText = "‚úÖ PAS";
            } else if (diff > 0) {
                badge.className = "text-[10px] font-bold px-2 py-1 rounded-md bg-blue-100 text-blue-700 block w-full text-center";
                badge.innerText = "‚ö†Ô∏è SISA " + diff;
            } else {
                badge.className = "text-[10px] font-bold px-2 py-1 rounded-md bg-rose-100 text-rose-700 block w-full text-center";
                badge.innerText = "‚ùå KURANG " + Math.abs(diff);
            }
        };

        setBadge('validBadgeS1', diff1);
        setBadge('validBadgeS2', diff2);
    }

    async function saveAndNext() {
        const btn = document.getElementById('btnSave'); btn.innerHTML = '‚è≥ Menyimpan...'; btn.disabled = true;

        const payload = {
            user_id: user.id, doc_type: 'allocation_data',
            subject_name: profile.mata_pelajaran || 'Umum', grade_level: profile.fase_kelas || 'Umum', curriculum_type: profile.jenis_kurikulum || 'Merdeka',
            content_data: window.allocationData, 
            status: 'draft'
        };

        const { data: existProta } = await db.from('work_drafts').select('*').eq('user_id', user.id).eq('doc_type', 'prota_data').maybeSingle();
        let protaPayload = existProta ? existProta : { user_id: user.id, doc_type: 'prota_data', content_data: {} };
        protaPayload.content_data.p5_settings = window.allocationData.p5_settings;
        
        await db.from('work_drafts').upsert(protaPayload, { onConflict: 'user_id,doc_type' });
        const { error } = await db.from('work_drafts').upsert(payload, { onConflict: 'user_id,doc_type' });
        
        if (error) { Swal.fire('Gagal', error.message, 'error'); btn.innerHTML = '<span>üíæ</span> Simpan & Lanjut (Prota) ‚Üí'; btn.disabled = false; }
        else { 
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: 'RPE Tersimpan'});
            setTimeout(() => window.location.href = 'step5_prota.html', 1000);
        }
    }
</script>
</body>
</html>